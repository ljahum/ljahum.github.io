<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>垃圾题归档 &middot; #cd /home</title>
  <meta name="title" content="垃圾题归档 &middot; #cd /home" />
  
  <meta name="description" content="bin isn&#39;t bin" />
  <meta name="keywords" content="crypto, " />
  
  
  <link rel="canonical" href="https://ljahum258.github.io/achieve/%E5%9E%83%E5%9C%BE%E9%A2%98%E5%BD%92%E6%A1%A3/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.8d8ef9f406ae76aa0753f63221ea827aba6a09e5f22e065eb881e526880c7ba14c4c2c42e95cfee0b865d249aa0330266c5f7f926ce6e6218640879361dc8179.css"
    integrity="sha512-jY759AaudqoHU/YyIeqCerpqCeXyLgZeuIHlJogMe6FMTCxC6Vz&#43;4Lhl0kmqAzAmbF9/kmzm5iGGQIeTYdyBeQ==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.34dfb4e6b05b47b0a3599f50035f9bbb18c2d36a26aa4c0ea7acc4936489d4c2a55f65683d53e3c4215337e6a8c02e554881af2da86b5783c96837ae3d4e98f6.js"
    integrity="sha512-NN&#43;05rBbR7CjWZ9QA1&#43;buxjC02omqkwOp6zEk2SJ1MKlX2VoPVPjxCFTN&#43;aowC5VSIGvLahrV4PJaDeuPU6Y9g==" data-copy="" data-copied=""></script>
  
  <script src="/js/zoom.min.js"></script>
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="垃圾题归档" />
<meta property="og:description" content="bin isn&#39;t bin" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ljahum258.github.io/achieve/%E5%9E%83%E5%9C%BE%E9%A2%98%E5%BD%92%E6%A1%A3/" /><meta property="article:section" content="achieve" />
<meta property="article:published_time" content="2021-07-31T00:07:00+08:00" />
<meta property="article:modified_time" content="2021-07-31T00:07:00+08:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="垃圾题归档"/>
<meta name="twitter:description" content="bin isn&#39;t bin"/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "archive",
    "name": "垃圾题归档",
    "headline": "垃圾题归档",
    "description": "bin isn\u0027t bin",
    
    "inLanguage": "en",
    "url" : "https:\/\/ljahum258.github.io\/achieve\/%E5%9E%83%E5%9C%BE%E9%A2%98%E5%BD%92%E6%A1%A3\/",
    "author" : {
      "@type": "Person",
      "name": "ベーコン"
    },
    "copyrightYear": "2021",
    "dateCreated": "2021-07-31T00:07:00\u002b08:00",
    "datePublished": "2021-07-31T00:07:00\u002b08:00",
    
    "dateModified": "2021-07-31T00:07:00\u002b08:00",
    
    "keywords": ["crypto"],
    
    "mainEntityOfPage": "true",
    "wordCount": "13124"
  }]
  </script>


  
  
  <meta name="author" content="ベーコン" />
  
  
  
  <link href="https://github.com/ljahum" rel="me" />
  
  
  <link href="https://www.pinterest.jp/roomoflja/" rel="me" />
  
  
  <link href="mailto:roomoflja@gmail.com" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.js" integrity=""></script>


















  
  

  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">#cd /home</a>


        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/articles/"  class="flex items-center">
    
    <p class="text-base font-medium text-gray-500 hover:text-gray-900" title="Projects">
        Draft
    </p>
</a>


            
            
  <a href="/about/"  class="flex items-center">
    
    <p class="text-base font-medium text-gray-500 hover:text-gray-900" title="About">
        About
    </p>
</a>


            
             
  <div>
  <div class="cursor-pointer flex items-center nested-menu">
    
    <a  href="/achieve/"   class="text-base font-medium text-gray-500 hover:text-gray-900" title="archive">
      Archive
    </a>
    <span>
      

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        
        <a href="/categories/"  class="flex items-center">
          
          <p class="text-sm font-sm text-gray-500 hover:text-gray-900" title="Categories">
            Categories
          </p>
        </a>
        
        <a href="/tags/"  class="flex items-center">
          
          <p class="text-sm font-sm text-gray-500 hover:text-gray-900" title="Tags">
            Tags
          </p>
        </a>
        
        <a href="https://ljahum.notion.site/Bass-Ment-073326638a86449c9a06d6467fed470f?pvs=4" 
          target="_blank"  class="flex items-center">
          
          <p class="text-sm font-sm text-gray-500 hover:text-gray-900" title="">
            Notion
          </p>
        </a>
        
      </div>
    </div>
  </div>
</div>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button">
                    <div class="flex items-center justify-center h-12 dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden h-12 dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" style="margin-right:5px">
                <div class="flex items-center justify-center h-12 dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden h-12 dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" for="menu-controller" class="block">
            <input type="checkbox" id="menu-controller" class="hidden" />
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li>
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    
                    

                    
  <li class="mt-1">
    <a href="/articles/"  class="flex items-center">
        
        <p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="Projects">
            Draft
        </p>
    </a>
</li>



                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center">
        
        <p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="About">
            About
        </p>
    </a>
</li>



                    

                     
  <li class="mt-1">
    <a class="flex items-center">
        
        <p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="archive">
            Archive
        </p>
        <span>
            

  <span class="relative block icon">
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 20 20"
  fill="currentColor"
  aria-hidden="true"
>
  <path
    fill-rule="evenodd"
    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
    clip-rule="evenodd"
  />
</svg>

  </span>


        </span>
    </a>
</li>

<li class="mt-1">
    <a href="/categories/"  class="flex items-center">
        
        <p class="text-sm font-small text-gray-500 hover:text-gray-900" title="Categories">
            Categories
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="/tags/"  class="flex items-center">
        
        <p class="text-sm font-small text-gray-500 hover:text-gray-900" title="Tags">
            Tags
        </p>
    </a>
</li>

<li class="mt-1">
    <a href="https://ljahum.notion.site/Bass-Ment-073326638a86449c9a06d6467fed470f?pvs=4"  target="_blank"  class="flex items-center">
        
        <p class="text-sm font-small text-gray-500 hover:text-gray-900" title="">
            Notion
        </p>
    </a>
</li>

<li class="mb-2"></li>



                    
                    

                </ul>
                

            </div>
        </label>
    </div>
</div>





  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>


    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/img/background.jpg);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      垃圾题归档
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      




































<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2021-07-31 00:07:00 &#43;0800 CST">31 July 2021</time><span class="px-2 text-primary-500">&middot;</span><span>13124 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">62 mins</span>
  

  
  
  <span class="pl-2"><span class="flex">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400"
  >
    Draft
  </span>
</span>
</span>
  
</div>







    </div>

    
    
    
    
    

    

    

    

    
  
  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first sm:max-w-prose lg:ml-auto px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#2021年中国能源网络安全大赛">2021年中国能源网络安全大赛</a>
      <ul>
        <li><a href="#numbergame">NumberGame</a></li>
        <li><a href="#filltheblank">FillTheBlank</a></li>
      </ul>
    </li>
    <li><a href="#gkctfxdasctf应急挑战杯">GKCTFxDASCTF应急挑战杯</a>
      <ul>
        <li><a href="#random">Random</a></li>
        <li><a href="#rsa">RSA</a></li>
      </ul>
    </li>
    <li><a href="#红明谷杯数据安全大赛技能场景赛">红明谷杯数据安全大赛技能场景赛</a>
      <ul>
        <li><a href="#ezcrt">ezCRT</a></li>
        <li><a href="#crypto_system">Crypto_System</a></li>
      </ul>
    </li>
    <li><a href="#roarctf2020">ROARCTF2020</a>
      <ul>
        <li><a href="#reverse">Reverse</a></li>
        <li><a href="#ecdsa">ECDSA</a></li>
      </ul>
    </li>
    <li><a href="#bytectf">ByteCTF</a>
      <ul>
        <li><a href="#noise">noise</a>
          <ul>
            <li><a href="#解题流程">解题流程：</a></li>
          </ul>
        </li>
        <li><a href="#threshold">threshold</a>
          <ul>
            <li><a href="#解题流程-1">解题流程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#x-nuca">X-NUCA</a>
      <ul>
        <li><a href="#weird">weird</a>
          <ul>
            <li><a href="#解题流程-2">解题流程</a></li>
          </ul>
        </li>
        <li><a href="#imposter">imposter</a>
          <ul>
            <li><a href="#解题流程-3">解题流程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#2021-antctf-x-d3ctf">2021 AntCTF x D^3CTF</a>
      <ul>
        <li><a href="#babylattice">babyLattice</a>
          <ul>
            <li><a href="#题目分析">题目分析</a></li>
            <li><a href="#exp">EXP</a></li>
          </ul>
        </li>
        <li><a href="#simplegroup">simpleGroup</a>
          <ul>
            <li><a href="#题目分析-1">题目分析</a></li>
            <li><a href="#exp-1">EXP</a></li>
          </ul>
        </li>
        <li><a href="#easycurve">EasyCurve</a>
          <ul>
            <li><a href="#题目分析-2">题目分析</a></li>
            <li><a href="#exp-2">EXP</a></li>
          </ul>
        </li>
        <li><a href="#alicewantflag">AliceWantFlag</a>
          <ul>
            <li><a href="#题目分析-3">题目分析</a></li>
            <li><a href="#exp-3">EXP</a></li>
          </ul>
        </li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
    <li><a href="#莲城杯-经典随机数yusa的密码学课堂mt19937">莲城杯 经典随机数Yusa的密码学课堂——MT19937</a></li>
    <li><a href="#美团">美团</a>
      <ul>
        <li><a href="#easy_rsa">easy_RSA</a></li>
      </ul>
    </li>
    <li><a href="#mardasctf">Mar.DASCTF</a>
      <ul>
        <li><a href="#threshold-1">threshold</a></li>
        <li><a href="#son_of_ntru">son_of_NTRU</a></li>
      </ul>
    </li>
    <li><a href="#xctf华为云专题赛-官方writeup">XCTF华为云专题赛 官方Writeup</a></li>
    <li><a href="#太湖杯">太湖杯</a></li>
    <li><a href="#aegis">Aegis</a>
      <ul>
        <li><a href="#算法简介">算法简介</a></li>
        <li><a href="#aegis128的算法">Aegis128的算法</a>
          <ul>
            <li><a href="#状态更新-statusupdate">状态更新 StatusUpdate</a></li>
            <li><a href="#初始化过程">初始化过程</a></li>
          </ul>
        </li>
        <li><a href="#aegis-中的aes">Aegis 中的AES</a></li>
        <li><a href="#aegis的加密过程">Aegis的加密过程</a></li>
        <li><a href="#ageis的漏洞点">Ageis的漏洞点</a>
          <ul>
            <li><a href="#第一步泄露">第一步泄露</a></li>
            <li><a href="#进一步泄露">进一步泄露</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第五空间2020-有几个脚本可以偷">第五空间2020 有几个脚本可以偷</a>
      <ul>
        <li><a href="#secrets">secrets</a></li>
        <li><a href="#data_protect">data_protect</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>
<details class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#2021年中国能源网络安全大赛">2021年中国能源网络安全大赛</a>
      <ul>
        <li><a href="#numbergame">NumberGame</a></li>
        <li><a href="#filltheblank">FillTheBlank</a></li>
      </ul>
    </li>
    <li><a href="#gkctfxdasctf应急挑战杯">GKCTFxDASCTF应急挑战杯</a>
      <ul>
        <li><a href="#random">Random</a></li>
        <li><a href="#rsa">RSA</a></li>
      </ul>
    </li>
    <li><a href="#红明谷杯数据安全大赛技能场景赛">红明谷杯数据安全大赛技能场景赛</a>
      <ul>
        <li><a href="#ezcrt">ezCRT</a></li>
        <li><a href="#crypto_system">Crypto_System</a></li>
      </ul>
    </li>
    <li><a href="#roarctf2020">ROARCTF2020</a>
      <ul>
        <li><a href="#reverse">Reverse</a></li>
        <li><a href="#ecdsa">ECDSA</a></li>
      </ul>
    </li>
    <li><a href="#bytectf">ByteCTF</a>
      <ul>
        <li><a href="#noise">noise</a>
          <ul>
            <li><a href="#解题流程">解题流程：</a></li>
          </ul>
        </li>
        <li><a href="#threshold">threshold</a>
          <ul>
            <li><a href="#解题流程-1">解题流程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#x-nuca">X-NUCA</a>
      <ul>
        <li><a href="#weird">weird</a>
          <ul>
            <li><a href="#解题流程-2">解题流程</a></li>
          </ul>
        </li>
        <li><a href="#imposter">imposter</a>
          <ul>
            <li><a href="#解题流程-3">解题流程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#2021-antctf-x-d3ctf">2021 AntCTF x D^3CTF</a>
      <ul>
        <li><a href="#babylattice">babyLattice</a>
          <ul>
            <li><a href="#题目分析">题目分析</a></li>
            <li><a href="#exp">EXP</a></li>
          </ul>
        </li>
        <li><a href="#simplegroup">simpleGroup</a>
          <ul>
            <li><a href="#题目分析-1">题目分析</a></li>
            <li><a href="#exp-1">EXP</a></li>
          </ul>
        </li>
        <li><a href="#easycurve">EasyCurve</a>
          <ul>
            <li><a href="#题目分析-2">题目分析</a></li>
            <li><a href="#exp-2">EXP</a></li>
          </ul>
        </li>
        <li><a href="#alicewantflag">AliceWantFlag</a>
          <ul>
            <li><a href="#题目分析-3">题目分析</a></li>
            <li><a href="#exp-3">EXP</a></li>
          </ul>
        </li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
    <li><a href="#莲城杯-经典随机数yusa的密码学课堂mt19937">莲城杯 经典随机数Yusa的密码学课堂——MT19937</a></li>
    <li><a href="#美团">美团</a>
      <ul>
        <li><a href="#easy_rsa">easy_RSA</a></li>
      </ul>
    </li>
    <li><a href="#mardasctf">Mar.DASCTF</a>
      <ul>
        <li><a href="#threshold-1">threshold</a></li>
        <li><a href="#son_of_ntru">son_of_NTRU</a></li>
      </ul>
    </li>
    <li><a href="#xctf华为云专题赛-官方writeup">XCTF华为云专题赛 官方Writeup</a></li>
    <li><a href="#太湖杯">太湖杯</a></li>
    <li><a href="#aegis">Aegis</a>
      <ul>
        <li><a href="#算法简介">算法简介</a></li>
        <li><a href="#aegis128的算法">Aegis128的算法</a>
          <ul>
            <li><a href="#状态更新-statusupdate">状态更新 StatusUpdate</a></li>
            <li><a href="#初始化过程">初始化过程</a></li>
          </ul>
        </li>
        <li><a href="#aegis-中的aes">Aegis 中的AES</a></li>
        <li><a href="#aegis的加密过程">Aegis的加密过程</a></li>
        <li><a href="#ageis的漏洞点">Ageis的漏洞点</a>
          <ul>
            <li><a href="#第一步泄露">第一步泄露</a></li>
            <li><a href="#进一步泄露">进一步泄露</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#第五空间2020-有几个脚本可以偷">第五空间2020 有几个脚本可以偷</a>
      <ul>
        <li><a href="#secrets">secrets</a></li>
        <li><a href="#data_protect">data_protect</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>

   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="max-w-prose mb-20">
          <blockquote>
<p>Refer:Intnet</p>
</blockquote>
<div id="2021年中国能源网络安全大赛" class="anchor"></div>
<h2 class="relative group">2021年中国能源网络安全大赛 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#2021%e5%b9%b4%e4%b8%ad%e5%9b%bd%e8%83%bd%e6%ba%90%e7%bd%91%e7%bb%9c%e5%ae%89%e5%85%a8%e5%a4%a7%e8%b5%9b" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="numbergame" class="anchor"></div>
<h3 class="relative group">NumberGame 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#numbergame" aria-label="Anchor">#</a></span>        
    
</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">e</span><span class="o">=</span><span class="mi">65537</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mi">15743369066365201538689815141217340316571238013087670610561037355773525976258683589473338312326667266426637983360891507450086948913791067841805124377899989037485326133436719169246977060981737084689604571176180431464103979969894191079926052092838806338413905561857239072404009236751128582547515118141940600672935405990869984053032765764114050729270669601890847900632843688927485888918612911073502700067125045327489296133801029104137634700096205588495179191062622618039322093662364377472003903899926787818853067801269953347284657645644433840226628368651915623156258190141632506503179281547840336415021260912890513317032</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span><span class="o">=</span><span class="mi">13751833349374257546209411135285092025488474108950873335024549274321086737456294175321120539754112475192176856842163702158437261396059826784892899176923534179915888282864428402789707026830116675021571701648882970445289856088711084812757925707567230381940631064097247655097898810731114605714274641284534967275121251913986394408892187726203752249533094374744765243723455319272657285557501695073422223837888223589541537218910163081228251946239816318853757555291276404517545168694257378212616960758914005374587905274292014917325205163653897110709086078591016724234778570715311198272084303656971117931256882498414761066763</span>
</span></span><span class="line"><span class="cl"><span class="n">invert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">)</span><span class="o">=</span><span class="mi">63567214271914333094632899333841375147292062018298573854142802911053572390920700513290025348818998146731407276513819782906243535938082361025317768375133584131695102997533625569063205757115454077033715745425720243515047860316309615090852448819151555625882308478246810599114349379924606314715907857949899701531</span>
</span></span><span class="line"><span class="cl"><span class="n">invert</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">=</span><span class="mi">61854206698188431209560015384356189028981002413118973294450748821388080621667741484068895416821294105003859720045449073339567340407545907381482535347338180766054184558875014806879520058753821268699806496142714025634827191809185242495912563928024605815219672974396270176683304596115075405856328836048144151507</span>
</span></span></code></pre></div><p>给出 $(p-1)(q-1),x=\text{inv}(p,q),y=\text{inv}(q,p),e,c$。</p>
<p>详细推导思路可参考 <a href="https://github.com/pcw109550/write-up/tree/master/2019/HITCON/Lost_Modulus_Again"   target="_blank">
    HITCON 2019 - Lost Modulus Again</a>。</p>
<p>解题脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">gmpy2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">alpha = p&#39; * q&#39; - l
</span></span></span><span class="line"><span class="cl"><span class="s2">beta = l^2 * [(e * d - 1) / s] + q&#39; * l + p&#39; * l - p&#39; * q&#39; - alpha - l^2
</span></span></span><span class="line"><span class="cl"><span class="s2">i.e.:
</span></span></span><span class="line"><span class="cl"><span class="s2">beta = l^2 * {[(e * d - 1) / s] - 1} + l * (q&#39; + p&#39;) - alpha - p&#39; * q&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">if l,s are correct:
</span></span></span><span class="line"><span class="cl"><span class="s2">    alpha = k * t
</span></span></span><span class="line"><span class="cl"><span class="s2">    beta = k * (p&#39; - l) + t * (q&#39; - l)
</span></span></span><span class="line"><span class="cl"><span class="s2">i.e:
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">alpha_from_pprime_qprime_l</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pprime</span><span class="o">*</span><span class="n">qprime</span> <span class="o">-</span> <span class="n">l</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">beta_from_pprime_qprime_e_d_l_s_alpha</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp1</span> <span class="o">=</span> <span class="n">e</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">temp1</span> <span class="o">%</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp2</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp1</span> <span class="o">//</span> <span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="n">l</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp3</span> <span class="o">=</span> <span class="n">temp2</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">pprime</span> <span class="o">+</span> <span class="n">qprime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">temp3</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">-</span> <span class="p">(</span><span class="n">pprime</span><span class="o">*</span><span class="n">qprime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">k_t_from_pprime_qprime_l_alpha_beta</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">pprime</span> <span class="o">-</span> <span class="n">l</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">qprime</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">disc</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">is_square</span><span class="p">(</span><span class="n">disc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">isqrt</span><span class="p">(</span><span class="n">disc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">temp</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">k</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">alpha</span> <span class="o">%</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">//</span> <span class="n">k</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">brute_k_t_l</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">   <span class="c1"># l, s = 2, 2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ss</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1000000</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">ss</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#print(f&#39;l = {l}, s = {s}&#39;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_from_pprime_qprime_l</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">beta</span> <span class="o">=</span> <span class="n">beta_from_pprime_qprime_e_d_l_s_alpha</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">k_t_from_pprime_qprime_l_alpha_beta</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="mi">65537</span>
</span></span><span class="line"><span class="cl">    <span class="n">fn</span> <span class="o">=</span> <span class="mi">15743369066365201538689815141217340316571238013087670610561037355773525976258683589473338312326667266426637983360891507450086948913791067841805124377899989037485326133436719169246977060981737084689604571176180431464103979969894191079926052092838806338413905561857239072404009236751128582547515118141940600672935405990869984053032765764114050729270669601890847900632843688927485888918612911073502700067125045327489296133801029104137634700096205588495179191062622618039322093662364377472003903899926787818853067801269953347284657645644433840226628368651915623156258190141632506503179281547840336415021260912890513317032</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pprime</span> <span class="o">=</span> <span class="mi">63567214271914333094632899333841375147292062018298573854142802911053572390920700513290025348818998146731407276513819782906243535938082361025317768375133584131695102997533625569063205757115454077033715745425720243515047860316309615090852448819151555625882308478246810599114349379924606314715907857949899701531</span>
</span></span><span class="line"><span class="cl">    <span class="n">qprime</span> <span class="o">=</span> <span class="mi">61854206698188431209560015384356189028981002413118973294450748821388080621667741484068895416821294105003859720045449073339567340407545907381482535347338180766054184558875014806879520058753821268699806496142714025634827191809185242495912563928024605815219672974396270176683304596115075405856328836048144151507</span>
</span></span><span class="line"><span class="cl">    <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">brute_k_t_l</span><span class="p">(</span><span class="n">pprime</span><span class="p">,</span> <span class="n">qprime</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">lp</span><span class="p">,</span> <span class="n">lq</span> <span class="o">=</span> <span class="n">qprime</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">pprime</span> <span class="o">+</span> <span class="n">t</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">lp</span> <span class="o">%</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lq</span> <span class="o">%</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">lp</span> <span class="o">//</span> <span class="n">l</span><span class="p">,</span> <span class="n">lq</span> <span class="o">//</span> <span class="n">l</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">pprime</span><span class="p">,</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">qprime</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">is_prime</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">is_prime</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="mi">13751833349374257546209411135285092025488474108950873335024549274321086737456294175321120539754112475192176856842163702158437261396059826784892899176923534179915888282864428402789707026830116675021571701648882970445289856088711084812757925707567230381940631064097247655097898810731114605714274641284534967275121251913986394408892187726203752249533094374744765243723455319272657285557501695073422223837888223589541537218910163081228251946239816318853757555291276404517545168694257378212616960758914005374587905274292014917325205163653897110709086078591016724234778570715311198272084303656971117931256882498414761066763</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag_decoded</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">flag_decoded</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">#b&#39;flag{dP_4nd_dQ_1s_4_exc1tlng_pr0bLEm}&#39;</span>
</span></span></code></pre></div><div id="filltheblank" class="anchor"></div>
<h3 class="relative group">FillTheBlank 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#filltheblank" aria-label="Anchor">#</a></span>        
    
</h3>
<blockquote>
<p>推公式？</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">gmpy2</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">math</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="mi">16358502146569154805821117102055792126075384391997576813810358118942744612520734385485210209088310766263140599554175000067735671573064419087690267925715334913530155481001158890983091873663077846204509925514040559562873128373049378251801304882824014436351821387973582562165652240535121822439156888350175610414618000437008389187928342072924670546637964062394868004556705496699646429981923137500855492623070913023804420063661041841121617920375160117028363526191248710373415720637387593795136212298387121644166224488964182846517612830649792045421886212347661276446680662471149305906153415890365792363053111611744767732723</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="s2">&#34;**********&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="mi">1004034638166310792730607806775703553124564601554345421260673</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span><span class="o">=</span><span class="s2">&#34;flag{*************}&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span> <span class="s2">&#34;**********&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rb</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1">#p应为a</span>
</span></span><span class="line"><span class="cl"><span class="n">rd</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1">#p应为a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">rb</span><span class="o">*</span><span class="n">rd</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">rb</span> <span class="o">*</span> <span class="n">d</span> <span class="o">%</span> <span class="n">a</span><span class="p">)</span><span class="o">%</span><span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="mi">6315659043002030386732628047413448608037014021450055783529151485037069834363316696715574624507364755209361330204858147422873261866250183596759294051863367248800298182067900158706847792801508096127972864438349393635089442050383307416911012903769591812354414290225858817653700560363386018244490076357373032578412217266586094695255045411910123500620718125148007865650934761243821251725823364164494857358344030633984045814182753879152597382860304163779884435644346012876829684180445183686922253767338719485395107909704323571278192414797079570675523716981179479127876875936828316228191746093521584500893126198631718691478</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">13596888613593355909989922489890598098147006404940300566769884949973269155719149670825677093684865700611084990815597885910353735947129944271345041538903031681298587672182524580124290627382140539264797169742520543929318842181890234622629255911624719400312152476306595541663238469772749767491911131691767357337344670678126067823905376191196367985379783363614691429132347967869598160549130755596368301366502209859435570988428790501722994265227987470237460083210385323943246674820772425514186206511159274330451656105100385024137631498256411854720506611702496670593426888793357086314109878603547497784715623917384308274129</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1024</span><span class="p">)</span>
</span></span></code></pre></div><p>推导：</p>
<p>由 $rb \equiv b^{-1} \pmod a$ 和 $rd \equiv d^{-1} \pmod a$ ，有 $rb \cdot b \cdot rd \cdot d = x \cdot b \cdot d \equiv 1 \pmod a$。</p>
<p>故求出 $b \equiv (x \cdot d)^{-1} \pmod a$，$rb \equiv b^{-1} \pmod a$。</p>
<p>又 $c = (m+z \cdot rb \cdot d) \bmod a$，构造格 $L=\begin{bmatrix} 1 &amp; rb \cdot d \ 0 &amp; a \end{bmatrix}$，利用LLL算法求解：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="mi">16358502146569154805821117102055792126075384391997576813810358118942744612520734385485210209088310766263140599554175000067735671573064419087690267925715334913530155481001158890983091873663077846204509925514040559562873128373049378251801304882824014436351821387973582562165652240535121822439156888350175610414618000437008389187928342072924670546637964062394868004556705496699646429981923137500855492623070913023804420063661041841121617920375160117028363526191248710373415720637387593795136212298387121644166224488964182846517612830649792045421886212347661276446680662471149305906153415890365792363053111611744767732723</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="mi">1004034638166310792730607806775703553124564601554345421260673</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="mi">6315659043002030386732628047413448608037014021450055783529151485037069834363316696715574624507364755209361330204858147422873261866250183596759294051863367248800298182067900158706847792801508096127972864438349393635089442050383307416911012903769591812354414290225858817653700560363386018244490076357373032578412217266586094695255045411910123500620718125148007865650934761243821251725823364164494857358344030633984045814182753879152597382860304163779884435644346012876829684180445183686922253767338719485395107909704323571278192414797079570675523716981179479127876875936828316228191746093521584500893126198631718691478</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="mi">13596888613593355909989922489890598098147006404940300566769884949973269155719149670825677093684865700611084990815597885910353735947129944271345041538903031681298587672182524580124290627382140539264797169742520543929318842181890234622629255911624719400312152476306595541663238469772749767491911131691767357337344670678126067823905376191196367985379783363614691429132347967869598160549130755596368301366502209859435570988428790501722994265227987470237460083210385323943246674820772425514186206511159274330451656105100385024137631498256411854720506611702496670593426888793357086314109878603547497784715623917384308274129</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">gmpy2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rb</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rd</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="n">rb</span><span class="o">*</span><span class="n">d</span><span class="o">%</span><span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">v1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">v2</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">LLL</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="c1">#print(f, g)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">c</span> <span class="o">%</span> <span class="n">p</span> <span class="o">%</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#b&#39;flag{we1c0mE_t0_cr4aK_mE!}&#39;</span>
</span></span></code></pre></div><div id="gkctfxdasctf应急挑战杯" class="anchor"></div>
<h2 class="relative group">GKCTFxDASCTF应急挑战杯 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#gkctfxdasctf%e5%ba%94%e6%80%a5%e6%8c%91%e6%88%98%e6%9d%af" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="random" class="anchor"></div>
<h3 class="relative group">Random 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#random" aria-label="Anchor">#</a></span>        
    
</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_mask</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;random.txt&#34;</span><span class="p">,</span><span class="s2">&#34;w&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">104</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">96</span><span class="p">))</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">get_mask</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><p>根据 <code>random.txt</code> 中104组 <code>random.getrandbits()</code> 函数输出值，利用预测工具 <a href="https://github.com/kmyk/mersenne-twister-predictor"   target="_blank">
    Mersenne Twister Predictor</a> 来求出下一个随机数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">mt19937predictor</span> <span class="kn">import</span> <span class="n">MT19937Predictor</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">predictor</span> <span class="o">=</span> <span class="n">MT19937Predictor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;random.txt&#34;</span><span class="p">,</span><span class="s2">&#34;r&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">c1</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">c2</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">c3</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="p">),</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">c1</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
</span></span><span class="line"><span class="cl">	<span class="n">c2</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
</span></span><span class="line"><span class="cl">	<span class="n">c3</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">104</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">predictor</span><span class="o">.</span><span class="n">setrandbits</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">predictor</span><span class="o">.</span><span class="n">setrandbits</span><span class="p">(</span><span class="n">c2</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">predictor</span><span class="o">.</span><span class="n">setrandbits</span><span class="p">(</span><span class="n">c3</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">96</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="c1">#14c71fec812b754b2061a35a4f6d8421</span>
</span></span></code></pre></div><div id="rsa" class="anchor"></div>
<h3 class="relative group">RSA 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#rsa" aria-label="Anchor">#</a></span>        
    
</h3>
<blockquote>
<p>Just RSA!</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">nextprime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">gmpy2</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encode</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">e</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">not_hint</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">not_hint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">not_p</span> <span class="o">=</span> <span class="n">S</span><span class="o">%</span><span class="p">(</span><span class="n">p1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">not_p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;Neepu{********************}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">nextprime</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">c1</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">c2</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="n">e</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;78543767285872349029076059073458316000847341792088805258173041942425687239313215276670106926320359777962661495032475004417723103701253550583245518206305422982968675291500865382213182669036827898932991063338163290845510339896689210314509493839746410486257998875782496654704288722251878269643040214139429715671&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;91995272927105081122659192011056020468305570748555849650309966887236871318156855318666540461669669247866754568189179687694315627673545298267458869140096224628114424176937828378360997230874932015701507629238213240839370628366083111028544554453150572165461450371411341485911677167168492357154684642531577228543&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;10186066785511829759164194803209819172224966119227668638413350199662683285189286077736537161204019147791799351066849945954518642600518196927152098131117402608793752080104402893792812059620726950782670809837962606250674588612783027976958719051829085903720655233948024280118985875980227528403883475592567727892&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;46182103994299145562022812023438495797686077104477472631494150222038404419414100727667171290098624214113241032861128455086601197239761085752413519627251290509474327611253599768650908336142621210005389246714504358370629231557080301516460985022782887233790302054696967900384601182742759555421864610431428746119&#39;</span>
</span></span></code></pre></div><p>两部分：</p>
<p>第一部分 $n=pq,c=\text{flag}^e \bmod n$，</p>
<p>第二部分 $m=\text{enc}(p,q,e),c_1=m^7 \bmod n,c_2=(m+e)^7 \bmod n$。</p>
<p>先解第二部分，利用Related Message Attack求解 $m$，由于 $e$ 未知且 $e&lt;1010$，爆破 $e$ 求出 $m$：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">PR</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">g1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="mi">7</span> <span class="o">-</span> <span class="n">c1</span>
</span></span><span class="line"><span class="cl">    <span class="n">g2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">e</span><span class="p">)</span><span class="o">^</span><span class="mi">7</span> <span class="o">-</span> <span class="n">c2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">g2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">g2</span><span class="p">,</span> <span class="n">g1</span> <span class="o">%</span> <span class="n">g2</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">g1</span><span class="o">.</span><span class="n">monic</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">gcd</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">c1</span> <span class="o">=</span> <span class="mi">10186066785511829759164194803209819172224966119227668638413350199662683285189286077736537161204019147791799351066849945954518642600518196927152098131117402608793752080104402893792812059620726950782670809837962606250674588612783027976958719051829085903720655233948024280118985875980227528403883475592567727892</span>
</span></span><span class="line"><span class="cl"><span class="n">c2</span> <span class="o">=</span> <span class="mi">46182103994299145562022812023438495797686077104477472631494150222038404419414100727667171290098624214113241032861128455086601197239761085752413519627251290509474327611253599768650908336142621210005389246714504358370629231557080301516460985022782887233790302054696967900384601182742759555421864610431428746119</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">91995272927105081122659192011056020468305570748555849650309966887236871318156855318666540461669669247866754568189179687694315627673545298267458869140096224628114424176937828378360997230874932015701507629238213240839370628366083111028544554453150572165461450371411341485911677167168492357154684642531577228543</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">attack</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">pow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="n">c1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">((</span><span class="n">e</span><span class="p">,</span><span class="n">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl"><span class="c1">#结果：(71, 129256555243625096140386916253259867206651269142565502540823654159666398099455456877012993395632742360829588042575108302297567291349420390228163587340859)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#e = 71</span>
</span></span><span class="line"><span class="cl"><span class="c1">#m = 129256555243625096140386916253259867206651269142565502540823654159666398099455456877012993395632742360829588042575108302297567291349420390228163587340859</span>
</span></span></code></pre></div><p>又 $m=\text{enc}(p,q,e)$，即 $eS=ed \equiv 1 \pmod {(p+1)(q+1)},dp=S \bmod (p+1)=d \bmod (p+1)$，</p>
<p>由于 $e \cdot dp \equiv e \cdot d \equiv 1 \pmod {(p+1)}$，有 $e \cdot dp-1=k \cdot (p+1)$，</p>
<p>比较 $e \cdot dp$ 与 $p$ 比特位数相近，故 $k$ 值不大，</p>
<p>爆破 $k$，当同时满足 $(e \cdot dp-1) \bmod k =0$ 和 $n \bmod \Big(\cfrac{e \cdot dp-1}{k}-1\Big)$ 时，$n$ 成功分解。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">91995272927105081122659192011056020468305570748555849650309966887236871318156855318666540461669669247866754568189179687694315627673545298267458869140096224628114424176937828378360997230874932015701507629238213240839370628366083111028544554453150572165461450371411341485911677167168492357154684642531577228543</span>
</span></span><span class="line"><span class="cl"><span class="n">dp</span> <span class="o">=</span> <span class="mi">129256555243625096140386916253259867206651269142565502540823654159666398099455456877012993395632742360829588042575108302297567291349420390228163587340859</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="mi">71</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="mi">78543767285872349029076059073458316000847341792088805258173041942425687239313215276670106926320359777962661495032475004417723103701253550583245518206305422982968675291500865382213182669036827898932991063338163290845510339896689210314509493839746410486257998875782496654704288722251878269643040214139429715671</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">dp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">dp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">n</span><span class="o">%</span><span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">q</span> <span class="o">=</span> <span class="n">n</span><span class="o">//</span><span class="n">p</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
</span></span></code></pre></div><p>最后常规RSA求得flag。</p>
<div id="红明谷杯数据安全大赛技能场景赛" class="anchor"></div>
<h2 class="relative group">红明谷杯数据安全大赛技能场景赛 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e7%ba%a2%e6%98%8e%e8%b0%b7%e6%9d%af%e6%95%b0%e6%8d%ae%e5%ae%89%e5%85%a8%e5%a4%a7%e8%b5%9b%e6%8a%80%e8%83%bd%e5%9c%ba%e6%99%af%e8%b5%9b" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="ezcrt" class="anchor"></div>
<h3 class="relative group">ezCRT 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ezcrt" aria-label="Anchor">#</a></span>        
    
</h3>
<blockquote>
<p>Chinese Remainder Theorem is fantastic</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">gmpy2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;flag is here&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shuffle_flag</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">str_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">shuffle</span><span class="p">(</span><span class="n">str_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">nl</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">el</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">next_prime</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">nl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">nl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cl</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">shuffle_flag</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nl</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">el</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
</span></span></code></pre></div></blockquote>
<p>五组 $n,e$，共私钥 $d$，用LLL算法打。发现 $n$ 都已帮从小到大排好序，一步到位。</p>
<p>由于 <code>d = gmpy2.next_prime(bytes_to_long(flag))</code>，求出 $d$ 后往回遍历拿到flag。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#Sage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gmpy2</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">M</span><span class="o">=</span><span class="n">iroot</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Mat</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Mat_LLL</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">.</span><span class="n">LLL</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Mat_LLL</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="n">M</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1500</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">k</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]))</span>
</span></span></code></pre></div><div id="crypto_system" class="anchor"></div>
<h3 class="relative group">Crypto_System 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#crypto_system" aria-label="Anchor">#</a></span>        
    
</h3>
<p>从[CyBRICS 2020 - Too Secure](<a href="http://ctfteam.com/writeup/8/Too"   target="_blank">
    http://ctfteam.com/writeup/8/Too</a> Secure)魔改的Pedersen加密，算法描述：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://raw.githubusercontent.com/ljahum/images/main/img/20211121203642.png" alt="" />
    
  </figure>

</p>
<p>已知信息 $m_1,m_2$和 $m_1$ 的 $r_1$，$m_1$ 通过因子 $r_1$ 加密得到 $c_1$，需要求出因子 $r_2$，使得 $m_2$ 通过 $r_2$ 加密得到的 $c_2$ 与 $c_1$ 相同，即产生碰撞。</p>
<p>对于待加密信息 $m_1$，$c_1=g^{m_1}h_1^{r_1}$，注意到 $h_1=g^{a_1}$，故 $c_1=g^{m_1+a_1r_1}$；</p>
<p>要碰撞信息 $m_2$ 的因子 $r_2$ 应满足 $c_2=c_1$，即 $m_1+a_1r_1 \equiv m_2+a_2r_2 \pmod {\varphi(p)}$，</p>
<p>又 $q$ 为 $g$ 的阶，所以有 $m_1+a_1r_1 \equiv m_2+a_2r_2 \pmod q$，</p>
<p>故 $r_2 \equiv (m_1+a_1r_1-m_2) \pmod q$，即可求出 $r_2$。</p>
<p>Exp：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#python2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwnlib.util.iters</span> <span class="kn">import</span> <span class="n">bruteforce</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gmpy2</span> <span class="kn">import</span> <span class="n">gcd</span><span class="p">,</span><span class="n">invert</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">brute_force</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">bruteforce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">sha256</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">==</span><span class="n">s</span><span class="p">,</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">12039102490128509125925019010000012423515617235219127649182470182570195018265927223</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="o">=</span> <span class="mi">10729072579307052184848302322451332192456229619044181105063011741516558110216720725</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">int2str</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&#34;big&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&#34;little&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">_</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))])</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&#34;big&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">_</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_parameter</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">int2str</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="p">((</span><span class="n">y</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;139.129.98.9&#39;</span><span class="p">,</span><span class="mi">30001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">prefix</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&#34;sha256(XXXX+</span><span class="si">{}</span><span class="s2">) == </span><span class="si">{}</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Give me XXXX:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">brute_force</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">m1</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="s2">&#34;Here is the frist message(64 bytes):</span><span class="si">{}</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span><span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">m2</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="s2">&#34;Here is the second message(64 bytes):</span><span class="si">{}</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span><span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">r1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="s2">&#34;The frist message&#39;s &#39;r&#39;:</span><span class="si">{}</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#sage solve order q:  g^q=1(mod p) </span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="mi">1039300813886545966418005631983853921163721828798787466771912919828750891</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="n">gcd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">M1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">h1</span><span class="p">,</span><span class="n">b1</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">M2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">h2</span><span class="p">,</span><span class="n">b2</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s1</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p1</span> <span class="o">=</span> <span class="n">b1</span><span class="o">*</span><span class="n">r1</span>
</span></span><span class="line"><span class="cl"><span class="n">p2</span> <span class="o">=</span> <span class="n">M2</span><span class="o">-</span><span class="n">M1</span>
</span></span><span class="line"><span class="cl"><span class="n">p3</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-</span><span class="n">p2</span>
</span></span><span class="line"><span class="cl"><span class="n">p4</span> <span class="o">=</span> <span class="n">invert</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3</span><span class="o">*</span><span class="n">p4</span><span class="p">)</span><span class="o">%</span><span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="n">s2</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">s1</span><span class="o">==</span><span class="n">s2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;r1 = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;r2 = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;s1 = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;s2 = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;verify(m2,r2,s2) = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">verify</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">s2</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Please choice your options:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Please give me the (r,s) of the second message:&#39;</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvall</span><span class="p">())</span>
</span></span></code></pre></div><div id="roarctf2020" class="anchor"></div>
<h2 class="relative group">ROARCTF2020 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#roarctf2020" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="reverse" class="anchor"></div>
<h3 class="relative group">Reverse 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#reverse" aria-label="Anchor">#</a></span>        
    
</h3>
<p>参考 <a href="https://kt.gy/blog/2015/10/asis-2015-finals-rsasr/"   target="_blank">
    https://kt.gy/blog/2015/10/asis-2015-finals-rsasr/</a>
因为p和q是二进制顺序相反的素数，所以p的每一位都和q有关系。所以我们可以尝试遍历p的二进制，通过判断生成的p与q再进行迭代。具体代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">158985980192501034004997692253209315116841431063210516613522548452327355222295231366801286879768949611058043390843949610463241574886852164907094966008463721486557469253652940169060186477803255769516068561042756903927308078335838348784208212701919950712557406983012026654876481867000537670622886437968839524889</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">Brute_force</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">256</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">==</span><span class="n">n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">a1</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">511</span><span class="o">-</span><span class="n">k</span><span class="p">))</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">b1</span><span class="o">=</span><span class="n">b</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">511</span><span class="o">-</span><span class="n">k</span><span class="p">))</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">a1</span><span class="o">*</span><span class="n">b1</span><span class="o">&gt;</span><span class="n">n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span> 
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">if</span>  <span class="p">(</span><span class="n">a1</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">511</span><span class="o">-</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="n">b1</span><span class="o">+</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">511</span><span class="o">-</span><span class="n">k</span><span class="p">)))</span><span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">                <span class="k">continue</span> 
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">a1</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">n</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Brute_force</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Brute_force</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>        
</span></span></code></pre></div><div id="ecdsa" class="anchor"></div>
<h3 class="relative group">ECDSA 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ecdsa" aria-label="Anchor">#</a></span>        
    
</h3>
<p>这道题贼狠，源码都不给，来看一看MENU叭</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>DEBUG<span class="o">]</span> Received 0xd bytes:
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;Give me XXXX:&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEBUG<span class="o">]</span> Sent 0x5 bytes:
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;bwUI\n&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEBUG<span class="o">]</span> Received 0x4f bytes:
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;Hello,guys!Welcome to my ECC Signature System!I promise no one can exploit it!\n&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEBUG<span class="o">]</span> Received 0x269 bytes:
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;Howevers if you can exploit it in 10 times,I will give what you want!\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;Here is the frist message(64 bytes):fipoN9jy/*@~J:] PcZY8{&amp;X!7v+\\duTln_#k(WK^Q2L)&lt;SbM$-V=Ex3Uw|h,%}F\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;Here is the second message(64 bytes):%wh-(xJ4kR+7&lt;^Zv9,Ol\\Kp/&amp;&#34;FHbc_ D@Y*mSos}V?.#L{!3B8QiP=nqCI[y:X2\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;Try to calculate the same signature for this two messages~\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;(((Notice: curve = SECP256k1, hashfunc = sha1)))\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;ECC Signature System:\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;    1. Show your pubkey\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;    2. Generate new prikey\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;    3. Update your pubkey\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;    4. Sign a message\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;    5. Verify a message\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;    6. Exploit\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;    7. Exit\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;You have only 10 times to operate!\n&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;Please choice your options:&#39;</span>
</span></span></code></pre></div><p>根据题目名这是一个ECDSA的签名系统，完了呢要求是给这他提供的两个msg签名，不仅验证要通过，而且签名还得一样。</p>
<p>先来看看这几个功能，</p>
<p>功能1是显示公钥，（可能要利用）</p>
<p>功能2是重新生成一个私钥，（应该是没用的，没啥意义，生成后就是告诉你更新后的公钥）</p>
<p>功能3是更新你的公钥，你来输入（这个肯定有点用）</p>
<p>功能4是帮你签个名 （也许用得上）</p>
<p>功能5是验证签名 （可以，但没必要）</p>
<p>功能6就是整完了用来获取flag的了。</p>
<p>六个功能一眼看来也就这个功能3可以用了。这里需要一点前置知识（现查就可以了，一样的），就是ECDSA签名的验证规则</p>
<p>这种<a href="https://blog.csdn.net/s_lisheng/article/details/79871341"   target="_blank">
    资料</a>CSDN一抓一大把。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/07/z9EpbT2FRwQrHkg.png" alt="image-20201207214850259" />
    
  </figure>

</p>
<p>image-20201207214850259</p>
<p>最后是判断 v = r，即 X.x = dG.x ,我们可以把验证公式提取出来，也即 $es^{-1}G + rs^{-1}Q = dG$</p>
<p>注意到由于验证用的是公钥Q，然后题目是提供篡改公钥这个功能的，我们知道ECDSA中$Q = kG$, 其中k是私钥，那么其实等价于我们是可以篡改私钥的，即我们用自己的私钥去给一个信息签名，完了后把用于验证的公钥给改成我们自己的公钥，验证同样也是可以通过的。那么整个过程系统的私钥都不参与了。</p>
<p>解决了签名验证的问题，剩下来就是解决如何让他们的签名保持一致了。</p>
<p>回到验证公式 $es^{-1}G + rs^{-1}Q = dG$</p>
<p>其中e是我们的消息，可以看作已知常数，r和s是我们能控制的，G是固定的，Q是公钥，也是我们自己决定，d是签名时用的随机数，整个签名的过程我们都能掌握，自然d也有我们决定，然后d会决定r，因为r = dG.x， 那么r也就固定下来了，只剩Q和s了。</p>
<p>我们把公式约一约，去掉G后就是 $es^{-1} + rs^{-1}k = d =&gt; e + rk = ds =&gt; s = (e + rk)*d^{-1}$</p>
<p>由于两个msg的s要保持一直，那么我们构造的等式就是$ (e_1 + rk) * d^{-1} = (e_2 + rk) * d^{-1}$</p>
<p>很显然啊，因为d不能等于0，这等式不可能成立啊，于是陷入僵局。</p>
<p>但这里我们忘了一个很重要的性质，就是，我们最后验证的是v = r，而r是什么，r = dG.x，我们要知道的是，椭圆曲线是一个关于x轴对称的图形，所以其实 r = -dG.x。华点都发现了，这题就解决了，</p>
<p>等式变为$ (e_1 + rk) * d^{-1} = (e_2 + rk) * (-d)^{-1}$</p>
<p>化成同余式就是$ (e_1 + rk) * d^{-1} \equiv (e_2 + rk) * (-d)^{-1} \pmod{n}$</p>
<p>有 $e_1 + rk \equiv -e_2 -rk\pmod{n}$</p>
<p>有 $k \equiv \frac{-e1-e2}{2r}\pmod{n}$</p>
<p>然后怕【我们去查一下这条曲线的<a href="https://www.secg.org/sec2-v2.pdf"   target="_blank">
    参数</a>即可</p>
<p>参考脚本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;139.129.98.9&#34;</span><span class="p">,</span><span class="s2">&#34;30002&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwnlib.util.iters</span> <span class="kn">import</span> <span class="n">mbruteforce</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">gcd</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span><span class="o">=</span><span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span><span class="o">=</span><span class="mh">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F</span>
</span></span><span class="line"><span class="cl"><span class="n">gx</span><span class="o">=</span><span class="mh">0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798</span>
</span></span><span class="line"><span class="cl"><span class="n">gy</span><span class="o">=</span><span class="mh">0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8</span>
</span></span><span class="line"><span class="cl"><span class="n">order</span><span class="o">=</span><span class="mh">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ecc</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">G</span> <span class="o">=</span> <span class="n">ecc</span><span class="p">(</span><span class="n">gx</span><span class="p">,</span><span class="n">gy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sha1</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">proof_of_work</span><span class="p">(</span><span class="n">sh</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;XXXX+&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">suffix</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf8&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;== &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cipher</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">proof</span> <span class="o">=</span> <span class="n">mbruteforce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sha256</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span>  <span class="n">cipher</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Give me XXXX:&#34;</span><span class="p">,</span> <span class="n">proof</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">proof_of_work</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Here is the frist message(64 bytes):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">msg1</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Here is the second message(64 bytes):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">msg2</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">message</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">msg1</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">e1</span><span class="o">=</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">sha1</span><span class="p">(</span><span class="n">msg1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">e2</span><span class="o">=</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">sha1</span><span class="p">(</span><span class="n">msg2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">######################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1">#解题核心</span>
</span></span><span class="line"><span class="cl"><span class="c1">#pubkey = sh.recvuntil(&#34;\n&#34;)[:-2].decode()</span>
</span></span><span class="line"><span class="cl"><span class="c1">#r=[d * G].x</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span><span class="o">=</span><span class="mi">12321</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">d</span><span class="o">*</span><span class="n">G</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">new_k</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">e1</span><span class="o">-</span><span class="n">e2</span><span class="p">)</span><span class="o">*</span><span class="n">inverse</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="n">order</span><span class="p">))</span><span class="o">%</span><span class="n">order</span>
</span></span><span class="line"><span class="cl"><span class="n">new_Q</span> <span class="o">=</span> <span class="n">new_k</span> <span class="o">*</span> <span class="n">G</span>
</span></span><span class="line"><span class="cl"><span class="n">new_S</span> <span class="o">=</span> <span class="p">((</span><span class="n">e1</span> <span class="o">+</span> <span class="n">new_k</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">inverse</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">order</span><span class="p">))</span><span class="o">%</span><span class="n">order</span>
</span></span><span class="line"><span class="cl"><span class="n">newpubkey</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">new_Q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="s2">&#34;0&#34;</span><span class="p">)</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">new_Q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="s2">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">newsignature</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="s2">&#34;0&#34;</span><span class="p">)</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">new_S</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="s2">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">######################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Please choice your options:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Please give me your public_key(hex):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">newpubkey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Please choice your options:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Please give me the signature(hex) of the frist message:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">newsignature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Please give me the signature(hex) of the second message:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">newsignature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><p>&lt;</p>
<p>&gt;</p>
<div id="bytectf" class="anchor"></div>
<h2 class="relative group">ByteCTF 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#bytectf" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="noise" class="anchor"></div>
<h3 class="relative group">noise 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#noise" aria-label="Anchor">#</a></span>        
    
</h3>
<p>需要前置知识或了解：中国剩余定理</p>
<p>task.py</p>
<pre tabindex="0"><code>#!/usr/bin/env python3
from os import urandom
from random import choices
from hashlib import sha256
import signal
import string
import sys


def getrandbits(bit):
    return int.from_bytes(urandom(bit &gt;&gt; 3), &#34;big&#34;)


def proof_of_work() -&gt; bool:
    alphabet = string.ascii_letters + string.digits
    nonce = &#34;&#34;.join(choices(alphabet, k=8))
    print(f&#39;SHA256(&#34;{nonce}&#34; + ?) starts with &#34;00000&#34;&#39;)
    suffix = input().strip()
    message = (nonce + suffix).encode(&#34;Latin-1&#34;)
    return sha256(message).digest().hex().startswith(&#34;00000&#34;)


def main():
    signal.alarm(60)
    if not proof_of_work():
        return
    secret = getrandbits(1024)
    print(&#34;Listen...The secret iz...M2@9c0f*#aF()I!($Ud3;J...&#34;
          &#34;Hello?...really noisy here again...God bless you get it...&#34;)
    for i in range(64):
        try:
            op = input().strip()
            num = input().strip()
        except EOFError:
            return
        if not str.isnumeric(num):
            print(&#34;INVALID NUMBER&#34;)
            continue
        num = int(num)
        if op == &#39;god&#39;:
            print(num * getrandbits(992) % secret)
        elif op == &#39;bless&#39;:
            if num == secret:

                try:
                    from datetime import datetime
                    from flag import FLAG
                except Exception as e:
                    FLAG = &#34;but something is error. Please contact the admin.&#34;

                print(&#34;CONGRATULATIONS %s&#34;%FLAG)
                return
            print(&#34;WRONG SECRET&#34;)
main()
</code></pre><p>还好，第一题代码量不大，不错不错。看一看，这一题功能很简单，你输入一个数字，他返回给你一个，你的数字 乘上一个992bit的 随机数字 模上一个1024bit的secret 的结果。当然，每次连接上后生成的secret是随机的，但是连上一次，可以交互64次，此时secret是保持不变的。算上你需要一次交互来获取flag，那么就是需要在63次之内“猜”到这个随机生成的secret。</p>
<p>好的，上式子，我们知道中国剩余定理是这样子的</p>
<p>$m \equiv c_1 \pmod {n_1}$ $m = c_1+k_1n_1$</p>
<p>$m \equiv c_2 \pmod {n_2}$ 等价于 $m = c_2+k_2n_2$</p>
<p>$m \equiv c_3 \pmod {n_3}$ $m = c_3+k_3n_3$</p>
<p>注意这里的模是n，他们彼此互素，然后利用中国剩余定理就可以恢复m（如果m的bit位数小于所有n的bit位数之和的话）</p>
<p>此时，如果k都等于1，那么，</p>
<p>$m = c_1+n_1$ $m = n_1+c_1$</p>
<p>$m = c_2+n_2$ 等价于 $m = n_2+c_2$</p>
<p>$m = c_3+n_3$ $m = n_3+c_3$</p>
<p>此时n和c就好像等价了，并不能知道模数到底是哪个，换一个说法就是，n和c都可以看作是模数</p>
<p>我们再回到这道题本身，设我们发送的值是$n_1,n_2,n_3$，secret为s，返回的值是$c_1,c_2,c_3$，</p>
<p>那么就会有这么些式子</p>
<p>$n_1 * randnum1 \equiv c_1 \pmod s = c_1+k_1s$</p>
<p>$n_2 * randnum2 \equiv c_2 \pmod s= c_2+k_2s$</p>
<p>$n_3 * randnum3 \equiv c_3 \pmod s= c_3+k_3s$</p>
<p>此时如果k值都为1，再挪个位置，那么就有</p>
<p>$s = n_1 * randnum1- c_1$</p>
<p>$s = n_2* randnum2 - c_2$</p>
<p>$s = n_3 * randnum3- c_3$</p>
<p>此时如果我们式子两边去一个模$n_1,n_2,n_3$</p>
<p>$s \equiv- c_1 \pmod{n_1}$</p>
<p>$s \equiv- c_2 \pmod{n_2}$</p>
<p>$s \equiv- c_3 \pmod{n_3}$</p>
<p>这不就是中国剩余定理形式么？所以当等于1，我们就可以利用中国剩余定理来恢复这个secret</p>
<p>需要满足的条件就是，$n*randnum = c+s$，还有就是n的bit位数之和要大于s的bit位数即1024</p>
<p>当然，这就需要运气了，因为他远程生成的乘数是随机的992bit数字（当然是有可能会小于992bit的），而s是1024bit的数字，所以我们要发送的n大概就是32bit的素数，32*32=1024，所以在63次交互内我们需要服务器生成32个随机数是“好”的，所谓”好””就是要让这个k正好等于1。</p>
<p>我们也可以先本地简单的测一测，可以选择比较小的数给他乘，这样子的k大概率会是0或者1，而0比较好判断，直接判断返回的值是否被我们发送过去的数整除就可以了。而是否正好等于1我们是无法判断的，但凡一组数据插入了一个让k不等于1或者0的数，那么整组数据就作废了。所以我们发送尽量小的数n，让k值大概率只落在0或者1上。</p>
<p>测试代码：</p>
<pre tabindex="0"><code>from random import *
primes = [4294966427, 4294966441, 4294966447, 4294966477, 4294966553, 4294966583, 4294966591, 4294966619, 4294966639, 4294966651, 4294966657, 4294966661, 4294966667, 4294966769, 4294966813, 4294966829, 4294966877, 4294966909, 4294966927, 4294966943, 4294966981, 4294966997, 4294967029, 4294967087, 4294967111, 4294967143, 4294967161, 4294967189, 4294967197, 4294967231, 4294967279, 4294967291]

for _ in range(20):
    secret = getrandbits(1024)
    for num in primes:
            print(num * getrandbits(992) // secret),
    print
</code></pre><p>这里我们选择固定了随机数，然后经过20次的测试，下面是测试结果</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/l4VdMyeQmps7JPt.png" alt="image-20201102145925061" />
    
  </figure>

</p>
<p>image-20201102145925061</p>
<p>可以发现，生成的随机数似乎也具有一定程度的局部性，当k出现7，8这样比较大的数的时候，几乎整组的k都比较大，但大部分情况下，由于我们输入的素数比较小，还是只有0和1的情况偏多，但一般也是0偏多，所以，，看脸了，只要有一半以上的1，我们就成功了。</p>
<div id="解题流程" class="anchor"></div>
<h4 class="relative group">解题流程： 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e8%a7%a3%e9%a2%98%e6%b5%81%e7%a8%8b" aria-label="Anchor">#</a></span>        
    
</h4>
<ol>
<li>确定63个比较小的素数</li>
<li>把这些值发送过去</li>
<li>收到的值进行一个判断，是否被自己发过去的数整除，是就扔掉，否则就存起来</li>
<li>存起来的数超过32个就可以进行CRT尝试恢复secret</li>
<li>发送secret过去验证，要是没拿到flag就回到第2步，如此循环往复，加油吧，看你的脸了！</li>
</ol>
<p>exp：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GCRT</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">ai</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">curm</span><span class="p">,</span> <span class="n">cura</span> <span class="o">=</span> <span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ai</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">GCD</span><span class="p">(</span><span class="n">curm</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">cura</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="p">(</span><span class="n">c</span> <span class="o">%</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">K</span> <span class="o">=</span> <span class="n">c</span> <span class="o">//</span> <span class="n">d</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="n">curm</span> <span class="o">//</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span> <span class="o">//</span> <span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cura</span> <span class="o">+=</span> <span class="n">curm</span> <span class="o">*</span> <span class="n">K</span>
</span></span><span class="line"><span class="cl">        <span class="n">curm</span> <span class="o">=</span> <span class="n">curm</span> <span class="o">*</span> <span class="n">m</span> <span class="o">//</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">        <span class="n">cura</span> <span class="o">%=</span> <span class="n">curm</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cura</span> <span class="o">%</span> <span class="n">curm</span><span class="p">,</span> <span class="n">curm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">proof_of_work</span><span class="p">(</span><span class="n">sh</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;SHA256(</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">nonce</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;with </span><span class="se">\&#34;</span><span class="s1">00000</span><span class="se">\&#34;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rest</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">nonce</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">rest</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;Latin-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">sha256</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;00000&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;again...God bless you get it...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">io</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;god&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">primes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4294966427</span><span class="p">,</span> <span class="mi">4294966441</span><span class="p">,</span> <span class="mi">4294966447</span><span class="p">,</span> <span class="mi">4294966477</span><span class="p">,</span> <span class="mi">4294966553</span><span class="p">,</span> <span class="mi">4294966583</span><span class="p">,</span> <span class="mi">4294966591</span><span class="p">,</span> <span class="mi">4294966619</span><span class="p">,</span> <span class="mi">4294966639</span><span class="p">,</span> <span class="mi">4294966651</span><span class="p">,</span> <span class="mi">4294966657</span><span class="p">,</span> <span class="mi">4294966661</span><span class="p">,</span> <span class="mi">4294966667</span><span class="p">,</span> <span class="mi">4294966769</span><span class="p">,</span> <span class="mi">4294966813</span><span class="p">,</span> <span class="mi">4294966829</span><span class="p">,</span> <span class="mi">4294966877</span><span class="p">,</span> <span class="mi">4294966909</span><span class="p">,</span> <span class="mi">4294966927</span><span class="p">,</span> <span class="mi">4294966943</span><span class="p">,</span> <span class="mi">4294966981</span><span class="p">,</span> <span class="mi">4294966997</span><span class="p">,</span> <span class="mi">4294967029</span><span class="p">,</span> <span class="mi">4294967087</span><span class="p">,</span> <span class="mi">4294967111</span><span class="p">,</span> <span class="mi">4294967143</span><span class="p">,</span> <span class="mi">4294967161</span><span class="p">,</span> <span class="mi">4294967189</span><span class="p">,</span> <span class="mi">4294967197</span><span class="p">,</span> <span class="mi">4294967231</span><span class="p">,</span> <span class="mi">4294967279</span><span class="p">,</span> <span class="mi">4294967291</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;182.92.153.117&#34;</span><span class="p">,</span> <span class="mi">30101</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">proof_of_work</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">length</span> <span class="o">=</span> <span class="mi">32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">63</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span> <span class="o">=</span> <span class="n">io</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">primes</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tmp</span><span class="o">%</span><span class="n">primes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>		<span class="o">//</span><span class="n">这个判断是剔除k等于0的情况</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">:</span>		<span class="o">//</span><span class="n">如果超过32个数的k不等于0</span><span class="err">，</span><span class="n">我们就可以拿来用了</span><span class="err">，</span><span class="n">但也不确定是否这32个数都为1</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">secret</span> <span class="o">=</span> <span class="n">GCRT</span><span class="p">(</span><span class="n">primes</span><span class="p">,</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;bless&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">secret</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;WRONG&#39;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><div id="threshold" class="anchor"></div>
<h3 class="relative group">threshold 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#threshold" aria-label="Anchor">#</a></span>        
    
</h3>
<p>需要前置知识或了解：椭圆曲线相关性质</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gmssl</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">sm2</span>
</span></span><span class="line"><span class="cl"><span class="c1">#from flag import FLAG</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span><span class="o">=</span><span class="s2">&#34;Congratulations!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sm2p256v1_ecc_table</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="s1">&#39;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="s1">&#39;32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7&#39;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">         <span class="s1">&#39;bc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="s1">&#39;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">G</span> <span class="o">=</span> <span class="s1">&#39;32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7&#39;</span> \
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;bc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">tsm2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="n">k1_str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">send_p1</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k1_str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">backdoor</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;backdoor:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">output_p1</span><span class="p">(</span><span class="n">k1_str</span><span class="p">,</span> <span class="n">backdoor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">tsm2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;msg:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sign</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;sign:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">check</span> <span class="o">=</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">check</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">message</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;Hello, Welcome to ByteCTF2020!&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TSM2</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ecc_table</span> <span class="o">=</span> <span class="n">sm2p256v1_ecc_table</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span> <span class="o">=</span> <span class="n">ecc_table</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ecc_a3</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sk</span><span class="p">,</span> <span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pks</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">send_p1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">k1_str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k1_str</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span> 
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%064x%0128s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">R1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">output_p1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k1_str</span><span class="p">,</span> <span class="n">r_s2_s3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_s2_s3</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_s2_s3</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_s2_s3</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k1_str</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sks</span><span class="err">、</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span> <span class="o">*</span> <span class="n">k1</span> <span class="o">*</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">s3</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%064x%064x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sign</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Sign</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Sign</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">P2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="err">、</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">P1</span> <span class="o">==</span> <span class="n">P2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">P1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_double_point</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">P1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_jacb_to_nor</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="p">((</span><span class="n">e</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_kg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="mi">128</span>
</span></span><span class="line"><span class="cl">        <span class="n">Point</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Point</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask_str</span> <span class="o">=</span> <span class="s1">&#39;8&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask_str</span> <span class="o">+=</span> <span class="s1">&#39;0&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask_str</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Temp</span> <span class="o">=</span> <span class="n">Point</span>
</span></span><span class="line"><span class="cl">        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">Temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_double_point</span><span class="p">(</span><span class="n">Temp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="n">Temp</span><span class="p">,</span> <span class="n">Point</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Temp</span> <span class="o">=</span> <span class="n">Point</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_jacb_to_nor</span><span class="p">(</span><span class="n">Temp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_double_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Point</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">len_2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Point</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="n">len_2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">len_2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">z1</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">z1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Point</span><span class="p">[</span><span class="n">len_2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">T6</span> <span class="o">=</span> <span class="p">(</span><span class="n">z1</span> <span class="o">*</span> <span class="n">z1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">*</span> <span class="n">y1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T3</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">T6</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T4</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">T6</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T3</span> <span class="o">*</span> <span class="n">T4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T3</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">*</span> <span class="n">z1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T4</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T5</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">T4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T6</span> <span class="o">=</span> <span class="p">(</span><span class="n">T6</span> <span class="o">*</span> <span class="n">T6</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T6</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_a3</span> <span class="o">*</span> <span class="n">T6</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">+</span> <span class="n">T6</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">z3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T3</span> <span class="o">+</span> <span class="n">T3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">*</span> <span class="n">T1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span> <span class="o">*</span> <span class="n">T4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T3</span> <span class="o">-</span> <span class="n">T5</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">T5</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">T4</span> <span class="o">=</span> <span class="p">(</span><span class="n">T5</span> <span class="o">+</span> <span class="p">((</span><span class="n">T5</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">T3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">T4</span> <span class="o">=</span> <span class="p">(</span><span class="n">T5</span> <span class="o">+</span> <span class="p">(</span><span class="n">T5</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">T3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">*</span> <span class="n">T4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T2</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">0</span><span class="si">%d</span><span class="s1">x&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span>
</span></span><span class="line"><span class="cl">            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">form</span> <span class="o">%</span> <span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">z3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">P1</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="mi">128</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P2</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">P2</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="mi">128</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">len_2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span>
</span></span><span class="line"><span class="cl">        <span class="n">l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&lt;</span> <span class="n">len_2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l2</span> <span class="o">&lt;</span> <span class="n">len_2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">X1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">Y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="n">len_2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">l1</span> <span class="o">==</span> <span class="n">len_2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">Z1</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">Z1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="n">len_2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="n">len_2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z1</span> <span class="o">*</span> <span class="n">Z1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">*</span> <span class="n">Z1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T3</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">*</span> <span class="n">T1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">*</span> <span class="n">T2</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">T3</span> <span class="o">-</span> <span class="n">X1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T3</span> <span class="o">+</span> <span class="n">X1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T4</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span> <span class="o">*</span> <span class="n">T2</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="n">Y1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">Z3</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z1</span> <span class="o">*</span> <span class="n">T2</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">T2</span> <span class="o">*</span> <span class="n">T4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T3</span> <span class="o">*</span> <span class="n">T4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T5</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">*</span> <span class="n">T1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T4</span> <span class="o">=</span> <span class="p">(</span><span class="n">X1</span> <span class="o">*</span> <span class="n">T4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">X3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T5</span> <span class="o">-</span> <span class="n">T3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y1</span> <span class="o">*</span> <span class="n">T2</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T4</span> <span class="o">-</span> <span class="n">X3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">T1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">*</span> <span class="n">T3</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">Y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T2</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">0</span><span class="si">%d</span><span class="s1">x&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span>
</span></span><span class="line"><span class="cl">            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">form</span> <span class="o">%</span> <span class="p">(</span><span class="n">X3</span><span class="p">,</span> <span class="n">Y3</span><span class="p">,</span> <span class="n">Z3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_convert_jacb_to_nor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">        <span class="n">len_2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Point</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="n">len_2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Point</span><span class="p">[</span><span class="n">len_2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">z_inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">z_invSquar</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_inv</span> <span class="o">*</span> <span class="n">z_inv</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">z_invQube</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_invSquar</span> <span class="o">*</span> <span class="n">z_inv</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">z_invSquar</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z_invQube</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">z_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">z_inv</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">z_new</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">0</span><span class="si">%d</span><span class="s1">x&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span>
</span></span><span class="line"><span class="cl">            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">form</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">sk</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm2p256v1_ecc_table</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">tsm2</span> <span class="o">=</span> <span class="n">TSM2</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pk:</span><span class="si">%s</span><span class="s1">&#39;</span>   <span class="o">%</span><span class="n">tsm2</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pks:</span><span class="si">%064x</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tsm2</span><span class="o">.</span><span class="n">pks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">op</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;op: &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;sign&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sign</span><span class="p">(</span><span class="n">tsm2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;verify&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">verify</span><span class="p">(</span><span class="n">tsm2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;sign: sign message
</span></span></span><span class="line"><span class="cl"><span class="s2">verify: verify message&#34;&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>啊，这第二题画风就突变，好长的代码，让人失去欲望。但其实呢，大部分都是对sm2的一个实现，其实不用细究。这里我们就直接先提取关键部分，一步一步来啦。</p>
<p>首先最上面的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">tsm2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="n">k1_str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">send_p1</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k1_str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">backdoor</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;backdoor:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">output_p1</span><span class="p">(</span><span class="n">k1_str</span><span class="p">,</span> <span class="n">backdoor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">tsm2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;msg:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sign</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;sign:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">check</span> <span class="o">=</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">check</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">message</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;Hello, Welcome to ByteCTF2020!&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
</span></span></code></pre></div><p>俩功能，一个是注册，一个是验证，获取flag的地方就是这个验证，他要求你对message进行一个签名，而message要求是b’Hello, Welcome to ByteCTF2020!’</p>
<p>好的，那我们看看咋样才能给这个message签上名，去找找签名的验证函数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sign</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Sign</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Sign</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">P1</span> <span class="o">==</span> <span class="n">P2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">P1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_double_point</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">P1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_jacb_to_nor</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="p">((</span><span class="n">e</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span></span></code></pre></div><p>这个验证函数有三个输入：r，s，e，然后这里有一个self._kg ，这个其实就是一个椭圆曲线上的一个乘法，所以P1 = s * g，g是椭圆曲线上的一个基点，P2 = t * pk ，代码前头有对pk的定义 <code>self.pk = self._kg(self.sk, ecc_table['g'])</code>,所以就是P2 = ((r+s)%n) * sk * g，接下来的操作不难看出，这里就是两个点相加，这里可以print出来看一下输出，是一个点的坐标的十六进制表示的字符串的拼接，x就是这个点的x坐标。最后是一个判断 r == ((e + x) % self.n)</p>
<p>首先e是固定的 b’Hello, Welcome to ByteCTF2020!’。我们能操作的就是r和s了，x是一个算出来的坐标，为了让这个判断成立，我们就需要构造我们的输入r，为了构造r得提前算出P1的x坐标，而P1=P1+P2 = s * g + ((r + s)%n) * sk * g。乍一看我们好像陷入了死锁。这里头怎么又出现了r？</p>
<p>换个思路想想，虽然这里的P1是后来根据我们的输入算出来的，但其实我们也可以先固定这个P1。最后再精心构造一下输入，让他正好算出来是这个P1，</p>
<p>所以假设我们已经知道最后的点P1了，就当他是2g好了，这样我们就可以算出x了，有了x，那么r也就固定下来了，那我们就就只需要构造s让它算出这个P1点了。</p>
<p>我们知道，虽然椭圆曲线的加法和乘法不同于普通的四则运算，但是一些运算法则还是适用的，比如分配律、交换律这些，所以式子：P1=P1+P2 = s * g + ((r + s)%n) * sk * g 可以做一些变形，我们已经知道P1=2g了，外加这条曲线的阶是n（我承认我有赌的成分），所以有</p>
<p>$2*g \equiv s * g + (r + s) * sk * g \pmod n$</p>
<p>$2 \equiv s + (r+s)* sk \pmod n$</p>
<p>$2 \equiv s*(sk+1) + r *sk \pmod n$</p>
<p>$s \equiv (2 -r*sk) *( sk+1)^{-1} \pmod n$</p>
<p>其中r确定了，n确定了，只剩sk了，而sk其实也就是相当于这条椭圆曲线的私钥</p>
<p>这是我们得回过头来看最初的sign函数了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">tsm2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="n">k1_str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">send_p1</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k1_str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">backdoor</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;backdoor:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">output_p1</span><span class="p">(</span><span class="n">k1_str</span><span class="p">,</span> <span class="n">backdoor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span></code></pre></div><p>不能再明显了，backdoor都写给你了，显然是要利用这里来整到sk，</p>
<p>data和k1_str都是不可控的随机数，</p>
<p>然后print了send_p1函数的输出，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_p1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">k1_str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k1_str</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span> 
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%064x%0128s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">R1</span><span class="p">)</span>
</span></span></code></pre></div><p>给的是data和一个R1，R1是k1 * g，是一个曲线上的点，好像没啥用啊，继续看</p>
<p>拿到我们的输入后，程序把k1_str和我们的输入传给了output_p1并给了输出</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">output_p1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k1_str</span><span class="p">,</span> <span class="n">r_s2_s3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_s2_s3</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_s2_s3</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_s2_s3</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">para_len</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k1_str</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sks</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span> <span class="o">*</span> <span class="n">k1</span> <span class="o">*</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">s3</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%064x%064x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span></span></code></pre></div><p>给的是r和s，只要s不等于0，s+r不等于n，</p>
<p>其中我们的输入应该是96字节的，分为三段，代表r，s2，s3，</p>
<p>k1是就是k1_str的整型，程序之前生成的，d1是self.sks，这在代码里头是<code>self.sks = int(func.random_hex(self.para_len), 16)</code>也是一个随机数，但是它和sk跟pks有点关系：<code>self.pks = pow((self.sk + 1) * self.sks, self.n - 2, self.n) % self.n</code></p>
<p>之所以扯到pks，因为程序一进去他就把这个值给我们了啊</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">sk</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm2p256v1_ecc_table</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">tsm2</span> <span class="o">=</span> <span class="n">TSM2</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pk:</span><span class="si">%s</span><span class="s1">&#39;</span>   <span class="o">%</span><span class="n">tsm2</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pks:</span><span class="si">%064x</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tsm2</span><span class="o">.</span><span class="n">pks</span><span class="p">)</span>
</span></span></code></pre></div><p>根据pks的生成式子，其中除了sk和sks我们都知道，</p>
<p>所以我们应该就是要利用这个pks，sks来恢复这个sk，但是怎么获得这个sks 也即 d1 呢，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span> <span class="o">*</span> <span class="n">k1</span> <span class="o">*</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">s3</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</span></span></code></pre></div><p>让s2=0，s3=1，r=0，这样就能得到 s = d1 % n了</p>
<p>显然d1 &lt; n ，故s = d1，并且 d1 + r != n，故能返回。</p>
<p>那么至此，利用链就全了。</p>
<div id="解题流程-1" class="anchor"></div>
<h4 class="relative group">解题流程 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e8%a7%a3%e9%a2%98%e6%b5%81%e7%a8%8b-1" aria-label="Anchor">#</a></span>        
    
</h4>
<p>所以这道题的整个解题流程：</p>
<ol>
<li>构造backdoor = 191 * ‘0’ + ‘1’ 来获取sks，</li>
<li>利用pks来获取sk，</li>
<li>随便在曲线上取一个点，计算x，根据e来固定r</li>
<li>计算$s \equiv (2 -r*sk) *( sk+1)^{-1} \pmod n$</li>
<li>传入r，s，e，获取flag</li>
</ol>
<p>exp</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gmssl</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">sm2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">TSM2</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sk</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">random_hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sm2p256v1_ecc_table</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">tsm2</span> <span class="o">=</span> <span class="n">TSM2</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;182.92.215.134&#34;</span><span class="p">,</span><span class="s2">&#34;30103&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;pk:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pk</span> <span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;pks:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pks</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tsm2</span><span class="o">.</span><span class="n">pks</span><span class="o">=</span><span class="n">pks</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;op:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;sign&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;backdoor:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;0&#34;</span><span class="o">*</span><span class="mi">191</span><span class="o">+</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tsm2</span><span class="o">.</span><span class="n">sks</span><span class="o">=</span><span class="n">sks</span>
</span></span><span class="line"><span class="cl"><span class="n">tmp</span> <span class="o">=</span> <span class="n">inverse</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">pks</span><span class="p">,</span><span class="n">tsm2</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tsm2</span><span class="o">.</span><span class="n">sk</span><span class="o">=</span><span class="n">tmp</span><span class="o">*</span><span class="n">inverse</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">sks</span><span class="p">,</span><span class="n">tsm2</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">%</span><span class="n">tsm2</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">tsm2</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">sk</span><span class="p">,</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="o">==</span><span class="n">pk</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;op:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;verify&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span><span class="o">=</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, Welcome to ByteCTF2020!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">=</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">_kg</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">ecc_table</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">tsm2</span><span class="o">.</span><span class="n">para_len</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">e</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">tsm2</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#b = s + (s+r)*sk</span>
</span></span><span class="line"><span class="cl"><span class="c1">#b = s*(1+sk) + r*sk</span>
</span></span><span class="line"><span class="cl"><span class="c1">#b - r*sk</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span><span class="o">=</span><span class="mh">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">tsm2</span><span class="o">.</span><span class="n">sk</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">tsm2</span><span class="o">.</span><span class="n">sk</span><span class="p">)</span><span class="o">*</span><span class="n">inverse</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">tsm2</span><span class="o">.</span><span class="n">sk</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">%</span><span class="n">n</span>
</span></span><span class="line"><span class="cl"><span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%064x%064x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;msg:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Hello, Welcome to ByteCTF2020!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;sign:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><div id="x-nuca" class="anchor"></div>
<h2 class="relative group">X-NUCA 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#x-nuca" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="weird" class="anchor"></div>
<h3 class="relative group">weird 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#weird" aria-label="Anchor">#</a></span>        
    
</h3>
<p>需要前置知识或了解：奇异爱德华曲线</p>
<p>可参考资料：https://learnblockchain.cn/article/1627</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env sage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">FLAG</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">FLAG</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;X-NUCA{&#34;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">FLAG</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">key_gen</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">bits</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">bits</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">p</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">q</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">getrandbits</span><span class="p">(</span><span class="n">bits</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">getrandbits</span><span class="p">(</span><span class="n">bits</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">N</span><span class="p">))</span> <span class="o">//</span> <span class="mi">12</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span> <span class="nb">int</span><span class="p">(((</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mf">0.21</span><span class="p">))</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">))),</span> <span class="nb">int</span><span class="p">(((</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mf">0.21</span><span class="p">))</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">)))</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">k</span> <span class="o">=</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">bits</span> <span class="o">=</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key_gen</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">FLAG</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">),</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">FLAG</span><span class="p">[</span><span class="mi">32</span><span class="p">:],</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="p">(((</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(((</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span> <span class="o">%</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 2000 years later...:)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ct</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">((</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;output.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></div><p>好的，第一题代码量不多，不错不错（嗯？似曾相识，危。。）首先看看他的功能，加密方式是把flag拆成了左右两份，组成一个数对，然后做了e次的操作，得到一个ct数对。这里的e次操作其实就是一个奇异爱德华曲线的一个乘法操作。（题目名不就是weird么？）所以有了e作为加密的公钥，我们自然就要找私钥d，而私钥d，（我承认我有赌的成分）d=inverse(e,(p+1) * (q+1))，（曾经在一篇paper里看到过一眼，虽然用的并非奇异爱德华曲线）</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/CDvyNE26ImwhYZA.png" alt="image-20201102183336623" />
    
  </figure>

</p>
<p>image-20201102183336623</p>
<p>其中p，q是大数N的一个分解。这里阶的确定不是很严格，但先试试啦。那么要这么试的话就要分解N，那就要看到这个keygen的过程了，这里p，q的生成有一点点小要求，然后就是这个e的生成，为了生成这个e，还特意整了个x，y。最后要求gcd(e, (p+1) * (q+1))，唉，这，感觉我的猜测是对的好叭。到了这里，，这还不像西湖论剑的那一道题嘛<a href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&amp;mid=100004157&amp;idx=1&amp;sn=ba121056137afd43cd1768c66f1cad20&amp;chksm=7bf78b4d4c80025b9dec44e9cd33702f2a5174cafb491ddf893e5229e9e5909e1ffda4b550ec&amp;xtrack=1&amp;scene=0&amp;subscene=10000&amp;clicktime=1604313274&amp;enterid=1604313274&amp;ascene=7&amp;devicetype=android-29&amp;version=27001353&amp;nettype=ctnet&amp;abtest_cookie=AAACAA%3D%3D&amp;lang=zh_CN&amp;exportkey=A%2BEVclkqshGGX1AhhJLO4XU%3D&amp;pass_ticket=BxnNKDSg4NDA9EVhX4ioGO7c%2Fv4T%2BEtwsPAmYnDNjByfyEKbNWLjsXUcxQLtmrfk&amp;wx_header=1"   target="_blank">
    Wake me until May ends</a>。这道题相关的paper提到</p>
<p>如果e满足一定的条件，</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/Xi7LcNKjHEbYUOJ.png" alt="image-20201102184915448" />
    
  </figure>

</p>
<p>image-20201102184915448</p>
<p>那么x，y就会在e/N的连分数上，并且通过x和y可以获得T：p+q的一个近似。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/OLiZTxfQbUqVRWs.png" alt="image-20201102184201011" />
    
  </figure>

</p>
<p>image-20201102184201011</p>
<p>那么回到这道题本身，e的取值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span> <span class="nb">int</span><span class="p">(((</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mf">0.21</span><span class="p">))</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">))),</span> <span class="nb">int</span><span class="p">(((</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mf">0.21</span><span class="p">))</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span><span class="p">)))</span> <span class="p">)</span>
</span></span></code></pre></div><p>即$\frac{((p+1) * (q+1) * 3 * (p+q)-(p-q) * N^{0.21}) * y}{x * 3 * (p+q)}&lt;e&lt;\frac{((p+1) * (q+1) * 3 * (p+q)+(p-q) * N^{0.21}) * y}{x * 3 * (p+q)}$</p>
<p>即$ex-(p+1) * (q+1) * y&lt;\frac{|(p-q) * N^{0.21}|}{3(p+q)} * y$</p>
<p>这个范围与paper中给定的$|z|&lt;\frac{|p-q|}{3(p+q)}N^{\frac{1}{4}}y$很类似了，就是paper里头是用的$\phi(N)$，而题目用的是(p+1)(q+1)，但问题不大</p>
<p>$ex-(p+1) * (q+1) * y = z$</p>
<p>$ex - y(N + 1 + p + q) = z$</p>
<p>$\frac{ex}{y}-N-p-q-1 = \frac{z}{y}$</p>
<p>$\frac{ex}{y}-N-1 - \frac{z}{y} = p + q$</p>
<p>算一下$\frac{z}{y}$即$\frac{|p-q|}{3(p+q)}N^{0.21}$的大小，约为2048 * 0.21 = 430bit</p>
<p>现在姑且我们把$T = \frac{ex}{y}-N-1$看作是p+q，然后计算$\rho = \frac{T+\sqrt{T^2 -4N}}{2}$，$\rho$作为p的一个近似，其中大约低430bit是不准确的。</p>
<p>这个时候我们就要用到RSA密码系统中用到过的<a href="https://www.anquanke.com/post/id/213821"   target="_blank">
    Factoring with high bits known</a>，</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/fuX63akFOD4iSeg.png" alt="image-20201102192520897" />
    
  </figure>

</p>
<p>image-20201102192520897</p>
<p>显然这里有430bit的不确定位数是满足这个关系的，于是利用这个算法我们最终能成功的分解出p，q来</p>
<p>然后就能算出这个私钥了。</p>
<p>有了私钥了，这个曲线怎么算呢？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="p">(((</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(((</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span> <span class="o">%</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 2000 years later...:)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ct</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">((</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">)</span> <span class="p">)</span>
</span></span></code></pre></div><p>这里有个系数d，首先要计算出这个系数d</p>
<p>这个系数d的计算要利用到题目给的ct，</p>
<p>首先看到扭曲爱德华曲线的定义式</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/2XckCxZilOrKMwt.png" alt="image-20201102193536643" />
    
  </figure>

</p>
<p>image-20201102193536643</p>
<p>针对这一条曲线的加法公式是</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/qNTdBZHuekX2nAJ.png" alt="image-20201102193604325" />
    
  </figure>

</p>
<p>image-20201102193604325</p>
<p>针对这一道题他代码里的那个加法式子，我们会发现，这里相当于是扭曲爱德华曲线的系数a = -d</p>
<p>那么再配上一个坐标(x,y)，我们就能计算出系数d了。</p>
<p>其实这里可以做一个思考，这个系数d是有啥用？</p>
<p>我们看到这个源码里这个系数d的生成代码<code>d = (((pt[1])**2 - 1) * inverse_mod(((pt[1])**2 + 1) * (pt[0])**2, N)) % N</code></p>
<p>这里pt[0],pt[1]是flag明文前后两段的十进制数表示，所以d是由flag明文决定的。</p>
<p>我们再变换上述扭曲爱德华曲线的方程：</p>
<p>$ax^2 + y^2 = 1 + dx^2y^2$</p>
<p>$dx^2y^2+dx^2=y^2 - 1$</p>
<p>$d(x^2(y^2+1))=y^2 - 1$</p>
<p>$d = (y^2-1) * ((y^2+1) * x^2)^{-1}$</p>
<p>可以发现就是这个生成代码的方程式，pt[1]代表y，pt[0]代表x</p>
<p>所以其实这个系数d的作用就是保证flag所代表的点在这条曲线上。</p>
<p>好了，系数d也算出来了，怎么利用私钥来解密呢？</p>
<p>显然不可能直接利用原来里的这个循环去加上这些点，</p>
<p>信安数基中就提到过的重复倍加算法了解一下咯~</p>
<div id="解题流程-2" class="anchor"></div>
<h4 class="relative group">解题流程 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e8%a7%a3%e9%a2%98%e6%b5%81%e7%a8%8b-2" aria-label="Anchor">#</a></span>        
    
</h4>
<p>所以这道题的整个解题流程：</p>
<ol>
<li>利用连分数得到x，y（至于怎么确定x，y. 可以根据得到的x，y的bit位数，或者用x，y计算出来的T的bit位数来判断）</li>
<li>利用Factoring with high bits known 分解出p，q</li>
<li>计算私钥 prikey = inverse(e , (p+1) * (q+1))</li>
<li>计算系数$d = (y^2-1) * ((y^2+1) * x^2)^{-1}$</li>
<li>利用重复倍加算法做一个乘法计算 mt = d * ct</li>
</ol>
<p>exp</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">e</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="p">(,)</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="n">continued_fraction</span><span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="o">=</span> <span class="n">e</span><span class="o">*</span><span class="n">x</span><span class="o">//</span><span class="n">y</span><span class="o">-</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="mi">1023</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1026</span><span class="p">:</span>	<span class="c1">#根据T的bit位数来确定x,y</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gmpy2</span> <span class="kn">import</span> <span class="o">*</span>							<span class="c1">#Factoring with high bits known</span>
</span></span><span class="line"><span class="cl"><span class="n">_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="n">iroot</span><span class="p">(</span><span class="n">T</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span><span class="o">=</span><span class="n">N</span>
</span></span><span class="line"><span class="cl"><span class="n">kbits</span> <span class="o">=</span> <span class="mi">430</span>
</span></span><span class="line"><span class="cl"><span class="n">PR</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl"><span class="n">x0</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">small_roots</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="n">kbits</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">+</span><span class="n">x0</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;p: &#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">n</span> <span class="o">%</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;q: &#34;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="p">(,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#-d*x*^2 +y^2 = 1+d*x^2*y^2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">inverse_mod</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">%</span><span class="n">N</span>					<span class="c1">#计算系数d</span>
</span></span><span class="line"><span class="cl"><span class="n">e_inv</span> <span class="o">=</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="nb">int</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>		<span class="c1">#计算私钥prikey</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span><span class="n">pt</span><span class="p">):</span>												<span class="c1">#重复倍加算法的实现</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">((</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ct</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mul_by_double_adding</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pt</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ct</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">&gt;&gt;</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pt</span>												
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">=</span><span class="n">mul_by_double_adding</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span><span class="n">e_inv</span><span class="p">)</span>						<span class="c1">#获取mt，得到flag</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</span></span></code></pre></div><div id="imposter" class="anchor"></div>
<h3 class="relative group">imposter 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#imposter" aria-label="Anchor">#</a></span>        
    
</h3>
<p>Toy_AE.py</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.strxor</span> <span class="kn">import</span> <span class="n">strxor</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span><span class="p">,</span> <span class="n">bytes_to_long</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Toy_AE</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">init_cipher</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">init_cipher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">block_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">m</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">block_size</span> <span class="k">else</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x80</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">GF2_mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">bin</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">bit</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">^=</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">        <span class="n">upper</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">)[:</span><span class="o">-</span><span class="n">n_size</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">lower</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">)[</span><span class="o">-</span><span class="n">n_size</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">upper</span> <span class="o">^</span> <span class="n">lower</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_EF</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">_te</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_DF</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">msg</span> <span class="k">if</span> <span class="n">_te</span> <span class="o">==</span> <span class="n">te</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">A_EF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ConvenienceFixed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;DeltaConvenience&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">M_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">C_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feistel_enc_2r</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">M_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">C_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">C_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">            <span class="n">Cm</span>  <span class="o">=</span>  <span class="n">strxor</span><span class="p">(</span><span class="n">Z</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">Cm_1</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">Cm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">))),</span> <span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">strxor</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">Cm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">C_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cm_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">C_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">Cm</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">C_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">multer</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">multer</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">TE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">multer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C_list</span><span class="p">),</span> <span class="n">TE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">A_DF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ct</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ConvenienceFixed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;DeltaConvenience&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">C_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">M_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feistel_dec_2r</span><span class="p">(</span><span class="n">C_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">C_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="n">M2</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">M_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">M_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">Mm_1</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">))),</span> <span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">Mm_1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">Mm</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="n">Z</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">strxor</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">M_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mm_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">M_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">Mm</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">Mm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">M_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">C_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">multer</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">multer</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">TE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">multer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">M_list</span><span class="p">),</span> <span class="n">TE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">feistel_enc_2r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">C1</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)),</span> <span class="n">M2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">C2</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">))),</span> <span class="n">M1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">feistel_dec_2r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">M1</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">))),</span> <span class="n">C2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">M2</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)),</span> <span class="n">C1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span>
</span></span></code></pre></div><p>task.py</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Toy_AE</span> <span class="kn">import</span> <span class="n">Toy_AE</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">FLAG</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">proof_of_work</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">proof</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">    <span class="n">digest</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;sha256(XXXX+</span><span class="si">%s</span><span class="s2">) == </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proof</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span><span class="n">digest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Give me XXXX:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">sha256</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">proof</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">!=</span> <span class="n">digest</span> <span class="k">else</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">appendix</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;Uid=</span><span class="si">%d</span><span class="se">\xff</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">uid</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;UserName=</span><span class="si">%s</span><span class="se">\xff</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">uname</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;T=</span><span class="si">%s</span><span class="se">\xff</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;Cmd=</span><span class="si">%s</span><span class="se">\xff</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">+=</span> <span class="n">appendix</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">uid</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">appendix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">:]),</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">9</span><span class="p">:],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">:],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">4</span><span class="p">:],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">appendix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">apply_ticket</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Set up your user id:&#34;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">uname</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your username:&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">uname</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Administrator&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Sorry, preserved username.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">uid</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your command:&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Give_Me_Flag&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Not allowed!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">appendix</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Any Appendix?&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">appendix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Your ticket:</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">ct</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;With my Auth:</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">te</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_ticket</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Ticket:&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">te</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Auth:&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">te</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">msg</span>
</span></span><span class="line"><span class="cl">    <span class="n">uid</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">appendix</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">uname</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Administrator&#34;</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Give_Me_Flag&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Nothing happend.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Menu:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[1] Apply Ticket&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[2] Check Ticket&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[3] Exit&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">op</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your option:&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">apply_ticket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">check_ticket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Bye!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ae</span> <span class="o">=</span> <span class="n">Toy_AE</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">proof_of_work</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">menu</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>可恶，果然是这样吗。。不只代码长，甚至附件都有俩。害，慢慢啃咯。。。先不管这个加密的具体是啥，来看看功能是啥叭。程序有俩功能，提供ticket，和检查ticket，获取flag的点在检查ticket，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">_te</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">msg</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_DF</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">msg</span> <span class="k">if</span> <span class="n">_te</span> <span class="o">==</span> <span class="n">te</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">msg</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">te</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">msg</span>
</span></span><span class="line"><span class="cl"><span class="n">uid</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">appendix</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">uname</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Administrator&#34;</span> <span class="ow">and</span> <span class="n">cmd</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Give_Me_Flag&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
</span></span></code></pre></div><p>要求你的这个ticket代表的信息是，用户名是Administrator，要执行的命令是Give_Me_Flag，并且还要提供这个ticket的签名Auth来保证他的合法性。</p>
<p>再来看看这个提供ticket有啥，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">apply_ticket</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Set up your user id:&#34;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">uname</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your username:&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">uname</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Administrator&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Sorry, preserved username.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#return</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">uid</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Your command:&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;Give_Me_Flag&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Not allowed!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#return</span>
</span></span><span class="line"><span class="cl">    <span class="n">appendix</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Any Appendix?&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">appendix</span><span class="p">)</span>
</span></span></code></pre></div><p>他要求你提供，uid，用户名，cmd，和额外的可选择的信息。其中，用户名不能等于Administrator，cmd不能等于Give_Me_Flag。（不然这题直接就没了。）然后他会生成一个你的用户名的sha256的摘要，至于存多少长读进你的message呢，由你的uid来决定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">token</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">uname</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">uid</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;ascii&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>然后一些限制是，除了uid最大为5位数字之外，其余输入最多只能16个字符，并且每个字符的ascii都得在0-128之间（由decode(‘ascii’)限制）。（不然你要是输入\xff，这题也直接就没了）</p>
<p>所以题目意思很明确，你要伪造密文，并且还要能够构造对应的签名来通过合法性验证。让他解密信息后用户名为Administrator，cmd为Give_Me_Flag。然后由于对输入做的诸多限制，（甚至一次连接只能交互4次，除去一次来获取flag，只能交互三次，下一次连接就生成新的Toy_AE对象，生成新的key了）导致漏洞点大概率不会出现在这个task文件中，，那就要找这个Toy_AE算法的洞了。（啊，好长，不想看）</p>
<p>一点点啃叭，先大致随便看看，然后我们有目的性的先来看看生成Auth的过程。（单独拎出来会清晰些）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">组数为偶数</span><span class="err">：</span>
</span></span><span class="line"><span class="cl">	<span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">	<span class="n">Cm</span>  <span class="o">=</span>  <span class="n">strxor</span><span class="p">(</span><span class="n">Z</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">strxor</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">Cm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">TE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">multer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">TE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">multer</span><span class="p">))</span>
</span></span></code></pre></div><p>可以看到，如果组数为偶数，就会多生成一个Z，而且生成的密文方式也会比较麻烦，那么我们就先利用那个附加信息来控制组数，尽量避免这个麻烦的东西。</p>
<p>这样子的话Sigma第2块、第4块明文、填充后的第5块明文的异或，然后和multer</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">multer</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">multer</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GF2_mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span><span class="p">))</span>
</span></span></code></pre></div><p>（multer和L有关，不可知，那就不管了）异或，最后AES加密，返回密文。</p>
<p>由于AES的key也不可知，所以我们想要拿到Auth，没别的方法了。只能在传明文获取Auth时，让我们的msg的第二块和第四块和第五块和真正的能拿到FLAG的msg的明文保持一致了。</p>
<p>这里一个做法就是，本地跑这个程序，把那些麻烦的PoW啥的去去掉，一些限制（比如用户名不能是Administrator）也去去掉，然后打印一些方便我们审计的信息，（当然，熟用那种自带debug编译器的大佬可以忽略，IDLE选手还是比较喜欢print debug大法）</p>
<p>那就是怎么伪造密文了。</p>
<p>先看看密文的生成</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">C1</span><span class="p">,</span> <span class="n">C2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feistel_enc_2r</span><span class="p">(</span><span class="n">M_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">M_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">feistel_enc_2r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">C1</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)),</span> <span class="n">M2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">C2</span> <span class="o">=</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">strxor</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span> <span class="n">strxor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">))),</span> <span class="n">M1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span>
</span></span></code></pre></div><p>我们把明文和密文看成16字节一块，两块一组，两块明文对自己这组生成的密文有影响，但每组明文间的加密是独立的。也就是第一组（第一二块）明文不影响第二组（第三四块）明文生成的第二块密文。</p>
<p>那么，如果我们的uid是1，用户名是Administrator，cmd是Give_Me_Flag，不加信息，</p>
<p>（本地起这个程序，把用户名和cmd的限制给取消掉，然后打印一下M_list）</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/eR1q9kg6OMVJhfZ.png" alt="image-20201102204318891" />
    
  </figure>

</p>
<p>image-20201102204318891</p>
<p>我们会生成4块明文，<code>[b'Uid=1\xffUserName=A', b'dministrator\xffT=e', b'7d3e769\xffCmd=Give', b'_Me_Flag\xff']</code></p>
<p>前面说了，为了让生成的Auth便于计算，我们要加入附加信息（Appendix）来控制明文组数。</p>
<p>但这里先看看M_list叭，如果我们想要得到Auth，那么我们就得保证我们构造的用户名和cmd在不等于限定值的情况下，M_list的第二组和第四组与用户名为Administrator和cmd为Give_Me_Flag时的M_list的相应分组相同。</p>
<p>这样子看过去，对于我们目前得到的这个M_list是很好构造的，由于Administrator的A在第一组，那么我们注册Bdministrator；由于Give_Me_Flag的Give在第三组，那么我们注册give_Me_Flag就好了。然后加一加Appendix控制下组数。但是注意到第二组最后一位是sha256的首位，而我们要是动了用户名，这个值大概率也有变，所以我们还得控制这个用户名的首位，可能不能是B，我们就在ascii 为0到128之间找一个字符*，让*dministrator的sha256的首位为e就可以了。经过测试，字符‘P’就是一个合适的值</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/tcLqimUel4NXygV.png" alt="image-20201102234733848" />
    
  </figure>

</p>
<p>image-20201102234733848</p>
<p>看，上面是目标Auth，下面是我们伪造的用户名和cmd获取的Auth，他们是一致的。所以Auth这一关过了。那就只剩下密文的伪造了。</p>
<p>对于第一组，是由uid和用户名决定的。其中uid不用伪造，问题不大，但是用户名的密文咋办，我们用户名不能等于Administrator，但是又要搞到的Administrator的密文。</p>
<p>这里用到的第一技巧就是，增加uid的长度，反正uid最后模16了，我们控制uid长度为5，用户名为Administratorr（多了一个r），这样子对照一下，</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/mdSovXRN5ZuQqgF.png" alt="image-20201102235135632" />
    
  </figure>

</p>
<p>image-20201102235135632</p>
<p>可以发现，多出来的那个r正好被挤到第三组去了，这样子我们的用户名既没有等于Administrator，但是又获得了前两块属于Administrator的msg的密文。</p>
<p>ok。一半的工作完成。</p>
<p>第二组，由于uid那么构造了，那么第二组明文就是这样子的，<code>b'r\xffT=ab86207b\xffCmd', b'=Give_Me_Flag\xff</code>由hash和cmd和组成（这里只是测试，附加信息就先不加了）。</p>
<p>这里我们要的是cmd=Give_Me_Flag的密文，怎么伪造cmd呢？我们不能改变任何一个字符，不然由于AES的存在，密文整个就不一样了。但是输入的cmd又不能等于Give_Me_Flag。这里我们还是用前面的方法，由于这里分组加密的特性，我们把cmd顶到第二块的末尾，大概就是让第二组的第二块明文是这样子，</p>
<pre tabindex="0"><code>&#39;Cmd=Give_Me_Flag&#39;
</code></pre><p>刚好16个字节，然后我们的命令就可以改成Give_Me_Flagg，多的g到第五块去了，咱们就不用管了。至于怎么顶，这里就要利用uid了，在uid长度仍然保持为5的情况下，进行加减，控制hash的长度为12就好了，11111%16 = 7，那就用11116，</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/18/rUZ1TbpSFjdhQKk.png" alt="image-20201218133935540" />
    
  </figure>

</p>
<p>image-20201218133935540</p>
<p>可以看到这样<code>\xffT=4110a98d23fc\xff</code>刚好占满了第二组第一块的16字节，<code>'Cmd=Give_Me_Flag</code>占了另一块。而我们输入的cmd命令是Give_Me_Flagg，是能过验证的。这样交互，让他加密，就能得到明文：<code>b'\xffT=4110a98d23fc\xff', b'Cmd=Give_Me_Flag'</code>生成的密文了。但是这里还有个问题，hash由用户名控制，用户名为Administrator的12位hash是e7d3e769f3f5，然而我们又不能注册用户为Administrator，那一个想法就是，碰撞，找一个由可见字符串组成的13位字符串（Administrator的长度），sha256后前12位为e7d3e769f3f5就可以了。然而这显然不现实，12位是96bit，有这算力，比特币不是随便挖？所以这题有解的一个原因就是，这个系统并没有验证用户名的hash，所以你随便整个用户名就好(我们这里就用的Administratos)。</p>
<p>但是新问题产生了，Auth的获取怎么办？现在我们的uid=11116，我们来看看用户名为Administrator，cmd为Give_Me_Flag的情况</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/mUTV2yFdIfXDirY.png" alt="image-20201103001239680" />
    
  </figure>

</p>
<p>image-20201103001239680</p>
<p>想要得到Auth，就得构造同样的第二块、第四块明文，第二块明文还好说，用户名我们多打一个字符就能绕过检查了，而这个字符也会被顶到第三块，对Auth没有影响，并且我们也可以uid相应的减1，让第四块密文不受到影响。但是第四块的明文本身就不好操作啊，这里要是也多打一个字符绕过的话，第五组就多了一个字符，这样产生的Auth就完全对不上了。</p>
<p>所以要把证获取到正确的Auth，我们需要第二块，第四块，第五块分别为：<code>b'me=Administrator', b'Cmd=Give_Me_Flag', b'\xff'</code></p>
<p>这里我的做法是，缩短uid为两位长，构造用户名为：me=Administrator，控制uid%16为8，构造cmd为Cmd=Give_Me_Flag</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="https://i.loli.net/2020/12/17/AZqsFpIwMEDCQlT.png" alt="image-20201103002724699" />
    
  </figure>

</p>
<p>image-20201103002724699</p>
<p>可以看到是完全一致的。如果此时打印出来了C_list的话，也会发现，此时这两组产生的C_list的最后一组也是一致的，因为我们这里M_list的到数两组是一致的。</p>
<div id="解题流程-3" class="anchor"></div>
<h4 class="relative group">解题流程 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e8%a7%a3%e9%a2%98%e6%b5%81%e7%a8%8b-3" aria-label="Anchor">#</a></span>        
    
</h4>
<p>所以这道题的整个解题流程：（交互可以直接手撸）</p>
<ol>
<li>uid：24，name：me=Administrator，cmd：Cmd=Give_Me_Flag 获取Auth和第三段密文</li>
<li>uid：11116，name：me=Administratorr，后面随意 获取第一段密文</li>
<li>uid：11116，name：Administratos，cmd：Give_Me_Flagg 获取第二段密文</li>
<li>发送Auth和三段密文的拼接，获取flag</li>
</ol>
<p>exp</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;123.57.4.93&#34;</span><span class="p">,</span><span class="s2">&#34;45216&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwnlib.util.iters</span> <span class="kn">import</span> <span class="n">mbruteforce</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">proof_of_work</span><span class="p">(</span><span class="n">sh</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;XXXX+b</span><span class="se">\&#39;</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">suffix</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\&#39;</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf8&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;== b</span><span class="se">\&#39;</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cipher</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\&#39;</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf8&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">proof</span> <span class="o">=</span> <span class="n">mbruteforce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sha256</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span>  <span class="n">cipher</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Give me XXXX:&#34;</span><span class="p">,</span> <span class="n">proof</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">proof_of_work</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;option:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;id:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;24&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;name:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;me=Administrator&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;and:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Cmd=Give_Me_Flag&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ket:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ticket</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Auth:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Auth</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;option:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;id:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;65548&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;name:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Administratorr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;and:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Give_Me_Flagg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ket:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ticket1</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;option:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;id:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;65548&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;name:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Administratos&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;and:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Give_Me_Flagg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ket:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ticket2</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;option:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Ticket:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">ticket1</span><span class="p">[:</span><span class="mi">64</span><span class="p">]</span><span class="o">+</span><span class="n">ticket2</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">64</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">ticket</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Auth:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">Auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><div id="2021-antctf-x-d3ctf" class="anchor"></div>
<h2 class="relative group">2021 AntCTF x D^3CTF 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#2021-antctf-x-d3ctf" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="babylattice" class="anchor"></div>
<h3 class="relative group">babyLattice 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#babylattice" aria-label="Anchor">#</a></span>        
    
</h3>
<div id="题目分析" class="anchor"></div>
<h4 class="relative group">题目分析 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e9%a2%98%e7%9b%ae%e5%88%86%e6%9e%90" aria-label="Anchor">#</a></span>        
    
</h4>
<p>这道题的题目如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PublicKey</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;PublicKey&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">SecretKey</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SecretKey&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gen_key</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">512</span><span class="p">,</span> <span class="n">lbound</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="mi">511</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">512</span><span class="p">,</span> <span class="n">lbound</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="mi">511</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">a11</span><span class="p">,</span> <span class="n">a12</span><span class="p">,</span> <span class="n">a21</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">100</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">a22</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">a11</span> <span class="o">*</span> <span class="n">a22</span> <span class="o">==</span> <span class="n">a12</span> <span class="o">*</span> <span class="n">a21</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">a22</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="p">[[</span><span class="n">a11</span><span class="p">,</span> <span class="n">a12</span><span class="p">],</span> <span class="p">[</span><span class="n">a21</span><span class="p">,</span> <span class="n">a22</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">a1</span> <span class="o">=</span> <span class="n">crt</span><span class="p">([</span><span class="n">a11</span><span class="p">,</span> <span class="n">a21</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">a2</span> <span class="o">=</span> <span class="n">crt</span><span class="p">([</span><span class="n">a12</span><span class="p">,</span> <span class="n">a22</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PK</span> <span class="o">=</span> <span class="n">PublicKey</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">SK</span> <span class="o">=</span> <span class="n">SecretKey</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">PK</span><span class="p">,</span> <span class="n">SK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">^</span><span class="mi">400</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">^</span><span class="mi">400</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">b</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">%</span> <span class="n">pk</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">a2</span> <span class="o">=</span> <span class="n">crt</span><span class="p">([</span><span class="n">sk</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sk</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">sk</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">sk</span><span class="o">.</span><span class="n">q</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">c</span> <span class="o">%</span> <span class="n">sk</span><span class="o">.</span><span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">c</span> <span class="o">%</span> <span class="n">sk</span><span class="o">.</span><span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">vector</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">^</span><span class="mi">400</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mm</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">m</span> <span class="o">==</span> <span class="n">mm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">m</span><span class="p">,</span> <span class="n">FLAG</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">FLAG</span> <span class="o">==</span> <span class="s1">&#39;d3ctf&#39;</span> <span class="o">%</span> <span class="n">sha256</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PK</span><span class="p">,</span> <span class="n">SK</span> <span class="o">=</span> <span class="n">gen_key</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">test</span><span class="p">(</span><span class="n">PK</span><span class="p">,</span> <span class="n">SK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">PK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;PK = </span><span class="si">{</span><span class="n">PK</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;c = </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>我们重点看看加密函数</p>
<p><a href="https://p0.ssl.qhimg.com/t01d9e10873c2c29883.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p0.ssl.qhimg.com/t01d9e10873c2c29883.png" alt="img" />
    
  </figure>

</a></p>
<p>也就是</p>
<p><a href="https://p0.ssl.qhimg.com/t0184488fd05302f218.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p0.ssl.qhimg.com/t0184488fd05302f218.png" alt="img" />
    
  </figure>

</a></p>
<p><a href="https://p5.ssl.qhimg.com/t01584cb03a9efa06fa.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p5.ssl.qhimg.com/t01584cb03a9efa06fa.png" alt="img" />
    
  </figure>

</a></p>
<p>这样就可以通过<code>LLL</code>算法还原出<code>m</code>了</p>
<div id="exp" class="anchor"></div>
<h4 class="relative group">EXP 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#exp" aria-label="Anchor">#</a></span>        
    
</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">69804507328197961654128697510310109608046244030437362639637009184945533884294737870524186521509776189989451383438084507903660182212556466321058025788319193059894825570785105388123718921480698851551024108844782091117408753782599961943040695892323702361910107399806150571836786642746371968124465646209366215361</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="mi">65473938578022920848984901484624361251869406821863616908777213906525858437236185832214198627510663632409869363143982594947164139220013904654196960829350642413348771918422220404777505345053202159200378935309593802916875681436442734667249049535670986673774487031873808527230023029662915806344014429627710399196</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="mi">64666354938466194052720591810783769030566504653409465121173331362654665231573809234913985758725048071311571549777481776826624728742086174609897160897118750243192791021577348181130302572185911750797457793921069473730039225991755755340927506766395262125949939309337338656431876690470938261261164556850871338570</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">^</span><span class="mi">400</span><span class="p">,</span><span class="n">c</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">LLL</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;d3ctf&#39;</span> <span class="o">%</span> <span class="n">sha256</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><div id="simplegroup" class="anchor"></div>
<h3 class="relative group">simpleGroup 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#simplegroup" aria-label="Anchor">#</a></span>        
    
</h3>
<div id="题目分析-1" class="anchor"></div>
<h4 class="relative group">题目分析 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e9%a2%98%e7%9b%ae%e5%88%86%e6%9e%90-1" aria-label="Anchor">#</a></span>        
    
</h4>
<p>这道题的题目如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">FLAG</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># A gift for key recovery in challenge [babyLattice]</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">69804507328197961654128697510310109608046244030437362639637009184945533884294737870524186521509776189989451383438084507903660182212556466321058025788319193059894825570785105388123718921480698851551024108844782091117408753782599961943040695892323702361910107399806150571836786642746371968124465646209366215361</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="mi">12064801545723347322936991186738560311049061235541031580807549422258814170771738262264930441670708308259694588963224372530498305648578520552038029773849342206125074212912788823834152785756697757209804475031974445963691941515756901268376267360542656449669715367587909233618109269372332127072063171947435639328</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="mi">1928983487</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">FLAG</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">C</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">M</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">M</span> <span class="o">%</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">    <span class="n">M</span> <span class="o">//=</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">power_mod</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">power_mod</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;C = </span><span class="si">{</span><span class="n">C</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>通过注释我们可以大概猜测<code>babyLattice</code>本来是需要分解<code>n</code>的，但是因为被非预期了所以又出了这道题目</p>
<p>那么我们回到<code>babyLattice</code>题目里面，我们知道的参数实际上只有<code>b,c,n</code>，分解<code>n</code>应该和<code>b</code>有关，通过阅读<code>b</code>的生成代码我们可以得到</p>
<p><a href="https://p1.ssl.qhimg.com/t0171c5a2a0fc57e8a0.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p1.ssl.qhimg.com/t0171c5a2a0fc57e8a0.png" alt="img" />
    
  </figure>

</a></p>
<p>我们展开后两个式子</p>
<p><a href="https://p4.ssl.qhimg.com/t01726dd64e2c27cd6c.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p4.ssl.qhimg.com/t01726dd64e2c27cd6c.png" alt="img" />
    
  </figure>

</a></p>
<p>也就是</p>
<p><a href="https://p4.ssl.qhimg.com/t013847b039226ba9e6.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p4.ssl.qhimg.com/t013847b039226ba9e6.png" alt="img" />
    
  </figure>

</a></p>
<p>两边相乘得到</p>
<p><a href="https://p5.ssl.qhimg.com/t01240d7bc397c64ff0.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p5.ssl.qhimg.com/t01240d7bc397c64ff0.png" alt="img" />
    
  </figure>

</a></p>
<p>展开并变形得到</p>
<p><a href="https://p2.ssl.qhimg.com/t01fb817e9efea9b5eb.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p2.ssl.qhimg.com/t01fb817e9efea9b5eb.png" alt="img" />
    
  </figure>

</a></p>
<p>也就是</p>
<p><a href="https://p5.ssl.qhimg.com/t019fb34cbfc6df8174.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p5.ssl.qhimg.com/t019fb34cbfc6df8174.png" alt="img" />
    
  </figure>

</a></p>
<p>由于</p>
<p><a href="https://p3.ssl.qhimg.com/t0116814e877a172c25.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p3.ssl.qhimg.com/t0116814e877a172c25.png" alt="img" />
    
  </figure>

</a></p>
<p>所以我们同样可以用<code>LLL</code>还原出目标向量，然后使用<code>factor</code>进行分解（<code>a11,a12,a21,a22</code>它们都是素数）</p>
<p>当分解完毕后，通过猜测它们对应的值来分解<code>n</code>，即</p>
<p><a href="https://p2.ssl.qhimg.com/t0175cc67e3c791b2b8.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p2.ssl.qhimg.com/t0175cc67e3c791b2b8.png" alt="img" />
    
  </figure>

</a></p>
<p>得到<code>p,q</code>后，我们回来看题目里面的加密，其会对<code>FLAG</code>进行取模并分段加密余数，其中<code>c</code>的生成公式如下</p>
<p><a href="https://p4.ssl.qhimg.com/t01c7cb6a1b6d37d312.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p4.ssl.qhimg.com/t01c7cb6a1b6d37d312.png" alt="img" />
    
  </figure>

</a></p>
<p><code>r</code>是随机生成的数字，而<code>e</code>可以被分解为<code>e1</code>和<code>e2</code>两个素数，这两个素数又分别是<code>p-1</code>和<code>q-1</code>的因子</p>
<p>那么我们可以得到</p>
<p><a href="https://p0.ssl.qhimg.com/t01b7f7bbc609af8da3.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p0.ssl.qhimg.com/t01b7f7bbc609af8da3.png" alt="img" />
    
  </figure>

</a></p>
<p>通过遍历<code>j</code>并判断得到的<code>c'</code>是不是为模<code>p</code>的<code>e1次剩余</code>，我们就可以得到<code>m</code>模<code>e1</code>的值</p>
<p>同样我们也可以用<code>q</code>得到<code>m</code>模<code>e2</code>的值，然后使用<code>中国剩余定理</code>即可还原<code>m</code>并最终得到<code>flag</code></p>
<div id="exp-1" class="anchor"></div>
<h4 class="relative group">EXP 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#exp-1" aria-label="Anchor">#</a></span>        
    
</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">69804507328197961654128697510310109608046244030437362639637009184945533884294737870524186521509776189989451383438084507903660182212556466321058025788319193059894825570785105388123718921480698851551024108844782091117408753782599961943040695892323702361910107399806150571836786642746371968124465646209366215361</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="mi">65473938578022920848984901484624361251869406821863616908777213906525858437236185832214198627510663632409869363143982594947164139220013904654196960829350642413348771918422220404777505345053202159200378935309593802916875681436442734667249049535670986673774487031873808527230023029662915806344014429627710399196</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="mi">64666354938466194052720591810783769030566504653409465121173331362654665231573809234913985758725048071311571549777481776826624728742086174609897160897118750243192791021577348181130302572185911750797457793921069473730039225991755755340927506766395262125949939309337338656431876690470938261261164556850871338570</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="o">^</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">LLL</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x1</span> <span class="o">=</span> <span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">factor</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">factor</span><span class="p">(</span><span class="n">x3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a12</span> <span class="o">=</span> <span class="mi">1018979931854255696816714991181</span>
</span></span><span class="line"><span class="cl"><span class="n">a22</span> <span class="o">=</span> <span class="mi">1151291153120610849180830073509</span>
</span></span><span class="line"><span class="cl"><span class="n">a11</span> <span class="o">=</span> <span class="mi">1017199123798810531137951821909</span>
</span></span><span class="line"><span class="cl"><span class="n">a21</span> <span class="o">=</span> <span class="mi">207806651167586080788016046729</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">gcd</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">a12</span> <span class="o">-</span> <span class="n">a11</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">gcd</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">a22</span> <span class="o">-</span> <span class="n">a21</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">7669036313101194621345265255994200133006921565596653797956940811601516306410232120057637504305295677357422367597831138570269733177579895994340511712373309</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="mi">9102122415165681824420871673621781250311822805618731863628192549895693024247220594372897360668046264863189831887100676431439200352775676467952192600956629</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">q</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">gmpy2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">7669036313101194621345265255994200133006921565596653797956940811601516306410232120057637504305295677357422367597831138570269733177579895994340511712373309</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="mi">9102122415165681824420871673621781250311822805618731863628192549895693024247220594372897360668046264863189831887100676431439200352775676467952192600956629</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">69804507328197961654128697510310109608046244030437362639637009184945533884294737870524186521509776189989451383438084507903660182212556466321058025788319193059894825570785105388123718921480698851551024108844782091117408753782599961943040695892323702361910107399806150571836786642746371968124465646209366215361</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="mi">12064801545723347322936991186738560311049061235541031580807549422258814170771738262264930441670708308259694588963224372530498305648578520552038029773849342206125074212912788823834152785756697757209804475031974445963691941515756901268376267360542656449669715367587909233618109269372332127072063171947435639328</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="mi">1928983487</span>
</span></span><span class="line"><span class="cl"><span class="n">e1</span> <span class="o">=</span> <span class="mi">36493</span>
</span></span><span class="line"><span class="cl"><span class="n">e2</span> <span class="o">=</span> <span class="mi">52859</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GCRT</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">ai</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">curm</span><span class="p">,</span> <span class="n">cura</span> <span class="o">=</span> <span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ai</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">curm</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">cura</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="p">(</span><span class="n">c</span> <span class="o">%</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">K</span> <span class="o">=</span> <span class="n">c</span> <span class="o">//</span> <span class="n">d</span> <span class="o">*</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">curm</span> <span class="o">//</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span> <span class="o">//</span> <span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cura</span> <span class="o">+=</span> <span class="n">curm</span> <span class="o">*</span> <span class="n">K</span>
</span></span><span class="line"><span class="cl">        <span class="n">curm</span> <span class="o">=</span> <span class="n">curm</span> <span class="o">*</span> <span class="n">m</span> <span class="o">//</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">        <span class="n">cura</span> <span class="o">%=</span> <span class="n">curm</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">cura</span> <span class="o">%</span> <span class="n">curm</span><span class="p">,</span> <span class="n">curm</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">d</span><span class="p">,(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">d</span><span class="p">,(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">k</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getM</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">e</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmpc</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">),</span><span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="n">tmpc</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">e</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="mi">63173987757788284988620600191109581820396865828379773315280703314093571300861961873159324234626635582246705378908610341772657840682572386153960342976445563045427986000105931341168525422286612417662391801508953619857648844420751306271090777865836201978470895906780036112804110135446130976275516908136806153488</span><span class="p">,</span> <span class="mi">9763526786754236516067080717710975805995955013877681492195771779269768465872108434027813610978940562101906769209984501196515248675767910499405415921162131390513502065270491854965819776080041506584540996447044249409209699608342257964093713589580983775580171905489797513718769578177025063630080394722500351718</span><span class="p">,</span> <span class="mi">37602000735227732258462226884765737048138920479521815995321941033382094711120810035265327876995207117707635304728511052367297062940325564085193593024741832905771507189762521426736369667607865137900432117426385504101413622851293642219573920971637080154905579082646915297543490131171875075081464735374022745371</span><span class="p">,</span> <span class="mi">1072671768043618032698040622345664216689606325179075270470875647188092538287671951027561894188700732117175202207361845034630743422559130952899064461493359903596018309221581071025635286144053941851624510600383725195476917014535032481197737938329722082022363122585603600777143850326268988298415885565240343957</span><span class="p">,</span> <span class="mi">27796821408982345007197248748277202310092789604135169328103109167649193262824176309353412519763498156841477483757818317945381469765077400076181689745139555466187324921460327576193198145058918081061285618767976454153221256648341316332169223400180283361166887912012807743326710962143011946929516083281306203120</span><span class="p">,</span> <span class="mi">27578857139265869760149251280906035333246393024444009493717159606257881466594628022512140403127178174789296810502616834123420723261733024810610501421455454191654733275226507268803879479462533730695515454997186867769363797096196096976825300792616487723840475500246639213793315097434400920355043141319680299224</span><span class="p">,</span> <span class="mi">29771574667682104634602808909981269404867338382394257360936831559517858873826664867201410081659799334286847985842898792091629138292008512383903137248343194156307703071975381090326280520578349920827357328925184297610245746674712939135025013001878893129144027068837197196517160934998930493581708256039240833145</span><span class="p">,</span> <span class="mi">33576194603243117173665354646070700520263517823066685882273435337247665798346350495639466826097821472152582124503891668755684596123245873216775681469053052037610568862670212856073776960384038120245095140019195900547005026888186973915360493993404372991791346105083429461661784366706770467146420310246467262823</span><span class="p">,</span> <span class="mi">5843375768465467361166168452576092245582688894123491517095586796557653258335684018047406320846455642101431751502161722135934408574660609773328141061123577914919960794180555848119813522996120885320995386856042271846703291295871836092712205058173403525430851695443361660808933971009396237274706384697230238104</span><span class="p">,</span> <span class="mi">61258574367240969784057122450219123953816453759807167817741267194076389100252707986788076240792732730306129067314036402554937862139293741371969020708475839483175856346263848768229357814022084723576192520349994310793246498385086373753553311071932502861084141758640546428958475211765697766922596613007928849964</span><span class="p">,</span> <span class="mi">13558124437758868592198924133563305430225927636261069774349770018130041045454468021737709434182703704611453555980636131119350668691330635012675418568518296882257236341035371057355328669188453984172750580977924222375208440790994249194313841200024395796760938258751149376135149958855550611392962977597279393428</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">cp</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="n">cq</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="n">m1</span> <span class="o">=</span> <span class="n">getM</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span><span class="n">e1</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m2</span> <span class="o">=</span> <span class="n">getM</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span><span class="n">e2</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mm</span><span class="p">,</span><span class="n">lcm</span> <span class="o">=</span> <span class="n">GCRT</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">],[</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Get mm: &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mm</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">*=</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">+=</span> <span class="n">mm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><div id="easycurve" class="anchor"></div>
<h3 class="relative group">EasyCurve 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#easycurve" aria-label="Anchor">#</a></span>        
    
</h3>
<div id="题目分析-2" class="anchor"></div>
<h4 class="relative group">题目分析 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e9%a2%98%e7%9b%ae%e5%88%86%e6%9e%90-2" aria-label="Anchor">#</a></span>        
    
</h4>
<p>这道题目的主要部分如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socketserver</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span> <span class="p">,</span> <span class="n">bytes_to_long</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Curve</span> <span class="kn">import</span> <span class="n">MyCurve</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">signal</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BIT</span> <span class="o">=</span> <span class="mi">2048</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">9688074905643914060390149833064012354277254244638141162997888145741631958242340092013958501673928921327767591959476890238698855704376126231923819603296257</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">proof_of_work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">proof</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">        <span class="n">_hexdigest</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">proof</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;sha256(XXXX+</span><span class="si">{</span><span class="n">proof</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">_hexdigest</span><span class="si">}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Give me XXXX: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">sha256</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">proof</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_hexdigest</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;wrong&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span> <span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">key_gen</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">bit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">ot</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">point</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
</span></span><span class="line"><span class="cl">        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_gen</span><span class="p">(</span><span class="n">BIT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;n = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;e = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">x0</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;x0 = &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;x1 = &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;v = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">m0_</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">n</span><span class="p">))</span> <span class="o">%</span> <span class="n">key</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="n">m1_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">n</span><span class="p">))</span> <span class="o">%</span> <span class="n">key</span><span class="o">.</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;m0_ = &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m0_</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;m1_ = &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m1_</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proof_of_work</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">u</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">curve</span> <span class="o">=</span> <span class="n">MyCurve</span><span class="p">(</span><span class="n">p</span> <span class="p">,</span> <span class="n">D</span> <span class="p">,</span> <span class="n">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;p = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;D = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">G</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">getPoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">ot</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">P</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">e</span> <span class="p">,</span> <span class="n">G</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">ot</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;do you know my e?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;oh no!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;Ha, I know you can&#39;t get it.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ForkedServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ForkingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="n">ForkedServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">Task</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></span></code></pre></div><p>其使用了一个随机生成参数的<code>MyCurve</code>并生成了随机的<code>e</code>，给我们三次交互的机会，每次交互会随机生成点<code>G</code>和点<code>P</code>并使用<code>OT</code>将这两个点的信息传递给我们，点<code>P</code>是<code>e</code>倍的点<code>G</code>，当我们给服务器正确的<code>e</code>的时候我们可以得到<code>flag</code></p>
<p>这其实就是一个<code>离散对数问题</code>，我们首先关注服务器的参数，<code>MyCurve</code>所使用的<code>p</code>是<code>512</code>比特的，而<code>OT</code>中<code>RSA</code>的<code>n</code>是<code>2048</code>比特的，这样生成的点的<code>x</code>和<code>y</code>乘起来也没有<code>n</code>的大。那么可以参考2020hackergame的<a href="https://github.com/USTC-Hackergame/hackergame2020-writeups/blob/master/official/%e4%b8%8d%e7%bb%8f%e6%84%8f%e4%bc%a0%e8%be%93/README.md"   target="_blank">
    不经意传输</a>中的攻击方式来同时获取点的<code>x</code>和<code>y</code>坐标</p>
<p>之后便是如何通过点<code>G</code>和点<code>P</code>来获取<code>e</code>了，我们可以注意到<code>p-1</code>是光滑的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sage</span><span class="p">:</span> <span class="n">factor</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span><span class="o">^</span><span class="mi">21</span> <span class="o">*</span> <span class="mi">3</span><span class="o">^</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">7</span><span class="o">^</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">*</span> <span class="mi">13</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">17</span> <span class="o">*</span> <span class="mi">19</span> <span class="o">*</span> <span class="mi">29</span> <span class="o">*</span> <span class="mi">31</span> <span class="o">*</span> <span class="mi">37</span> <span class="o">*</span> <span class="mi">43</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">47</span> <span class="o">*</span> <span class="mi">71</span> <span class="o">*</span> <span class="mi">83</span> <span class="o">*</span> <span class="mi">89</span> <span class="o">*</span> <span class="mi">97</span> <span class="o">*</span> <span class="mi">223</span> <span class="o">*</span> <span class="mi">293</span> <span class="o">*</span> <span class="mi">587</span> <span class="o">*</span> <span class="mi">631</span> <span class="o">*</span> <span class="mi">709</span> <span class="o">*</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">1327</span> <span class="o">*</span> <span class="mi">1433</span> <span class="o">*</span> <span class="mi">1733</span> <span class="o">*</span> <span class="mi">1889</span> <span class="o">*</span> <span class="mi">2503</span> <span class="o">*</span> <span class="mi">3121</span> <span class="o">*</span> <span class="mi">6043</span> <span class="o">*</span> <span class="mi">6301</span> <span class="o">*</span> <span class="mi">49523</span> <span class="o">*</span> <span class="mi">98429</span> <span class="o">*</span> <span class="mi">140683</span> <span class="o">*</span> <span class="mi">205589</span> <span class="o">*</span> <span class="mi">1277369</span> <span class="o">*</span> <span class="mi">1635649</span> <span class="o">*</span> <span class="mi">5062909</span> <span class="o">*</span> <span class="mi">45698189</span> <span class="o">*</span> <span class="mi">67111151</span> <span class="o">*</span> <span class="mi">226584089</span> <span class="o">*</span> <span class="mi">342469397</span>
</span></span></code></pre></div><p>那么我们可以通过<a href="https://ctf-wiki.org/crypto/asymmetric/discrete-log/discrete-log/#pohlig-hellman-algorithm"   target="_blank">
    Pohlig-Hellman algorithm</a>来解决<code>离散对数问题</code>并最终得到flag</p>
<div id="exp-2" class="anchor"></div>
<h4 class="relative group">EXP 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#exp-2" aria-label="Anchor">#</a></span>        
    
</h4>
<p><code>exp</code>有概率成功，如果报错或者答案错误多跑几次即可</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">gmpy2</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dic</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">solvePow</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">a3</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">a4</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">x</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">+</span> <span class="n">a4</span>
</span></span><span class="line"><span class="cl">                    <span class="n">proof</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">prefix</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_hexdigest</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">proof</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">_hexdigest</span> <span class="o">==</span> <span class="n">h</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getData</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;n = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;e = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;x0 = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;x1 = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset_e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">v</span> <span class="o">=</span> <span class="p">((</span><span class="n">offset_e</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">offset_e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">%</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;v = &#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;m0_ = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;m1_ = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">m0</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">m</span> <span class="o">//</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.100.50.252&#34;</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;sha256(XXXX+&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">prefix</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;) == &#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">solvePow</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Give me XXXX: </span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;p = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;D = &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">D</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Gx</span><span class="p">,</span><span class="n">Gy</span> <span class="o">=</span> <span class="n">getData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Px</span><span class="p">,</span><span class="n">Py</span> <span class="o">=</span> <span class="n">getData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;data.txt&#34;</span><span class="p">,</span><span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Gx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Gy</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Px</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Py</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;sage&#34;</span><span class="p">,</span> <span class="s2">&#34;exp.sage&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># exp.sage</span>
</span></span><span class="line"><span class="cl"><span class="n">load</span><span class="p">(</span><span class="s2">&#34;Curve.sage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">9688074905643914060390149833064012354277254244638141162997888145741631958242340092013958501673928921327767591959476890238698855704376126231923819603296257</span>
</span></span><span class="line"><span class="cl"><span class="n">F</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fac</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">^</span><span class="mi">21</span><span class="p">,</span><span class="mi">3</span><span class="o">^</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="o">^</span><span class="mi">4</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">43</span><span class="o">^</span><span class="mi">3</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">71</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">223</span><span class="p">,</span><span class="mi">293</span><span class="p">,</span><span class="mi">587</span><span class="p">,</span><span class="mi">631</span><span class="p">,</span><span class="mi">709</span><span class="p">,</span><span class="mi">761</span><span class="p">,</span><span class="mi">1327</span><span class="p">,</span><span class="mi">1433</span><span class="p">,</span><span class="mi">1733</span><span class="p">,</span><span class="mi">1889</span><span class="p">,</span><span class="mi">2503</span><span class="p">,</span><span class="mi">3121</span><span class="p">,</span><span class="mi">6043</span><span class="p">,</span><span class="mi">6301</span><span class="p">,</span><span class="mi">49523</span><span class="p">,</span><span class="mi">98429</span><span class="p">,</span><span class="mi">140683</span><span class="p">,</span><span class="mi">205589</span><span class="p">,</span><span class="mi">1277369</span><span class="p">,</span><span class="mi">1635649</span><span class="p">,</span><span class="mi">5062909</span><span class="p">,</span><span class="mi">45698189</span><span class="p">,</span><span class="mi">67111151</span><span class="p">,</span><span class="mi">226584089</span><span class="p">,</span><span class="mi">342469397</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bsgs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">point</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">point</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pointg</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">800</span> <span class="o">|</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span><span class="p">[</span><span class="n">pointg</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">gs</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pointy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">800</span> <span class="o">|</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pointy</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">S</span><span class="p">[</span><span class="n">pointy</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">gs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">Pohlig_Hellman</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">P</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ea</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">na</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fac</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">fac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">        <span class="n">gi</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">yi</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ei</span> <span class="o">=</span> <span class="n">bsgs</span><span class="p">(</span><span class="n">gi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ea</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ei</span><span class="o">%</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">na</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ee</span> <span class="o">=</span> <span class="n">crt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">na</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ee</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;data.txt&#34;</span><span class="p">,</span><span class="s2">&#34;rb&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">D</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Gx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Gy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Py</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">G</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">Gx</span><span class="p">),</span><span class="n">F</span><span class="p">(</span><span class="n">Gy</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">Px</span><span class="p">),</span><span class="n">F</span><span class="p">(</span><span class="n">Py</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">u2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Gx</span> <span class="o">^</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Gy</span> <span class="o">^</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">u2</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">u</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">u2</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">curve</span> <span class="o">=</span> <span class="n">MyCurve</span><span class="p">(</span><span class="n">p</span> <span class="p">,</span> <span class="n">D</span> <span class="p">,</span> <span class="n">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">Pohlig_Hellman</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">%=</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span></code></pre></div><div id="alicewantflag" class="anchor"></div>
<h3 class="relative group">AliceWantFlag 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#alicewantflag" aria-label="Anchor">#</a></span>        
    
</h3>
<div id="题目分析-3" class="anchor"></div>
<h4 class="relative group">题目分析 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e9%a2%98%e7%9b%ae%e5%88%86%e6%9e%90-3" aria-label="Anchor">#</a></span>        
    
</h4>
<p>这道题目分为<code>server</code>端和<code>Alice</code>端，其中<code>server</code>端的代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">elgamal</span> <span class="kn">import</span> <span class="n">elgamal</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socketserver</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">prikey</span> <span class="kn">import</span> <span class="n">server_prikey</span> <span class="p">,</span> <span class="n">AlicePasswd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pubkey</span> <span class="kn">import</span> <span class="n">Alice_pubkey</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">Alice_flag</span> <span class="p">,</span> <span class="n">ctfer_flag</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">signal</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">urandom</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span> <span class="p">,</span> <span class="n">bytes_to_long</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MENU</span> <span class="o">=</span> <span class="s2">&#34;1. signup  2.signin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">XOR</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="p">:</span><span class="nb">bytes</span><span class="p">([</span><span class="n">x1</span><span class="o">^</span><span class="n">x2</span> <span class="k">for</span> <span class="n">x1</span> <span class="p">,</span> <span class="n">x2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">padlen</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="n">padlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span><span class="p">[:</span><span class="o">-</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">server</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pubkey</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">prikey</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">server_prikey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pubkey</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;Alice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">Alice_pubkey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;Alice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AlicePasswd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span> <span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enc_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">,</span> <span class="n">usrid</span> <span class="p">,</span> <span class="n">enc_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">enc_key</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pubenc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubkey</span><span class="p">[</span><span class="n">usrid</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">y1</span> <span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">pubenc</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">            <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">enc_key</span> <span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dec_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">enc_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">enc_key</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;, &#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prikey</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">            <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">enc_key</span> <span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">unpad</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;sorry, the number of users is out of limit&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;please give me your name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;your id can</span><span class="se">\&#39;</span><span class="s1">t be too long&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">userid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;the name has been used&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;please give me your passwd(encrypted)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">userpasswd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">userpasswd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;your password can</span><span class="se">\&#39;</span><span class="s1">t be too long&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">=</span> <span class="n">userpasswd</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;please give me your publickey&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">userpubkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">userpubkey</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">userpubkey</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;publickey format error&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">pubkey</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">userpubkey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;sign up success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">signin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;please give me your name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">userid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;sorry the userid is not existed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;please give me your passwd(encrypted and xored by r)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">userdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">userdata</span><span class="p">)</span> <span class="o">==</span> <span class="n">r</span> <span class="o">^</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">[</span><span class="n">userid</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;signin success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;password error&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">endkey</span> <span class="o">=</span> <span class="n">urandom</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">userdata</span> <span class="o">+</span> <span class="n">endkey</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;now let</span><span class="se">\&#39;</span><span class="s1">s communicate with this key&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">enc_send</span><span class="p">(</span><span class="n">endkey</span> <span class="p">,</span> <span class="n">userid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">userid</span> <span class="p">,</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">userid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">MENU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">signup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">userid</span> <span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">temp</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_recv</span><span class="p">(</span><span class="n">enc_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;I am a ctfer.Please give me flag&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">enc_send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ok, your flag is here &#39;</span> <span class="o">+</span> <span class="n">ctfer_flag</span> <span class="p">,</span> <span class="n">userid</span> <span class="p">,</span> <span class="n">enc_key</span><span class="o">=</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;I am Alice, Please give me true flag&#39;</span> <span class="ow">and</span> <span class="n">userid</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;Alice&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">enc_send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hi Alice, your flag is &#39;</span> <span class="o">+</span> <span class="n">Alice_flag</span> <span class="p">,</span> <span class="n">userid</span> <span class="p">,</span> <span class="n">enc_key</span><span class="o">=</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ForkedServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ForkingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">10001</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="n">ForkedServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></span></code></pre></div><p><code>Alice</code>端的代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">elgamal</span> <span class="kn">import</span> <span class="n">elgamal</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pubkey</span> <span class="kn">import</span> <span class="n">server_pubkey</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">prikey</span> <span class="kn">import</span> <span class="n">Alice_prikey</span> <span class="p">,</span> <span class="n">AlicePasswd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span> <span class="p">,</span> <span class="n">bytes_to_long</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socketserver</span> <span class="o">,</span> <span class="nn">signal</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span><span class="p">[:</span><span class="o">-</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Alice</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">ip</span> <span class="p">,</span> <span class="n">port</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pridec</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">Alice_prikey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pubenc</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">server_pubkey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span> <span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enc_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">,</span> <span class="n">enc_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">enc_key</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">y1</span> <span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubenc</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">            <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">enc_key</span> <span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dec_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">enc_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">enc_key</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;, &#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pridec</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">            <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">enc_key</span> <span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">unpad</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">firstmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">firstmsg</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;1. signup  2.signin&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">userdata</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">AlicePasswd</span><span class="p">)</span> <span class="o">^</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">enc_send</span><span class="p">(</span><span class="n">userdata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">endkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">userdata</span> <span class="o">+</span> <span class="n">endkey</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">enc_send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;I am a ctfer.Please give me flag&#39;</span> <span class="p">,</span> <span class="n">enc_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_recv</span><span class="p">(</span><span class="n">enc_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span> <span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;Hello, I am Alice, can you tell me the address of the server?</span><span class="se">\n</span><span class="s1">In return, I will give you the ctf_flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">10001</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">Alice</span><span class="p">(</span><span class="n">ip</span> <span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Thanks, here is your flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ForkedServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ForkingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">10003</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span> <span class="o">=</span> <span class="n">ForkedServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">Task</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></span></code></pre></div><p><code>server</code>和<code>Alice</code>的密钥生成和使用都和<code>elgamal算法</code>一致，这里不再阐述</p>
<p>服务端的大概逻辑如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">U</span><span class="p">:</span> <span class="n">User</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span><span class="p">:</span> <span class="n">Server</span>
</span></span><span class="line"><span class="cl"><span class="n">UserPasswd</span> <span class="o">=</span> <span class="n">UserPublicKey</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Sign</span> <span class="n">Up</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="s1">&#39;please give me your name&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">U</span> <span class="o">-&gt;</span> <span class="n">S</span> <span class="p">:</span> <span class="n">userid</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">userid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">passwd</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="s1">&#39;please give me your passwd(encrypted)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">U</span> <span class="o">-&gt;</span> <span class="n">S</span> <span class="p">:</span> <span class="n">c</span> <span class="o">=</span> <span class="n">elgamal</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">UserPasswd</span><span class="p">,</span><span class="n">ServerPublicKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="n">userpasswd</span> <span class="o">=</span> <span class="n">elgamal</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ServerPrivateKey</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">userpasswd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">11</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="n">passwd</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">=</span> <span class="n">userpasswd</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="s1">&#39;sign up success&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Sign</span> <span class="n">In</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="s1">&#39;please give me your name&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">U</span> <span class="o">-&gt;</span> <span class="n">S</span> <span class="p">:</span> <span class="n">userid</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="k">assert</span> <span class="n">userid</span> <span class="ow">in</span> <span class="n">passwd</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="s1">&#39;please give me your passwd(encrypted and xored by r)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">U</span> <span class="o">-&gt;</span> <span class="n">S</span> <span class="p">:</span> <span class="n">c</span> <span class="o">=</span> <span class="n">elgamal</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">UserPasswd</span> <span class="o">^</span> <span class="n">r</span><span class="p">,</span><span class="n">ServerPublicKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="k">assert</span> <span class="n">elgamal</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">ServerPrivateKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">passwd</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">^</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="n">key</span> <span class="o">=</span> <span class="n">userdata</span> <span class="o">+</span> <span class="n">endkey</span><span class="p">,</span> <span class="n">userdata</span> <span class="o">=</span> <span class="n">passwd</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">^</span> <span class="n">r</span><span class="p">,</span> <span class="n">endkey</span> <span class="o">=</span> <span class="n">urandom</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="s1">&#39;now let</span><span class="se">\&#39;</span><span class="s1">s communicate with this key&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="n">k</span> <span class="o">=</span> <span class="n">elgamal</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">UserPasswd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">U</span> <span class="o">-&gt;</span> <span class="n">S</span> <span class="p">:</span> <span class="n">m</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="k">if</span> <span class="n">dm</span> <span class="o">==</span> <span class="s1">&#39;I am a ctfer.Please give me flag&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">ctfer_flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">S</span> <span class="p">:</span> <span class="k">if</span> <span class="n">dm</span> <span class="o">==</span> <span class="s1">&#39;I am Alice, Please give me true flag&#39;</span> <span class="ow">and</span> <span class="n">userid</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">-&gt;</span> <span class="n">U</span> <span class="p">:</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">Alice_flag</span><span class="p">)</span>
</span></span></code></pre></div><p>大概理解下来就是一个利用<code>elgamal</code>进行密钥交换然后加密通信的逻辑</p>
<p>由于这里我们需要以<code>Alice</code>的身份登陆并使用交换的<code>AES通信密钥</code>进行密文的加密，所以我们需要知道<code>AlicePasswd</code>和<code>key</code></p>
<p>这道题目中由于也有<code>Alice</code>端的服务，所以我们可以伪装成服务端来和<code>Alice</code>端进行通信，也就是进行<code>中间人攻击</code></p>
<p>首先来看看如何获得<code>AlicePasswd</code>，观察<code>Alice</code>端的如下代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">firstmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">firstmsg</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;1. signup  2.signin&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">userdata</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">AlicePasswd</span><span class="p">)</span> <span class="o">^</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">enc_send</span><span class="p">(</span><span class="n">userdata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">endkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">userdata</span> <span class="o">+</span> <span class="n">endkey</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">enc_send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;I am a ctfer.Please give me flag&#39;</span> <span class="p">,</span> <span class="n">enc_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_recv</span><span class="p">(</span><span class="n">enc_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dec_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">enc_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">enc_key</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;, &#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pridec</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">enc_key</span> <span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">unpad</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span></code></pre></div><p>由于<code>endkey</code>长度为<code>5</code>，而<code>key</code>的长度是<code>16</code>，那么可以自然推断出<code>userdata</code>的长度为<code>11</code></p>
<p>但是如果我们控制<code>r</code>使得<code>userdata</code>的第一个字节异或为了<code>\x00</code>，那么<code>userdata</code>的长度就变成了<code>10</code>，如果<code>endkey</code>的长度不变，再使用<code>userdata + endkey</code>作为<code>AES</code>的<code>key</code>，那么会通不过<code>assert len(enc_key) == 16</code>，即连接会断开</p>
<p>这样我们可以通过单字节爆破<code>AlicePasswd</code>的值使得<code>key</code>的长度从<code>16</code>变成<code>15</code>，这样就能获得<code>AlicePasswd</code>的第一个字节，然后重复该过程便可以获得<code>AlicePasswd</code>（每爆破出一个字节，在爆破下一个字节的时候将<code>endkey</code>的长度变长一位即可连续爆破）</p>
<p>PS：实际上的操作过程中<code>AlicePasswd</code>的最后一个字节爆破不出来，我们使用服务端的<code>Sign In</code>功能来爆破最后一个字节即可</p>
<p>在拿到了<code>AlicePasswd</code>之后，我们便可以伪造成<code>Alice</code>登陆服务端，但是由于<code>endkey</code>是使用<code>AlicePublicKey</code>来进行加密的，所以我们还需要拿到<code>endkey</code>的值才能获得<code>AES</code>的<code>key</code>并进行<code>任意文本加解密</code></p>
<p>前面我们提过，<code>endkey</code>长度为<code>5</code>，但是实际上<code>elgamal</code>的<code>p</code>是<code>512</code>比特的，也就是说<code>endkey</code>远比<code>p</code>小</p>
<p>如果我们将<code>elgamal</code>加密后的<code>endkey</code>的<code>y2</code>乘以一个倍数<code>k</code>，那么<code>elgamal</code>解密后的<code>endkey</code>就会变大<code>k</code>倍，这个值如果特别大，则<code>userdata + endkey</code>就也会变大，这样便会通不过<code>assert len(enc_key) == 16</code>，即连接会断开</p>
<p>那么我们就可以通过遍历<code>k</code>并查看连接是否断开来得到<code>endkey</code>的大致范围，然后通过控制<code>r</code>让<code>userdata</code>的长度变小来使得我们的<code>k</code>可以不断变大，进而将<code>endkey</code>的取值范围不断缩小来得到<code>endkey</code></p>
<p>最后我们便可以进行<code>任意文本加解密</code>来获取<code>flag</code></p>
<div id="exp-3" class="anchor"></div>
<h4 class="relative group">EXP 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#exp-3" aria-label="Anchor">#</a></span>        
    
</h4>
<p>爆破<code>AlicePasswd</code>的脚本（除了最后一个字节）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">elgamal</span> <span class="kn">import</span> <span class="n">elgamal</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">urandom</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.log_level = &#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Alice_pubkey</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10701440058624032601015137538928332495339102166449611910023158626004456760436930147541475696463030881833656888220652983522600176918743749340172660134163173</span><span class="p">,</span> <span class="mi">1564399668655593150166497641453625075939863931648697579307</span><span class="p">,</span> <span class="mi">7485644640971189066076867813504769638089749022750276585841131549227880841063823940682209946365975810625990180843110530957715179877761206203179636693608929</span><span class="p">,</span> <span class="mi">10399272689500457356753299445284422908920074489727610618928888372268024186959263604721857776550008093778901180936272708522371781846820901338928077050396521</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pubenc</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">Alice_pubkey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">enc</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">y1</span> <span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">pubenc</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">attackAlice</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">alice_shell</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.100.0.15&#34;</span><span class="p">,</span><span class="mi">10003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">alice_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Hello, I am Alice, can you tell me the address of the server?</span><span class="se">\n</span><span class="s2">In return, I will give you the ctf_flag</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">alice_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;xxxx:8888&#34;</span><span class="p">)</span> <span class="c1"># xxxx -&gt; your vps&#39;s ip</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1. signup  2.signin&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;please give me your name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;please give me your passwd(encrypted and xored by r)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;signin success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;now let</span><span class="se">\&#39;</span><span class="s1">s communicate with this key&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">alice_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">middle_shell</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">alice_shell</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">alice_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">known_pwd</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 0x35343764643163636333xx</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">rr</span> <span class="o">=</span> <span class="p">((</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">known_pwd</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;try:&#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">rr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">enc</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">attackAlice</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">known_pwd</span> <span class="o">+=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">known_pwd</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span></code></pre></div><p>爆破<code>AlicePasswd</code>的最后一个字节的脚本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">elgamal</span> <span class="kn">import</span> <span class="n">elgamal</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">urandom</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.log_level = &#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dic</span> <span class="o">=</span> <span class="s2">&#34;0123456789abced&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">server_pubkey</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8299337325013713958100496214277076548352330213422739951900206795659160881192662528217175848727001874097369338994314737585158671248737646741717255122339339</span><span class="p">,</span> <span class="mi">1168114014665994438995759247944846107956060291607878556427</span><span class="p">,</span> <span class="mi">6500863983405565947154848535503122330952083500341721347265599161478330537510643776384164499549064061675517930495094496645911948535824156417648599603482256</span><span class="p">,</span> <span class="mi">1567838365897620258270310904624368598290758028096181970817619626094906443214320401208038763050717813632540079799097716376430981907783174222429828480377116</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pubenc</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">server_pubkey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">known_pwd</span> <span class="o">=</span> <span class="s2">&#34;547dd1ccc3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.100.0.15&#34;</span><span class="p">,</span><span class="mi">10001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;please give me your name</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Alice&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;please give me your passwd(encrypted and xored by r)</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">server_shell</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">pwd</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">((</span><span class="n">known_pwd</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">prefix</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">pwd</span> <span class="o">^</span> <span class="n">rr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y1</span> <span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">pubenc</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pwd</span> <span class="o">^</span> <span class="n">rr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">server_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa">b</span><span class="s2">&#34;success&#34;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">known_pwd</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><p>获取<code>endkey</code>并进行<code>中间人攻击</code>的脚本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">elgamal</span> <span class="kn">import</span> <span class="n">elgamal</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.log_level = &#34;debug&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pwd</span> <span class="o">=</span> <span class="s2">&#34;547dd1ccc38&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">pwd</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_pubkey</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8299337325013713958100496214277076548352330213422739951900206795659160881192662528217175848727001874097369338994314737585158671248737646741717255122339339</span><span class="p">,</span> <span class="mi">1168114014665994438995759247944846107956060291607878556427</span><span class="p">,</span> <span class="mi">6500863983405565947154848535503122330952083500341721347265599161478330537510643776384164499549064061675517930495094496645911948535824156417648599603482256</span><span class="p">,</span> <span class="mi">1567838365897620258270310904624368598290758028096181970817619626094906443214320401208038763050717813632540079799097716376430981907783174222429828480377116</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pubenc</span> <span class="o">=</span> <span class="n">elgamal</span><span class="p">(</span><span class="n">server_pubkey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">10701440058624032601015137538928332495339102166449611910023158626004456760436930147541475696463030881833656888220652983522600176918743749340172660134163173</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">padlen</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="n">padlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span><span class="p">[:</span><span class="o">-</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">oracle</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">y1</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y2</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">combineKey</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">rr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">alice_shell</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.100.0.15&#34;</span><span class="p">,</span><span class="mi">10003</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">alice_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Hello, I am Alice, can you tell me the address of the server?</span><span class="se">\n</span><span class="s2">In return, I will give you the ctf_flag</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">alice_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;xxxx:8888&#34;</span><span class="p">)</span> <span class="c1"># xxxx -&gt; your vps&#39;s ip</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1. signup  2.signin&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;please give me your name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;please give me your passwd(encrypted and xored by r)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;signin success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;now let</span><span class="se">\&#39;</span><span class="s1">s communicate with this key&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">middle_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">middle_shell</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">middle_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">alice_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">middle_shell</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">middle_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">alice_shell</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">alice_shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.100.0.15&#34;</span><span class="p">,</span><span class="mi">10001</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;please give me your name</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;Alice&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;please give me your passwd(encrypted and xored by r)</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">server_shell</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">prefix</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">pwd</span> <span class="o">^</span> <span class="n">rr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y1</span> <span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">pubenc</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pwd</span> <span class="o">^</span> <span class="n">rr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;now let&#39;s communicate with this key</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y1</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">server_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;, &#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Get communicate key:&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;,&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">40</span>
</span></span><span class="line"><span class="cl"><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">prefix_length</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">bound</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">40</span>
</span></span><span class="line"><span class="cl"><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">binary_ptr</span> <span class="o">=</span> <span class="mh">0x80</span>
</span></span><span class="line"><span class="cl">    <span class="n">diff</span> <span class="o">=</span> <span class="n">binary_ptr</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert_arr</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">binary_ptr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">assert_arr</span><span class="p">[</span><span class="n">binary_ptr</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">assert_arr</span><span class="p">[</span><span class="n">binary_ptr</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">prefix_length</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">l</span> <span class="o">=</span> <span class="n">bound</span> <span class="o">//</span> <span class="n">multiple</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="n">bound</span> <span class="o">//</span> <span class="p">(</span><span class="n">multiple</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx</span> <span class="o">=</span> <span class="n">multiple</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="nb">hex</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">bound</span> <span class="o">*=</span> <span class="mh">0x100</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">binary_ptr</span> <span class="o">!=</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">assert_arr</span><span class="p">[</span><span class="n">binary_ptr</span><span class="p">]</span> <span class="o">^</span> <span class="n">assert_arr</span><span class="p">[</span><span class="n">binary_ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">prefix_length</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">l</span> <span class="o">=</span> <span class="n">bound</span> <span class="o">//</span> <span class="p">(</span><span class="n">multiple</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="n">bound</span> <span class="o">//</span> <span class="n">multiple</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx</span> <span class="o">=</span> <span class="n">multiple</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="nb">hex</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">bound</span> <span class="o">*=</span> <span class="mh">0x100</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">rr</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">pwd</span><span class="p">)[:</span><span class="n">prefix_length</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">prefix_length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">multiple</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">*</span> <span class="mh">0x100</span> <span class="o">+</span> <span class="n">binary_ptr</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">oracle</span><span class="p">([</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">],</span><span class="n">multiple</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">combineKey</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">rr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">binary_ptr</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">prefix_length</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">h</span> <span class="o">=</span> <span class="n">bound</span> <span class="o">//</span> <span class="p">(</span><span class="n">multiple</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">idx</span> <span class="o">=</span> <span class="n">multiple</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="nb">hex</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">bound</span> <span class="o">*=</span> <span class="mh">0x100</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert_arr</span><span class="p">[</span><span class="n">binary_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">binary_ptr</span> <span class="o">+=</span> <span class="n">diff</span>
</span></span><span class="line"><span class="cl">            <span class="n">diff</span> <span class="o">//=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert_arr</span><span class="p">[</span><span class="n">binary_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">binary_ptr</span> <span class="o">-=</span> <span class="n">diff</span>
</span></span><span class="line"><span class="cl">            <span class="n">diff</span> <span class="o">//=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">endkey</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">endkey</span>
</span></span><span class="line"><span class="cl"><span class="n">success</span><span class="p">(</span><span class="s2">&#34;get key:&#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;I am Alice, Please give me true flag&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span> <span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">server_shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">msg</span> <span class="o">=</span> <span class="n">server_shell</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span></code></pre></div><div id="参考" class="anchor"></div>
<h3 class="relative group">参考 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e5%8f%82%e8%80%83" aria-label="Anchor">#</a></span>        
    
</h3>
<p><a href="https://github.com/USTC-Hackergame/hackergame2020-writeups/blob/master/official/"   target="_blank">
    https://github.com/USTC-Hackergame/hackergame2020-writeups/blob/master/official/</a>不经意传输/README.md</p>
<p><a href="https://ctf-wiki.org/crypto/asymmetric/discrete-log/discrete-log/#pohlig-hellman-algorithm"   target="_blank">
    https://ctf-wiki.org/crypto/asymmetric/discrete-log/discrete-log/#pohlig-hellman-algorithm</a></p>
<div id="莲城杯-经典随机数yusa的密码学课堂mt19937" class="anchor"></div>
<h2 class="relative group">莲城杯 经典随机数Yusa的密码学课堂——MT19937 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e8%8e%b2%e5%9f%8e%e6%9d%af-%e7%bb%8f%e5%85%b8%e9%9a%8f%e6%9c%ba%e6%95%b0yusa%e7%9a%84%e5%af%86%e7%a0%81%e5%ad%a6%e8%af%be%e5%a0%82mt19937" aria-label="Anchor">#</a></span>        
    
</h2>
<p>又是这个系列的题</p>
<p>有三个文件都已经上传至<a href="https://github.com/4XWi11/CTF-sourcecode.git"   target="_blank">
    github仓库</a>里了</p>
<p>虽然考点还是MT19937伪随机数，但是这个是在C++下写的；之前发过关于这类题的文章，但今天去看写地太烂了，处刑一下，完全没有搞懂嘛</p>
<p><a href="https://4xwi11.github.io/posts/2d82e8aa/"   target="_blank">
    https://4xwi11.github.io/posts/2d82e8aa/</a></p>
<p>解决上次的一个问题</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="http://mypictruebed.oss-cn-hangzhou.aliyuncs.com/img/image-20211011203341752.png" alt="image-20211011203341752" />
    
  </figure>

</p>
<p>并非不是需要624个数，而是需要凑足<code>32*624</code>位，也就是<code>64*312</code>位</p>
<p>所以如果是纯python的话，这道题应该秒出，但问题是C++；试了下就算给相同的种子，但生成的随机数序列也是不同的，算法略有出路应该</p>
<p>代码不长，贴一下</p>
<pre tabindex="0"><code>import subprocess
import os
import random
import hashlib

subprocess.run([&#34;g++&#34;, &#34;random.cpp&#34;, &#34;-o&#34;, &#34;random&#34;, &#34;-std=c++11&#34;],check=True)
proc = subprocess.Popen([&#34;./random&#34;],stdin=subprocess.PIPE,stdout=subprocess.PIPE)

# out, err = proc.communicate(str(int(os.urandom(8).hex(),16)).encode() + b&#34;\n&#34;)
out, err = proc.communicate(str(16063322316592949072).encode() + b&#34;\n&#34;)
data = out.strip().split()
flag = random.randint(0,len(data))
FLAG = b&#39;DASCTF{&#39;+hashlib.md5(data.pop(flag)).hexdigest().encode()+b&#39;}&#39;
data = list(map(int,data))

with open(&#34;outputs_%d.txt&#34;%flag,&#34;w&#34;) as f:
    f.write(str(data))
#include &lt;cinttypes&gt;
#include &lt;iostream&gt;
#include &lt;random&gt;

int main() {
  uint64_t seed;
  std::cin &gt;&gt; seed;
  std::mt19937_64 rng(seed);
  for (int i = 0; i &lt; 1000; ++i) {
    std::cout &lt;&lt; rng() &lt;&lt; &#39;\n&#39;;
  }
  return 0;
}
</code></pre><hr>
<p>好了，开始讲这道题的思路</p>
<p>




  <figure>
    <img class="my-0 rounded-md" src="http://mypictruebed.oss-cn-hangzhou.aliyuncs.com/img/image-20211011211321791.png" alt="image-20211011211321791" />
    
  </figure>

</p>
<p>这张图出来的有点早（doge）</p>
<p>先看到最后，这个flag在文件名中，就是pop出来的伪随机数，是<code>374</code></p>
<pre tabindex="0"><code>with open(&#34;outputs_%d.txt&#34;%flag,&#34;w&#34;) as f:
    f.write(str(data))
</code></pre><p>但可惜根据pop，虽然我们知道data，但是是删除了原第<code>374</code>位的data</p>
<p>需要通过其余<code>373</code>+<code>625</code>个数字求得这位</p>
<p>显然根据之前的<code>mt19937predictor</code>，和前<code>373</code>位（这个上面刚解释过）以及后面的<code>625</code>位，是完全可以获得的，然后再得到第<code>374</code>个，拿捏</p>
<p>可是试过了不行，用了恢复的方法也不行；然后就想是不是C++的问题</p>
<p>所以接下来的搜索思路就如上图所示，搜索关键词<code>c++</code>和<code>mt19937</code>以及<code>predict</code>，当然一般都返回<code>32</code>位的结果，所以加上<code>64</code>；原题到手</p>
<p>改下jo本就有</p>
<pre tabindex="0"><code>#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from mt19937_64 import mt19937_64
import hashlib

res = [15224110489171130169, 1487925206988459477, 13480727356180709371, 9868256411224235526, 6217804851957837168, 16087170136679200450, 10701512125563075829, 13839719157982856576, 17686330611486610733, 8009416170371519873, 5970669226517080452, 11269217943220347675, 10679128876184101302, 18426494309927575430, 2766502893811979226, 2252796059596895410, 9426444128738501522, 11240845202238046967, 10773508588111955623, 1557877671900503598, 10687052904024584487, 1329391365184628727, 7924797549450027243, 8535390433774276870, 3764662861183967374, 2246153524896469598, 2609915142724872757, 10658867097171399935, 5527882090828515536, 16980061916688614551, 369781677154768879, 16440083865102214341, 6215352314823709568, 7140216739817729337, 12081906179615786779, 6478685619216942062, 9619055260791569210, 1716773987678792695, 5781591055396867866, 10236249441362668669, 4314491602044042424, 9076763991771914801, 1019089589927696539, 12783145303781447438, 1784730974216681496, 10724359773647505800, 9412346711065789784, 12397469196070741661, 844871001521064632, 13554026965219580112, 4176961812003667679, 6038315983316303141, 3991176913179867636, 7277063843827680934, 6593392965255927508, 7279379575539700793, 7049180319367268844, 2484858153711481256, 9662542622219218463, 15645318283754749515, 7848634356524747132, 6328770785215004957, 14031726511284712999, 10754197358715401067, 14877197602427408826, 1961981170873480756, 15043831614315156076, 2703733192099380300, 5573267746680488476, 2588678833804270160, 16641900531805836732, 14485077651674686804, 17908682116840210486, 12129346423391778925, 449323128784312129, 2912052724053440605, 3725415122737515057, 12106075465626310804, 7844624661111246261, 4336975117722586651, 6133486737560458810, 4285708852412482387, 17320873594107961221, 18154223303204659281, 9782280317517313987, 7359883602982876716, 8302270318241074541, 2854871868457850608, 4260073478828444220, 12464166743488435720, 11545300218414290638, 15943917616147672791, 17684529969128042573, 11970487736986863722, 4279463896104155311, 6452386490939306659, 14951002814044492267, 3924373366113113482, 17675004214657643053, 10514060213491578166, 5083735479763236962, 8237048074291002693, 178024658423258428, 16217384550361068797, 6823885072554733775, 14640293890442769000, 11118102735797335929, 17687811899187265346, 12324758265458544032, 13305186849598403772, 2061361200506122451, 4473679754720240444, 15364566282531130774, 10360818283823976655, 17220043518084908852, 9386042935320331823, 10932555460714805145, 14286030551222176204, 5513294049464657489, 9643782458509542843, 2950842616838528179, 16153550634060410597, 10622243240110203305, 1642938210383117587, 16348894212565750617, 17802404752703029833, 16933001622790235864, 13021337058260052257, 17301160463217879931, 4914154622730751038, 3649150598994385675, 17138640742876844054, 6723182378145435688, 15799828338293133322, 994720218982390675, 10557290726979603665, 17714019041621996643, 13997848863450584994, 11077445104717373075, 2834856239311065051, 11214787995926447582, 4068838695613829268, 3318186966385494373, 10984597623033520694, 5515414919887778777, 7222755179917827587, 16315875605087375576, 1416504086864662519, 9102186857132686420, 10069600536464217172, 6582524821522410340, 15369756932292150641, 17542632941176957329, 6114252881995050176, 2055179652476914195, 16405356136326356060, 14344232008993353644, 7357227068527869292, 14444189009256502503, 474793712655159763, 7277957134452370555, 10136894698074936516, 16493593438906441399, 965972604086413481, 7698637742708237198, 14701582675687476239, 8687372870093533304, 8617910444450923438, 9198266698377902297, 17663341461584809487, 9416311128064169723, 15527623086766043739, 17634355913948865190, 18230067880107976101, 14647282067432289184, 2666571742016867486, 35944775638564196, 13202068495097382260, 9200881323819852309, 4609224846213708248, 18385087669463550574, 10907111573029619720, 3677665280613822779, 7175067246924173873, 11557554314793111361, 16459269098754836930, 15069426419433415372, 3478942161672373533, 1475410410806061275, 3951913608914307936, 9031385401155758661, 3487921219891556908, 14331439795449455643, 18005194978393081205, 17499558816128213969, 10013697255070423725, 5656707783041395866, 8245156232824114523, 5484825401635850101, 18276565390397117490, 9806016278660472039, 6246223529755503034, 16322603114524844950, 13512386112109766619, 4292997062471342719, 5482339873158479974, 12153068771020641259, 18134128714075076811, 3921582705345984456, 17990063870067007106, 11893303237020637674, 584000375933180982, 6837860293438757570, 8668590806728300645, 10930322698482157784, 3456591010166906694, 8479176164660731035, 1378913458575066776, 11867206231852016448, 11155774780214677606, 912636353429261442, 17286540002553508524, 2342876557589322779, 8472494814582696749, 1649463863153987977, 6639761134830802698, 17749792536888103944, 6682611142368155837, 8961391229631067960, 16808632462882238050, 12764361808843833740, 3494650449008997672, 13464542575897195823, 424905026997643448, 6949880018570988189, 4352171970901905656, 7585977087659274602, 9963800442502096068, 11967585318365690786, 1330206767381639342, 8961211309807685961, 12822173985081341335, 4508173450257371182, 5828692808060501375, 7437728885533218362, 11924888116770741814, 2012177013990519412, 6499123439580002081, 13085942749253543550, 12967954280047984193, 401135611301783756, 3748733649551258520, 3742761952933734129, 7180568637515019340, 8490711531714639868, 1461899626173313114, 15357996742461975417, 14566908736002266815, 18368411028248688780, 2276282088146233438, 13500510232438577028, 5042075854511929699, 6430943865985944461, 4611615451136427723, 16501718400150227301, 12689032035555572221, 15097412730296922717, 3917094315801026114, 2738852375492418821, 16365967597393176630, 15062401340541737624, 14638139755970734808, 17586333334851266372, 17319918915751492871, 11845068873340136881, 1459249680175909613, 7472745361441793631, 1812384806700690960, 8855007047564417997, 2163690632469050637, 1883216720349119806, 17992478845633263598, 4665099551190282678, 11678011021345341884, 14187013186800119116, 14052476937717753457, 14759086517840933234, 5009467219504023390, 4622766434224603629, 14306333222661486071, 3858064603145888263, 5480134807934395111, 4123024571389908319, 4857052736700414325, 16243980005326285458, 3632766067814039781, 710008964341406746, 5363960844618609694, 14114730195035015808, 16428297947621094568, 7700974694607772814, 16793381582485703202, 13948380472150916306, 14326581900789123198, 4228968193234651142, 11100829582225662535, 17495023276082596914, 8634787791698085471, 6145765583313197421, 16788430897014030178, 11435692770927277650, 18065086017618584565, 11769581244567937207, 13278489473631493919, 8019460929320111149, 5693618935245539106, 3634811597737081216, 12859793273631344580, 11287301384880619752, 18394782048366983264, 7421132200962846807, 4084540937457316264, 13113874388366064762, 8131358879566215449, 18127561595469413694, 8734770900165404534, 17424357262393464853, 10097252723684474013, 13657127819021358228, 15053911843606144518, 7213762907694003185, 9201850376693257882, 1152437224214832892, 14749316667846084768, 13945981875336291326, 17205113012613835387, 17208682023098019636, 16837244935188768969, 1562887481274292099, 4817091557053520861, 12788128805488570720, 12001115261194850091, 4003771944165077120, 2234627252583081046, 9648802166794733209, 2217782127954322431, 8813298931273365931, 8055654179906713224, 11975882101529377223, 3484952924454621378, 9405558259370977621, 10465136460923462995, 10114188036427722127, 3137605056932583175, 6052770256806365938, 13216705997825407019, 9321595432845767721, 7404913363748792748, 3104222247113734338, 7884841839505302190, 10282600744363227974, 10560288140635802837, 345714099277926722, 14827599919753819919, 15348137034782912153, 117188792560235416, 721765732450403598, 13484574492955662118, 4088456941206683834, 7978001820773876706, 3458688202384309003, 7297824025882346112, 8366103370544240004, 14726906913567147182, 17890463553725848943, 11056300998383817861, 12172218496062907284, 5614991059403362329, 94695117905761066, 13704554396573869457, 6942259376738368761, 3724125954238286617, 605665642089906206, 4440357634786283101, 9312356527281045726, 18433419763563298916, 5537070555239228268, 13655980751929630271, 11097112793938372280, 7029091093125181071, 15682558111863651240, 9864810256451039130, 5940287037201593945, 7230113292992804565, 1262540470928338201, 9310270195989362278, 5911475921308141211, 5943394248414176333, 2467090711423218798, 14834589937967531968, 2112412521637455955, 4483762121635552341, 9203453183301626690, 12517949271946792756, 11765267562048769695, 2130431799048385018, 1021118212271885825, 4527525148317213493, 2666979235110630076, 11385323575772505236, 1957143482002768471, 6653869545594001852, 9403787903811093312, 8793399260966849492, 9134129177479686128, 5344549741728076030, 3785525706196259331, 4098427281238979781, 14780185570363454606, 15022528285132147394, 4415868057026363350, 11652850077219368760, 6599101465769202844, 2324709069440458374, 2328030874184313596, 5375810578496425005, 3324352283736262699, 8961596405474061089, 17555556238164816340, 1217170962166712882, 12300833475020082526, 5755163501951705747, 17673007557139716816, 5400175616849815689, 16424974447872124521, 3528336073009821153, 5677112613986511204, 11681713850480599971, 17889123911033641068, 13398947136669841280, 14362332277634552597, 12612291562289233371, 9068021764334224282, 11003726667849614111, 170500049009536169, 11787850295471586749, 17738376378319933104, 265438126753187088, 16449969716110589415, 4267181961918958684, 8504721844419720345, 3602399335681951800, 16377130351527521329, 137205552767822057, 15076083541717516190, 16933079658536833273, 11539760435976559163, 10349113249022571006, 13506623588121209051, 1767257281718218581, 55497369433803178, 9620183217554454747, 352109299759977748, 13362871402671548794, 3245933715092323519, 7098945802580095824, 4749740144906242542, 16475573756134089178, 17665764356947420150, 2428128185580929142, 10865799872171434959, 14020645350131532589, 10866919792482735515, 1639413999413384841, 2660467607619573650, 7176921049243916372, 44929497464104249, 8302026006819056308, 14088827593384756939, 4541386427308185948, 14992023310005249339, 11521110449882379692, 8618468396936995487, 17255690317020962535, 14459878492479278129, 484161739083752565, 8967126682428339806, 12208164843579773375, 11736932142677088849, 7727530756457513692, 3829808422387045462, 9815185898534079561, 8586014595553015140, 3121180959957037281, 546542310230906996, 12788213799003801890, 6764098612553553982, 16230764669201238834, 18205877184448874064, 17741584570061449195, 13498693246362717293, 12557996638970667763, 16240767280840697248, 12688455377024311919, 11821568382422290340, 13694830011903255027, 15977888673915506876, 12346885892635259078, 7838634663919088845, 13697951298959265290, 16396403340832798324, 5570724586621569543, 348190538972825181, 498434119496336507, 4629603637537989875, 2904956541370261046, 15056806750205280060, 12512751698356956353, 11598492895309981739, 5900963668615601483, 9286588840856606265, 14687331465648814630, 724531149460506959, 17016613597390705501, 17860966464838170961, 8082441243109422217, 4226070025033485357, 11557581090421115709, 1365974406386375567, 11626532849062235723, 3026767794107211866, 18265729906007136324, 9752072017332967624, 8344899021234511823, 17168023990850847933, 2108491903973827339, 16946871590663953204, 15268856540448037497, 6729814538132205074, 10608459573931314294, 5349389425094153624, 9119249437078259281, 3022057742231131843, 699495075963768616, 3938180359891046702, 3132000820601213475, 6453763775620458305, 10361983187468507141, 18091129984666032675, 4573010375750843342, 791243713554231377, 6523321933147523990, 2460943155031244372, 11915079949168514844, 10962272930784254451, 7828398430854164950, 11580373300607261323, 14496114508805667408, 12800088002722989479, 4489382774379581027, 6241885538530491013, 15369736452242646419, 18339907485699833664, 14843607724306799380, 15883998472835946312, 13401911608426527924, 3615974264171478906, 2951259064496198811, 7803436242736563826, 4135188636826481442, 5021264042001895982, 5708915960985917130, 11181910501244483073, 5573954009605843738, 3021445895744683140, 10033196279958934660, 2680855996735532569, 5360189858868901361, 8167521138921792938, 6161893524269697852, 5558764473993615110, 13408224815379298518, 17751136251534065932, 12169040946650623409, 8591752444091873275, 17571132974848304944, 16886102890910720967, 10434431909683674783, 1798513582887417581, 4922950544911394484, 436078592099283889, 10061099463464191790, 2611739359719785328, 12076811020743303539, 2799012545596479383, 12408665237686526887, 2569240801657154200, 189527510828503181, 17204452437985213973, 15873367317020085673, 4668478220806245681, 2950905851413543275, 17244737907264565987, 9947196811151946334, 10861412944742179841, 17691963506930352, 8645426666922253783, 5429177116065336723, 9148166318339274858, 1140817301847500253, 16395024534726001957, 14455719375367518785, 14365592159046307404, 4233672053992875940, 7055944177387857447, 13438827615850026797, 1980459165532258112, 9924227990341676772, 1258768952545009550, 11361136852134788879, 4300533493752614933, 14681866951052377042, 8810851615125798911, 8542930103562314876, 14579475506918455576, 16047523528880779866, 1380610643416544755, 12076763661431463653, 13633351579395427301, 14309637244904670356, 2784919727650036805, 10011701223131936197, 16483582182156980016, 8123259590358566068, 15547670775408355653, 17114873767724596286, 15947690112937005468, 7121267006666076401, 15013329343112101948, 6864703775066800136, 2091646091797307547, 11775971286169844616, 13169145274668540822, 18168794334896751614, 8757043158271235193, 12162217691779194844, 10986813166707328024, 4635742872437686441, 9862874769906586011, 5685640425162748748, 16154828004824450666, 12628559068947614691, 18330543771355967176, 9613516487817756865, 11541501577179857879, 14497414068611647595, 16303734492840330251, 3271500016365005027, 3388428085388242514, 1510190073604428294, 10472797328548283957, 9702728991503878250, 3428420960955188888, 6445224698406122174, 5824974369892172376, 6434707946773025269, 2528556873146891935, 6653952898338236677, 432032921329160914, 11760277815966837524, 9034646482280577053, 2164586012669056137, 2616742534894002775, 942200230707617758, 5327259632525477213, 13158846232145762876, 418213563708326684, 13494580607955344451, 13712793184114793941, 13061962736775979494, 1304785696522982742, 6636575085535497783, 2548707152553606937, 5179609242429207458, 216456340969811386, 8504681751639758545, 18283819579633351371, 8667595238380606433, 15751060841552119650, 10368350373271876373, 2271051687544383713, 9387982608299096176, 5067191246740902300, 2164563749890672481, 1441096478400860673, 1698497919091504741, 7070556267349479512, 12383115351862498978, 4393914787565756921, 4843292715860537520, 1308644180050696570, 14727896807325886230, 5278800618172724513, 12682261375578839563, 2292210517400729441, 4539831393791783686, 11184877751085848181, 10455063755670025488, 4090948952473244180, 16140611536328585842, 4009612709629840807, 11680437954598062018, 7483349842877448300, 15595722655987483, 6218105392300937979, 4230977848731176695, 13608604339767291094, 15450864502883571776, 14522043162137067612, 17407306325856924818, 4319385475362004982, 3602607459242950116, 12919519173298379659, 17034295612889519066, 16366395208098028226, 16902437965740309665, 2976505459482736335, 13462949500218242510, 9986640179928306819, 15767966148754567460, 5987675944577047926, 908917886808113767, 7775521308318543697, 8554839413248075973, 15830102725396509035, 4299599343707193551, 151253289791368809, 2074429061050605186, 7050639080325887498, 7147021929133361313, 17288365729620621043, 13258996835492542256, 9813891614733236908, 18409516239359796503, 6114024626644998222, 5075084268262314250, 9316231926255260786, 5482842808296472097, 9445382679464571342, 341224484511902160, 13784129997188624024, 7368235505308494752, 9538628927204464393, 15343501567237040869, 17821228923098686582, 11856702827887607105, 4609368864524898262, 14712861947435117594, 10899071438470157317, 9590771163252554239, 18239878173866313008, 17348232285102511866, 7979447902828438866, 10189744825270231378, 15897242279714161903, 6814376918912188976, 14160295163213869895, 3756399085747026247, 7851944732036371005, 11096596485883534745, 17528766768147904271, 12327736621720397026, 17199643471105880304, 1457112013787956971, 4273300114441781498, 15938254022202331850, 12502089261484299213, 4148861150304071474, 16774360387122462360, 4693230099623568126, 4923228118836213154, 9672193860921898593, 12031664828792019070, 5538759348099426194, 16607999864018217913, 12801100377914190264, 3714468733303697571, 15066120849955539008, 8667181143710237426, 11054461905529698068, 5000947219599965404, 13679544882732214263, 12329024745774068972, 5097030027906429561, 623294247887615792, 7749632090228054556, 7348314875737386281, 15051320008802373451, 2316565134939415828, 15735407710770638384, 11219541286219768213, 204970242910995613, 2942251758669266767, 2446839436006958427, 5818242570475463614, 13952882162210790154, 1091967561799274001, 815669942787526663, 17619502901620723825, 16225434478481351091, 3458534598924545265, 13105176322289080982, 11660428227784960936, 17456917329772545202, 17370020327039448988, 9872223534315941551, 11134891555868721043, 7366592335535613164, 17901061154562355983, 11133114536770437092, 1216102370074140712, 12369779197340106392, 15587264963667110618, 9839321331851277149, 9504232653874690416, 3277515784377114968, 11059930209112798658, 2233223095276440320, 8766259643725656785, 2981451568249872324, 16923059343824130016, 10424762723653272247, 5892364915443744172, 5076056599547198181, 8353569794147013632, 68280038528939863, 13688795951892474996, 18383293316785491223, 16830221144227410771, 7584798539822253809, 16154968662715915283, 15260829610123279933, 4877893352139268298, 12344113633536211040, 12755524932207520008, 5908761689287331221, 10710685683019125231, 13529779487666749860, 17058207837744409161, 16146404756880670361, 479722120166144953, 18441286007767994888, 291021007503523962, 18404478127831570654, 7161684062922444049, 13215140078849265993, 3557093399709796464, 8888690439305341966, 6505462940112971530, 8788739344222162420, 1559480144085566061, 12347917275519574148, 81829582595789879, 256554008735570761, 13242371414730122957, 11233874231428992467, 13642556384815692603, 15402098527178414517, 11899811780905828512, 17981855746545737550, 4198592355605474429, 5837385946994485658, 8495884884442446152, 14987601548279232776, 8084557976601943459, 1951816494581368991, 9198564418991457621, 7932995247156296394, 1727181807973386737, 6589861619929187838, 8606879269790701257, 4872437793541536276, 15996953415759653811, 9248501959204439487, 4430871643980849717, 14781923535395473967, 15369814218152848270, 8234249513592097579, 17526914633363815278, 12602191579658959446, 14791379194771288560, 5744799145746380430, 16286641132134680583, 14401259673433035989, 8781313506229705992, 15404783223179793847, 1240592003072635453, 6610236446870877009, 13844205871835893697, 5872162931619514680, 7969671272013520825, 2766019064081136959, 12517751573997673572, 9675763639282129596, 6287079859085827340, 13703850028043029227, 2177538632683478842, 6799380297638496469, 18086402650215147822, 6934362201312885542, 18313335318052001373, 11480263463655438919, 9106785110623113711, 7886399579140250642, 3228263571695418855, 16330664963396613091, 17040963948964130546, 10826606124423646728, 2004304733703582220, 6398041571715522263, 493137561871256273, 9640584407491032029, 16021497942534243559, 3278925318796881775, 13963508362353842195, 10912881406340519756, 12333002179163988752, 10955825398678638303, 13098738959421529927, 4516651215445389327, 560548562818360587, 6879446280544278794, 17586026517062529192, 3060809513700298266, 10921253043682209150, 3096750023591656316, 13400270480516947274, 14497399820138619643, 885203573443562232, 14340392236208331243, 2009503763921531273, 5844055580211151684, 11452679420109767541, 9889351505080896698, 12297221479872520074, 145327472993840493, 14415741022760094936, 8161272693495024070, 12628038780375717745, 5651066232426624946, 6800289990668254787, 5629827258100727980, 9532683887081871864, 17078228306713530437, 5752393712365853210, 9906279898480007557, 15575593797821095372, 7944135127159515198, 9274370606751170281, 8181946307601340138, 8855405836683610977, 10604653901416893787, 11825055110857035062, 4735989253296218178, 9585945902650058725, 16832571384429265203, 14392760261562270322, 14439958219835048793, 6845765491294793435, 10537690616100733378, 10290121783493343259, 17074695699105811516, 17508569400297966287, 15411447085789948953, 10245321407074763960, 1474249930147284650, 338858065124110851, 16523709105734298997, 17458843705270839631, 11471295397505031119, 6285176061334214908, 2705374183703063320, 12810847959239174924, 10260721046212143624, 4221085600703449212, 1200019904756589653, 10460179773211533763, 11823018480340155341, 9903187458931297940, 1139978577616698133, 5744593808037898897, 16758300938964610655, 7359351744825865326, 10862900264466009346, 3342859891404368697, 18254401553280819107, 17133307977473573143, 11714571723704738721, 8944205159183890163]
pre = mt19937_64()
pre.from_output(list(map(int, res[:312])))
i = 0
for rand in res[312:]:
    a = pre.random()
    if int(rand) == a:
        i += 1
        continue
    else:
        FLAG = b&#39;DASCTF{&#39; + hashlib.md5(str(a).encode()).hexdigest().encode() + b&#39;}&#39;
        print(FLAG)
        break
</code></pre><div id="美团" class="anchor"></div>
<h2 class="relative group">美团 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e7%be%8e%e5%9b%a2" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="easy_rsa" class="anchor"></div>
<h3 class="relative group">easy_RSA 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#easy_rsa" aria-label="Anchor">#</a></span>        
    
</h3>
<p>外面一层是rsa padding attack：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">n</span><span class="o">=</span><span class="mh">0x9371c61a2b760109781f229d43c6f05b58de65aa2a674ff92334cb5219132448d72c1293c145eb6f35e58791669f2d8d3b6ce506f4b3543beb947cf119f463a00bd33a33c4d566c4fd3f4c73c697fa5f3bf65976284b9cc96ec817241385d480003cdda9649fa0995b013e66f583c9a9710f7e18396fbf461cb31720f94a0f79</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span><span class="o">=</span><span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_m</span><span class="o">=</span><span class="mh">0x5f4e03f28702208b215f39f1c8598b77074bfa238dfb9ce424af7cc8a61f7ea48ffbbd5a5e1a10f686c3f240e85d011f6c8b968d1d607b2e1d5a78ad6947b7d3ec8f33ad32489befab601fe745164e4ff4aed7630da89af7f902f6a1bf7266c9c95b29f2c69c33b93a709f282d43b10c61b1a1fe76f5fee970780d7512389fd1</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_m_1</span><span class="o">=</span><span class="mh">0x5f4e03f28702208b215f39f1c8598b77074bfa238dfb9ce424af7cc8a61f7ea48ffc5c26b0c12bcff9f697f274f59f0e55a147768332fc1f1bac5bbc8f9bb508104f232bdd20091d26adc52e36feda4a156eae7dce4650f83fabc828fdcfb01d25efb98db8b94811ca855a6aa77caff991e7b986db844ff7a140218449aaa7e8</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">b</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">monic</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">franklinreiter</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">P</span><span class="o">.&lt;</span><span class="n">X</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">g1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">^</span><span class="n">e</span> <span class="o">-</span> <span class="n">C1</span>
</span></span><span class="line"><span class="cl">    <span class="n">g2</span> <span class="o">=</span> <span class="n">X</span><span class="o">^</span><span class="n">e</span> <span class="o">-</span> <span class="n">C2</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Result&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">gcd</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">)</span><span class="o">.</span><span class="n">coefficients</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;data.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">franklinreiter</span><span class="p">(</span><span class="n">encrypt_m_1</span><span class="p">,</span> <span class="n">encrypt_m</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the key is :everything_is_easy_in_this_questionCOPY</span>
</span></span></code></pre></div><p>得到压缩包密码：everything_is_easy_in_this_question</p>
<p>解开之后是many pad attack，尝试缩小明文和key的table的范围：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">printable</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">TABLE1</span><span class="o">=</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">digits</span><span class="o">+</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">_@#</span><span class="se">\&#34;</span><span class="s2">| &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">TABLE2</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ,</span><span class="si">{}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;one_time_cipher&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">TABLE1</span><span class="o">.</span><span class="n">encode</span><span class="p">():</span> <span class="c1"># flag的table</span>
</span></span><span class="line"><span class="cl">        <span class="n">yes</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">&lt;</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">tmp_m</span> <span class="o">=</span> <span class="n">j</span><span class="o">^</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">tmp_m</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TABLE2</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">():</span> <span class="c1"># key的table</span>
</span></span><span class="line"><span class="cl">                <span class="n">yes</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">yes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">tmp_key</span> <span class="o">+=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tmp_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TABLE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;flag{it_1s_P@dd1n_@nd_p@d}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">&lt;</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp_key</span> <span class="o">+=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">TABLE</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tmp_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># flag{it_1s_P@dd1n_@nd_p@d}COPY</span>
</span></span></code></pre></div><p>得到flag：flag{it_1s<em>P@dd1n</em>@nd_p@d}</p>
<p><a href="https://github.com/fghcvjk/MT-CTF-2021/tree/master/crypto/easy_RSA"   target="_blank">
    https://github.com/fghcvjk/MT-CTF-2021/tree/master/crypto/easy_RSA</a></p>
<div id="mardasctf" class="anchor"></div>
<h2 class="relative group">Mar.DASCTF 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#mardasctf" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="threshold-1" class="anchor"></div>
<h3 class="relative group">threshold 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#threshold-1" aria-label="Anchor">#</a></span>        
    
</h3>
<p>题目代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#make.sage</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="s2">&#34;DASCTF{********************************}&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span><span class="o">=</span><span class="mi">53</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="mi">257</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span><span class="o">=</span><span class="mi">28019</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span><span class="o">=</span><span class="mi">18</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">19</span><span class="o">+</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">18</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">18</span><span class="o">+</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">18</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">17</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Q</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Zmod</span><span class="p">(</span><span class="n">q</span><span class="p">)[]</span>
</span></span><span class="line"><span class="cl"><span class="n">P</span><span class="o">.&lt;</span><span class="n">y</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Zmod</span><span class="p">(</span><span class="n">p</span><span class="p">)[]</span>
</span></span><span class="line"><span class="cl"><span class="n">fx</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fy</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gx</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Fqx</span><span class="o">=</span><span class="n">fx</span><span class="o">.</span><span class="n">inverse_mod</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Fpy</span><span class="o">=</span><span class="n">fy</span><span class="o">.</span><span class="n">inverse_mod</span><span class="p">(</span><span class="n">y</span><span class="o">^</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">hx</span><span class="o">=</span><span class="p">(</span><span class="n">Fqx</span><span class="o">*</span><span class="n">gx</span><span class="p">)</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">22</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">21</span>
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rx</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mx</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ex</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">rx</span><span class="o">*</span><span class="n">hx</span><span class="o">+</span><span class="n">mx</span><span class="p">)</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
</span></span></code></pre></div><p>可以发现本题的内容和<a href="https://ctftime.org/writeup/22161"   target="_blank">
    2020SCTF-Lattice</a>很像，那么我们可以据此写出<code>exp</code>，不过由于这道题中没有<code>bal_mod</code>，所以也就可以去掉</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">257</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="mi">28019</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">53</span>
</span></span><span class="line"><span class="cl"><span class="n">Zx</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="mi">7367</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">52</span> <span class="o">+</span> <span class="mi">24215</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">51</span> <span class="o">+</span> <span class="mi">5438</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">7552</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">49</span> <span class="o">+</span> <span class="mi">22666</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">48</span> <span class="o">+</span> <span class="mi">21907</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">47</span> <span class="o">+</span> <span class="mi">10572</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">46</span> <span class="o">+</span> <span class="mi">19756</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">45</span> <span class="o">+</span> <span class="mi">4083</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">44</span> <span class="o">+</span> <span class="mi">22080</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">43</span> <span class="o">+</span> <span class="mi">1757</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">42</span> <span class="o">+</span> <span class="mi">5708</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">41</span> <span class="o">+</span> <span class="mi">22838</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">40</span> <span class="o">+</span> <span class="mi">4022</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">39</span> <span class="o">+</span> <span class="mi">9239</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">38</span> <span class="o">+</span> <span class="mi">1949</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">37</span> <span class="o">+</span> <span class="mi">27073</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">8192</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">35</span> <span class="o">+</span> <span class="mi">955</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">34</span> <span class="o">+</span> <span class="mi">4373</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">33</span> <span class="o">+</span> <span class="mi">17877</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">32</span> <span class="o">+</span> <span class="mi">25592</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">31</span> <span class="o">+</span> <span class="mi">13535</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">30</span> <span class="o">+</span> <span class="mi">185</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">29</span> <span class="o">+</span> <span class="mi">9471</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">28</span> <span class="o">+</span> <span class="mi">9793</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">27</span> <span class="o">+</span> <span class="mi">22637</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">26</span> <span class="o">+</span> <span class="mi">3293</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">25</span> <span class="o">+</span> <span class="mi">27047</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">24</span> <span class="o">+</span> <span class="mi">21985</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">23</span> <span class="o">+</span> <span class="mi">13584</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">22</span> <span class="o">+</span> <span class="mi">6809</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">24770</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">16964</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">19</span> <span class="o">+</span> <span class="mi">8866</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">22102</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">17</span> <span class="o">+</span> <span class="mi">18006</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">3198</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">15</span> <span class="o">+</span> <span class="mi">19024</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">14</span> <span class="o">+</span> <span class="mi">2777</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">13</span> <span class="o">+</span> <span class="mi">9252</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">9684</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">11</span> <span class="o">+</span> <span class="mi">3604</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">7840</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">17573</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">11382</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">12726</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">6811</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">10104</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">7485</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">858</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">15100</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">15860</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="mi">14443</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">52</span> <span class="o">+</span> <span class="mi">10616</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">51</span> <span class="o">+</span> <span class="mi">11177</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">24769</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">49</span> <span class="o">+</span> <span class="mi">23510</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">48</span> <span class="o">+</span> <span class="mi">23059</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">47</span> <span class="o">+</span> <span class="mi">21848</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">46</span> <span class="o">+</span> <span class="mi">24145</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">45</span> <span class="o">+</span> <span class="mi">12420</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">44</span> <span class="o">+</span> <span class="mi">1976</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">43</span> <span class="o">+</span> <span class="mi">16947</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">42</span> <span class="o">+</span> <span class="mi">7373</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">41</span> <span class="o">+</span> <span class="mi">16708</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">40</span> <span class="o">+</span> <span class="mi">18435</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">39</span> <span class="o">+</span> <span class="mi">18561</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">38</span> <span class="o">+</span> <span class="mi">21557</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">37</span> <span class="o">+</span> <span class="mi">16115</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">36</span> <span class="o">+</span> <span class="mi">7873</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">35</span> <span class="o">+</span> <span class="mi">20005</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">34</span> <span class="o">+</span> <span class="mi">11543</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">33</span> <span class="o">+</span> <span class="mi">9488</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">32</span> <span class="o">+</span> <span class="mi">2865</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">31</span> <span class="o">+</span> <span class="mi">11797</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">30</span> <span class="o">+</span> <span class="mi">2961</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">29</span> <span class="o">+</span> <span class="mi">14944</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">28</span> <span class="o">+</span> <span class="mi">22631</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">27</span> <span class="o">+</span> <span class="mi">24061</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">26</span> <span class="o">+</span> <span class="mi">9792</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">25</span> <span class="o">+</span> <span class="mi">6791</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">24</span> <span class="o">+</span> <span class="mi">10423</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">23</span> <span class="o">+</span> <span class="mi">3534</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">22</span> <span class="o">+</span> <span class="mi">26233</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">14223</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">15555</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">19</span> <span class="o">+</span> <span class="mi">3381</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">23641</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">17</span> <span class="o">+</span> <span class="mi">2697</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">11303</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">15</span> <span class="o">+</span> <span class="mi">6030</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">14</span> <span class="o">+</span> <span class="mi">7355</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">13</span> <span class="o">+</span> <span class="mi">20693</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">1768</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">11</span> <span class="o">+</span> <span class="mi">10059</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">27822</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">8150</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">5458</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">21270</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">22651</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">8381</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2819</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">3987</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8610</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">6022</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">inv_mod_prime</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">T</span> <span class="o">=</span> <span class="n">Zx</span><span class="o">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">Integers</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="o">.</span><span class="n">quotient</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Zx</span><span class="p">(</span><span class="n">lift</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">T</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bal_mod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">g</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(((</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">q</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="o">//</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Zx</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">pri_key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="p">,</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pri_key</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">bal_mod</span><span class="p">(</span><span class="n">mul</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">f</span><span class="p">),</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="n">bal_mod</span><span class="p">(</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">fp</span><span class="p">),</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_key</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span> <span class="o">=</span> <span class="n">Zx</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][:</span><span class="n">n</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">            <span class="n">fp</span> <span class="o">=</span> <span class="n">inv_mod_prime</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">hh</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">):</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">hh</span><span class="p">[(</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">LLL</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">get_key</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">l</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><div id="son_of_ntru" class="anchor"></div>
<h3 class="relative group">son_of_NTRU 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#son_of_ntru" aria-label="Anchor">#</a></span>        
    
</h3>
<p>虽然这道题目说的不是<code>NTRU</code>，但是我们还是可以发现题目的代码和<code>NTRU</code>基本类似</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#! /bin/bash/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gmpy2</span> <span class="kn">import</span> <span class="n">invert</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">b</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="o">%</span><span class="n">b</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">p</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">((</span><span class="n">p</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),(</span><span class="n">p</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">gcd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">invert</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">g</span><span class="p">)</span><span class="o">%</span><span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">g</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">m</span><span class="o">&lt;</span><span class="p">(</span><span class="n">p</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">p</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">%</span><span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">generate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flag</span> <span class="kn">import</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;h = </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;p = </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;c = </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span></span></code></pre></div><p>那么我们可以直接使用<a href="https://xz.aliyun.com/t/7163#toc-5"   target="_blank">
    Soreat_u</a>师傅的脚本进行解密</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GaussLatticeReduction</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">v2</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">v1</span><span class="o">.</span><span class="n">norm</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v1</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="n">v1</span><span class="o">*</span><span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">^</span><span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">v1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="mi">70851272226599856513658616506718804769182611213413854493145253337330709939355936692154199813179587933065165812259913249917314725765898812249062834111179900151466610356207921771928832591335738750053453046857602342378475278876652263044722419918958361163645152112020971804267503129035439011008349349624213734004</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mi">125796773654949906956757901514929172896506715196511121353157781851652093811702246079116208920427110231653664239838444378725001877052652056537732732266407477191221775698956008368755461680533430353707546171814962217736494341129233572423073286387554056407408816555382448824610216634458550949715062229816683685469</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="mi">4691517945653877981376957637565364382959972087952249273292897076221178958350355396910942555879426136128610896883898318646711419768716904972164508407035668258209226498292327845169861395205212789741065517685193351416871631112431257858097798333893494180621728198734264288028849543413123321402664789239712408700</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Construct lattice.</span>
</span></span><span class="line"><span class="cl"><span class="n">v1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">v2</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Solve SVP.</span>
</span></span><span class="line"><span class="cl"><span class="n">shortest_vector</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">LLL</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># shortest_vector = GaussLatticeReduction(v1, v2)[0]</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">shortest_vector</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Decrypt.</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">c</span> <span class="o">%</span> <span class="n">p</span> <span class="o">%</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</span></span></code></pre></div><div id="xctf华为云专题赛-官方writeup" class="anchor"></div>
<h2 class="relative group">XCTF华为云专题赛 官方Writeup 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#xctf%e5%8d%8e%e4%b8%ba%e4%ba%91%e4%b8%93%e9%a2%98%e8%b5%9b-%e5%ae%98%e6%96%b9writeup" aria-label="Anchor">#</a></span>        
    
</h2>
<p>题目源码：https://github.com/huaweictf/xctf_huaweicloud-qualifier-2020</p>
<div id="太湖杯" class="anchor"></div>
<h2 class="relative group">太湖杯 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e5%a4%aa%e6%b9%96%e6%9d%af" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="aegis" class="anchor"></div>
<h2 class="relative group">Aegis 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#aegis" aria-label="Anchor">#</a></span>        
    
</h2>
<p>整个出题的题目参考了googlectf 2020 Oracle的题目。由于考虑到比赛时长的问题（其实是作者比较菜），基本上是将其中的一个考点拿了出来修改成了当前的题目。针对那个题目比较完整的解法可以参考[这里](<a href="https://github.com/nguyenduyhieukma/CTF-Writeups/blob/master/Google"   target="_blank">
    https://github.com/nguyenduyhieukma/CTF-Writeups/blob/master/Google</a> CTF Quals/2020/oracle/oracle-solution.ipynb) 这个地方也有这个算法的比较详细的解释。</p>
<div id="算法简介" class="anchor"></div>
<h3 class="relative group">算法简介 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e7%ae%97%e6%b3%95%e7%ae%80%e4%bb%8b" aria-label="Anchor">#</a></span>        
    
</h3>
<p>AEGIS 算法是一种AEAD（authenticated encryption with associated data 关联数据的认证加密） 加密。这种算法除了能够提供对指定明文的加密，还能够提供对未加密的关联数据的完整性保证。说通俗一点就是，除了能够对我们发送的需要加密的信息进行加密，同时还提供了对我们明文信息的长度和时间这些未加密的数据进行验证的手法。当我们将密文解开的时候，会包含一个之前提供的明文信息的验证途径，例如能够得到长度的一个验证数据，我们此时就能够用这个数据验证我们之前未加密的长度的完整性。
在题目中，我们能看到两种不同的值:pt和aad</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ct</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
</span></span></code></pre></div><p>此处的pt表示的就是我们通常意义下的明文，而这里的aad，实际上就是<code>authenticated associated data</code>，认证关联数据。这个数据会参与到整个加密过程中，用于生成状态。
ct表示的是加密后的密文，tag则是在加密完成后的状态算法中生成的校验标签，可以用来校验aad的值是否发生变化。</p>
<p>关于aad的验证算法可以初步看一下加密过程。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_aad</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">,</span> <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_encrypt</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ct</span><span class="p">,</span> <span class="n">tag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_aad</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">,</span> <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_decrypt</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">tag2</span> <span class="o">!=</span> <span class="n">tag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid tag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pt</span>
</span></span></code></pre></div><p>由于在加密或者解密过程中，aad值参与了最初加密状态的生成，所以aad值在不变的前提下，加解密中状态（State）变化是一致的，最后阶段算出来的 tag2 理论上会和我们传入的tag一致，就是利用这一点来保证aad的完整性。</p>
<div id="aegis128的算法" class="anchor"></div>
<h3 class="relative group">Aegis128的算法 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#aegis128%e7%9a%84%e7%ae%97%e6%b3%95" aria-label="Anchor">#</a></span>        
    
</h3>
<p>想要明白当前的算法的漏洞，需要先看明白当前加密算法原理。整个加密中会维护一个<strong>状态</strong>的概念，然后我们需要加密的内容会类似一些向量来影响整个状态，从而对明文完成加密。那么首先，为了更加方便的描述加密过程，我们需要预先定义一些变量:</p>
<pre tabindex="0"><code>S[i]: 第i步更新的状态
S[i][j]: 第i步状态中，第j块128bit分组
^: 状态之间异或运算
&amp;: 状态的与运算
const0: 128bit的一个魔数（0x000101020305080d1522375990e97962）
const1: 128bit的一个魔数（0xdb3d18556dc22ff12011314273b528dd）
</code></pre><p>Aegis有三种不同的加密方式，我们这里使用的是128版本</p>
<div id="状态更新-statusupdate" class="anchor"></div>
<h4 class="relative group">状态更新 StatusUpdate 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e7%8a%b6%e6%80%81%e6%9b%b4%e6%96%b0-statusupdate" aria-label="Anchor">#</a></span>        
    
</h4>
<p>Aegis加密算法中，一个重要的概操作就是状态更新StateUpdate。当这个过程发生的时候，其更新算法如下:</p>
<pre tabindex="0"><code>m: 一个128bit的信息
S[i+1] = StatueUpdate(S[i], m)
S[i+1][0] = S[i][0]^AESRound(S[i][4])^m
S[i+1][1] = S[i][1]^AESRound(S[i][0])
S[i+1][2] = S[i][2]^AESRound(S[i][1])
S[i+1][3] = S[i][3]^AESRound(S[i][2])
S[i+1][4] = S[i][4]^AESRound(S[i][3])
</code></pre><p>这个更新过程的流程大致可以写作如下:</p>
<p><a href="https://p4.ssl.qhimg.com/t01d50ecb370d157793.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p4.ssl.qhimg.com/t01d50ecb370d157793.png" alt="img" />
    
  </figure>

</a></p>
<div id="初始化过程" class="anchor"></div>
<h4 class="relative group">初始化过程 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e8%bf%87%e7%a8%8b" aria-label="Anchor">#</a></span>        
    
</h4>
<p>整个算法的更新，首先使用密钥K128与初始化向量IV128进行一些运算，最终产生整个算法的初始状态。此时的K128为我们加密算法的密钥，IV128为一个可变的向量。整个生成的过程可以写作:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">k_iv</span> <span class="o">=</span> <span class="n">_xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="p">[</span><span class="n">k_iv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="bp">self</span><span class="o">.</span><span class="n">const_1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="bp">self</span><span class="o">.</span><span class="n">const_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">_xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">         <span class="n">_xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_1</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_update</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_update</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">k_iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">S</span>
</span></span></code></pre></div><p>根据代码，我们可以写作:</p>
<pre tabindex="0"><code>S[-5][0] = k128^iv128
S[-5][1] = const_1
S[-5][2] = const_0
S[-5][3] = k128^const_0
S[-5][4] = k128^const_1

for i in range(5)
    S[-5+i+1] = StatueUpdate(S[-4+i], k128)
    S[-5+i+1] = StatueUpdate(S[-4+i+1], k128^iv128)
</code></pre><p>这里写作-4，主要是为了可以同步，保证我们在起始状态下为<code>S[0]</code>。</p>
<div id="aegis-中的aes" class="anchor"></div>
<h3 class="relative group">Aegis 中的AES 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#aegis-%e4%b8%ad%e7%9a%84aes" aria-label="Anchor">#</a></span>        
    
</h3>
<p>我们来仔细看一下Aegis中的AES算法。首先来看到官方给出的aes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">aes_enc</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">block</span><span class="p">,</span> <span class="n">round_key</span><span class="p">:</span> <span class="n">block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">block</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;&#34;&#34;Performs the AESENC operation with tables.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">t0</span> <span class="o">=</span> <span class="p">(</span><span class="n">te0</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te1</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te2</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">10</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te3</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">15</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">  <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">te0</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te1</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">9</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te2</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">14</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te3</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">  <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="n">te0</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te1</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">13</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te2</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te3</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">7</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">  <span class="n">t3</span> <span class="o">=</span> <span class="p">(</span><span class="n">te0</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">12</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te1</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te2</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="o">^</span> <span class="n">te3</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">11</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="o">=</span> <span class="n">_block_from_ints</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">_xor</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">round_key</span><span class="p">)</span>
</span></span></code></pre></div><p><code>te0[s[0]],te1[s[1]]</code>这些就相当于是s盒，按照<code>s0,s5,s10,s15</code>这种顺序取值相当于是行位移(shift)，取值进行异或就相当于是列混淆(mix_column)。整个过程我们大致写下来就是:</p>
<pre tabindex="0"><code>AES(m) = mix_column(shift(Sbox(m)))
</code></pre><p>实际上就是AES加密算法中，除去<strong>密钥交换</strong>这一步之后的剩余步骤。并且我们知道，整个Aegis加密中，AES参与的方式为:</p>
<pre tabindex="0"><code>if j != 0
S[i+1][j] = AES(S[i][(j+4)%5])
else
S[i+1][j] = AES(S[i][(j+4)%5]) ^ mi
</code></pre><p>于是我们可以简写成如下的运算:</p>
<pre tabindex="0"><code>if j != 0
C = AES(M)
else
C = AES(M)^m
</code></pre><p>那假设此时，我们的M发生了一些变化，我们这里将变化的差值写作<code>dM</code>，此时有</p>
<pre tabindex="0"><code>M1 = M^dM
</code></pre><p>对M1的加密就可以写成:</p>
<pre tabindex="0"><code>if j != 0
C1 = AES(M1) = AES(M^dM)
else
C1 = AES(M1)^m = AES(M^dM)^m
</code></pre><p>C1、C均为我们可以得到的具体值，如果我们能够通过控制加密的内容，使得dM可控（之后会展示）<strong>我们就有机会能够推导出M的值</strong>。具体的做法如下:</p>
<pre tabindex="0"><code>1. 将C1^C，此时消除了m的影响，存在公式
C1^C = AES(M^dM)^AES(M)
2. AES = mix_column(shift(Sbox(m)))
然而首先我们知道，mix_column本身也是异或运算得到的结果，也就是说满足
mix_column(x)^mix_column(x^dx) = mix_column(dx)
而shift只是位移操作，所以也可满足
shift(x)^shift(x^dx) = shift(dx)
所以实际上可以写作
C1^C = AES(M^dM)^AES(M) = Sbox(M^dM)^Sbox(M)
</code></pre><p>然而实际上，Sbox运算是可以被爆破的。假设我们能知道dM，那我们只需要爆破16个字节，最终就能推导出M的值</p>
<div id="aegis的加密过程" class="anchor"></div>
<h3 class="relative group">Aegis的加密过程 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#aegis%e7%9a%84%e5%8a%a0%e5%af%86%e8%bf%87%e7%a8%8b" aria-label="Anchor">#</a></span>        
    
</h3>
<p>由于Aegis128加密中的最小单位为128bit，也就是16字节，所以加密之前会将当前的明文填充至16的倍数。之后，每16个字节的加密手法如下:</p>
<pre tabindex="0"><code>for i in range(0, len16(msg), 16):
    Ci = (S2 &amp; S3) ^ S1 ^ S4 ^ mi
    Si+1 = StatusUpdate(Si, mi)
</code></pre><p>注意一个细节，这边为了防止S0的参与导致加密算法被利用，所以在加密过程中故意抛弃了S0。
加密结束之后，更新当前状态块。这里参考一个图可能会更加清晰:</p>
<p><a href="https://p3.ssl.qhimg.com/t0142e426183e15748b.png"   target="_blank">
    




  <figure>
    <img class="my-0 rounded-md" src="https://p3.ssl.qhimg.com/t0142e426183e15748b.png" alt="img" />
    
  </figure>

</a></p>
<pre tabindex="0"><code>p[i][0]`为我们按照16字节分组的第i组明文输入，`k[0][0]`表示第0组的明文加密得到的密文。这里注意，我们的明文的**第0组实际上参与了第一组密文的生成，并且还影响了第1组的状态**。图上的红框表示的就是，当我们的输入`p[0][0]`发生变化的时候，实际上会影响的状态。从图上可知，当输入`p[0][0]`变化的时候，实际上会影响的是:`s[1][0], s[2][0], s[2][1], k[2][0]（这个地方应该写作k[2]，可能是图片作者写错了）
</code></pre><p>参考源码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">raw_encrypt</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="n">blk</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="n">mask</span> <span class="o">=</span> <span class="n">Aegis128</span><span class="o">.</span><span class="n">output_mask</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">blk</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">=</span> <span class="n">blk</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">blk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">=</span> <span class="n">blk</span>
</span></span><span class="line"><span class="cl">      <span class="n">ct_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_xor</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">blk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="n">S</span> <span class="o">=</span> <span class="n">Aegis128</span><span class="o">.</span><span class="n">state_update</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">S</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ct_blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_aad</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">,</span> <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_encrypt</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ct</span><span class="p">,</span> <span class="n">tag</span>
</span></span></code></pre></div><div id="ageis的漏洞点" class="anchor"></div>
<h3 class="relative group">Ageis的漏洞点 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ageis%e7%9a%84%e6%bc%8f%e6%b4%9e%e7%82%b9" aria-label="Anchor">#</a></span>        
    
</h3>
<p>加密流程中，IV和key都不会更新，并且加密7次。最终目的是让我们求出当使用了空的aad进行了StateUpdate状态后得到的初始状态，也就是状态<code>S[1]</code>。
这一类IV、key不发生变化的题目，其实传达的一个含义就是<strong>加密算法本身是不变的，即是说对于加密算法<code>C = F(m)</code>，这个F是不变量，而此时的m和C都是已知的，就有机会构造合适的m，从而泄露F中的一些信息</strong></p>
<div id="第一步泄露" class="anchor"></div>
<h4 class="relative group">第一步泄露 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e7%ac%ac%e4%b8%80%e6%ad%a5%e6%b3%84%e9%9c%b2" aria-label="Anchor">#</a></span>        
    
</h4>
<p>这里重新展示一下之前用来描述加密的那张图，这里我们着重关注的是变化值:</p>
<p>可以看到，当<code>p[0][0]</code>变化的时候，<code>s[1][0], s[2][0], s[2][1], k[2]</code>均会收到影响。这里我们复习一下这几个值的关系:</p>
<pre tabindex="0"><code>（1）k[2] = (S[2][2] &amp; S[2][3]) ^ S[2][1] ^ S[2][4] ^ p[2][0]
（2）k[1] = (S[1][2] &amp; S[1][3]) ^ S[1][1] ^ S[1][4] ^ p[1][0]
（3）S[2][0] = AESRound(S[1][4])^S[1][0]^p[1][0]
（4）S[1][0] = AESRound(S[0][4])^S[0][0]^p[0][0]
</code></pre><ul>
<li>由于（2）我们可以知道，<code>S[1][0]</code>并不参与到整个加密过程中，所以不会对加密本身有影响，因此<code>k[1]</code>的值不发生变化</li>
<li>此时生成的密文<code>kd[2]</code>虽然发生了变化，但是其变化<strong>仅仅是因为<code>S[2][1]</code>发生了变化</strong>，因为在StateUpdate中，只有<code>S[2][1]</code>会受到输入的影响，其他的状态并不收到当前的输入状态影响:</li>
</ul>
<p>这里我们将变化后的p写作<code>dp</code>，并且满足<code>dtp = dp^p</code>，发生了相应变化的变量都加上<code>d</code>的前缀，于是此时有：</p>
<pre tabindex="0"><code>kd[2] ^ k[2] = S[2][1] ^ Sd[2][1] = AESRound(S[1][0])^AESRound(Sd[1][0])
</code></pre><p>此时我们的<code>kd[2] ^ k[2]</code>是已知量。而我们此时知道</p>
<pre tabindex="0"><code>（5）AESRound(S[1][0])^AESRound(Sd[1][0]) = Sbox(S[1][0])^Sbox(Sd[1][0])
（6）S[1][0] = AES(S[0][4]) ^ S[0][0] ^ p[0][0]
</code></pre><p>由于（6）中，<code>S[0][0], S[0][4]</code>在IV和key不变的情况下，即使我们更改p也不会发生变化，所以实际上可以推出</p>
<pre tabindex="0"><code>（7）Sd[1][0]^S[1][0] = p[0][0]^dp[0][0] = dtp[0][0]
====&gt; Sd[1][0] = S[1][0] ^ dtp[0][0]
</code></pre><p>于是我们可以将（5）推到成</p>
<pre tabindex="0"><code>（8）Sbox(S[1][0])^Sbox(Sd[1][0]) = Sbox(S[1][0])^Sbox(S[1][0]^dpt[0][0]) = kd[2]^k[2]
</code></pre><p>在（8）这个算式中，<code>dpt，kd，k</code>三个值我们都知道，于是我们只需要爆破<code>S[1][0]</code>中的16字节即可。
不过经过测试，直接爆破是存在多解的情况，所以我们可以<strong>增加一个变化，也就是dpt2，两次的结果综合考虑</strong>。经过测试，这种方式能够得到唯一的<code>S[1][0]</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">dk_1</span><span class="p">,</span> <span class="n">ds_1</span><span class="p">,</span> <span class="n">dk_2</span><span class="p">,</span> <span class="n">ds_2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># here we check the </span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpk</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">bytes2matrix</span><span class="p">(</span><span class="n">dk_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_mix_columns</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_shift_rows</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d_k1</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">matrix2bytes</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">tmpk</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">bytes2matrix</span><span class="p">(</span><span class="n">dk_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_mix_columns</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_shift_rows</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d_k2</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">matrix2bytes</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># result should be unique</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># try to bruce it</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">x1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="o">^</span><span class="n">ds_1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">d_k1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="o">^</span><span class="n">ds_2</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">d_k2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">x1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span></code></pre></div><div id="进一步泄露" class="anchor"></div>
<h4 class="relative group">进一步泄露 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e8%bf%9b%e4%b8%80%e6%ad%a5%e6%b3%84%e9%9c%b2" aria-label="Anchor">#</a></span>        
    
</h4>
<p>由于我们有7次通信机会，目前可以如下安排</p>
<ul>
<li>第一次：我们一口气通信获得<code>k[0],k[1],k[2],k[3],k[4]</code>，此时我们可以将<code>p</code>设置为全0，这样的话能够帮助我们之后更加方便的进行计算</li>
<li>第二、三次： 得到<code>S[1][0]</code></li>
<li>第四、五次： 得到<code>S[2][0]</code></li>
<li>第六、七次： 得到<code>S[3][0]</code></li>
</ul>
<p>我们可以如法炮制，通过修改<code>p[1][0],p[2][0]</code>，得到<code>S[2][0],S[3][0]</code>。此时我们有公式:</p>
<pre tabindex="0"><code>（3）S[2][0] = AESRound(S[1][4])^S[1][0]^p[1][0] ==&gt; 直接逆运算，可得S[1][4]
（9）S[3][0] = AESRound(S[2][4])^S[2][0]^p[2][0] ==&gt; 利用之前的技巧，可得S[2][4]
（10）S[2][4] = AESRound(S[1][3])^S[1][4] ==&gt; 直接逆运算，可得S[1][3]
</code></pre><p>此时我们就有了<code>S[1][0], S[1][3], S[1][4]</code>，并且题目中泄露了<code>S[1][2]</code>，所以我们最终利用</p>
<pre tabindex="0"><code>（11）C[1] = (S[2][0] &amp; S[3][0]) ^ S[1][0] ^ S[4][0] ^ pt[0]
</code></pre><p>就能得到最后的<code>S[1][1]</code>，此时整个题泄露完成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aes</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aegis</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">aegis</span> <span class="kn">import</span> <span class="n">_xor</span><span class="p">,</span><span class="n">_and</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">R</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">bytes2matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">sub_bytes</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">shift_rows</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">mix_columns</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">aes</span><span class="o">.</span><span class="n">matrix2bytes</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">invR</span><span class="p">(</span><span class="n">x3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">bytes2matrix</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_mix_columns</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_shift_rows</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_sub_bytes</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">aes</span><span class="o">.</span><span class="n">matrix2bytes</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">dk_1</span><span class="p">,</span> <span class="n">ds_1</span><span class="p">,</span> <span class="n">dk_2</span><span class="p">,</span> <span class="n">ds_2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># here we check the </span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpk</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">bytes2matrix</span><span class="p">(</span><span class="n">dk_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_mix_columns</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_shift_rows</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d_k1</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">matrix2bytes</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">tmpk</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">bytes2matrix</span><span class="p">(</span><span class="n">dk_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_mix_columns</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes</span><span class="o">.</span><span class="n">inv_shift_rows</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d_k2</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">matrix2bytes</span><span class="p">(</span><span class="n">tmpk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># result should be unique</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># try to bruce it</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">x1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="o">^</span><span class="n">ds_1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">d_k1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">aes</span><span class="o">.</span><span class="n">s_box</span><span class="p">[</span><span class="n">c</span><span class="o">^</span><span class="n">ds_2</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">d_k2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">x1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ph</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">standard_b64encode</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ph</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">standard_b64encode</span><span class="p">(</span><span class="n">aad</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">standard_b64decode</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">standard_b64decode</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ct</span><span class="p">,</span> <span class="n">tag</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ct</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">left_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">right_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(&#34;enc[{}:{}]&#34;.format(left_index/32,right_index/32))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(&#34;pt[{}:{}]&#34;.format(2*index-1, 2*index))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct1_2</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="n">left_index</span><span class="p">:</span><span class="n">right_index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># encrypt 3</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">index</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(pt[2*index])</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct1_3</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="n">left_index</span><span class="p">:</span><span class="n">right_index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># decrypt s10</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(ct)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(ct1_2)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(ct)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(ct1_2)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dk1</span> <span class="o">=</span> <span class="n">_xor</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span><span class="n">ct1_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dk2</span> <span class="o">=</span> <span class="n">_xor</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span><span class="n">ct1_3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># split S1/S5</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pt split ,too</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="n">dk1</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="p">)],</span> 
</span></span><span class="line"><span class="cl">                <span class="n">dk2</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">index</span><span class="p">][</span><span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">localTest</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">ph</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="s1">&#39;10090&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">padding</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">p0</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">p1</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">p2</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p0</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">padding</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for i in range(1,7):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pt.append(bytes([i%2+1]*16)+padding)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for s10</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">padding</span><span class="o">+</span><span class="n">padding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">padding</span><span class="o">+</span><span class="n">padding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for s20</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padding</span><span class="o">+</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">padding</span><span class="o">+</span><span class="n">padding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padding</span><span class="o">+</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">padding</span><span class="o">+</span><span class="n">padding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for s30</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padding</span><span class="o">+</span><span class="n">padding</span><span class="o">+</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">padding</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padding</span><span class="o">+</span><span class="n">padding</span><span class="o">+</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">padding</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">iv</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">aad</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># encrypt 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ct</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enc</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s10</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ct</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># decrypt 2 </span>
</span></span><span class="line"><span class="cl">    <span class="n">s20</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ct</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># decrypt 3</span>
</span></span><span class="line"><span class="cl">    <span class="n">s30</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">aad</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ct</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># s20 = s10 xor R(s14) ==&gt; s14 = invR(s20 xor s10)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s14</span> <span class="o">=</span> <span class="n">invR</span><span class="p">(</span><span class="n">_xor</span><span class="p">(</span><span class="n">s20</span><span class="p">,</span> <span class="n">s10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># s30 = s20 xor R(s24) ==&gt; s24 = invR(s20 xor s30)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># s24 = s14 xor R(s13) ==&gt; s13 = invR(s14 xor s24)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s24</span> <span class="o">=</span> <span class="n">invR</span><span class="p">(</span><span class="n">_xor</span><span class="p">(</span><span class="n">s20</span><span class="p">,</span> <span class="n">s30</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s13</span> <span class="o">=</span> <span class="n">invR</span><span class="p">(</span><span class="n">_xor</span><span class="p">(</span><span class="n">s24</span><span class="p">,</span> <span class="n">s14</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ph</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Oops, something leak:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s12</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">s12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s12</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">standard_b64decode</span><span class="p">(</span><span class="n">s12</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># if pt = 00 then enc1 = (s12&amp;s13) xor s14 xor s11</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># -&gt; s11 = enc1 xor s14 xor (s12&amp;s13)</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc1</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">16</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">s11</span> <span class="o">=</span> <span class="n">_xor</span><span class="p">(</span><span class="n">s14</span><span class="p">,</span> <span class="n">_xor</span><span class="p">(</span><span class="n">enc1</span><span class="p">,</span> <span class="n">_and</span><span class="p">(</span><span class="n">s12</span><span class="p">,</span> <span class="n">s13</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># s15 = _xor(s12, _xor(enc12, _and(s16, s17)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span> <span class="o">=</span> <span class="n">s10</span><span class="o">+</span><span class="n">s11</span><span class="o">+</span><span class="n">s12</span><span class="o">+</span><span class="n">s13</span><span class="o">+</span><span class="n">s14</span>
</span></span><span class="line"><span class="cl">    <span class="n">ph</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">standard_b64encode</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ph</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">localTest</span><span class="p">()</span>
</span></span></code></pre></div><div id="第五空间2020-有几个脚本可以偷" class="anchor"></div>
<h2 class="relative group">第五空间2020 有几个脚本可以偷 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%e7%ac%ac%e4%ba%94%e7%a9%ba%e9%97%b42020-%e6%9c%89%e5%87%a0%e4%b8%aa%e8%84%9a%e6%9c%ac%e5%8f%af%e4%bb%a5%e5%81%b7" aria-label="Anchor">#</a></span>        
    
</h2>
<div id="secrets" class="anchor"></div>
<h3 class="relative group">secrets 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#secrets" aria-label="Anchor">#</a></span>        
    
</h3>
<p>从算法中可知满足表达式   $c \equiv a_0 x_1^2 x_2  + a_1 x_0 x_2^2 + a_2 x_1 x_2^2 \mod p$</p>
<p>由同余方程构造一个格子</p>
<p>$$
[1,0,0,0,a0 * k]\ [0,1,0,0,a1 * k]\ [0,0,1,0,a2 * k]\ [0,0,0,1,c  * k]\ [0,0,0,0,p  * k]
$$</p>
<p>为满足LLL算法，k取$2^{32}$，最后即可求出系数secret</p>
<pre tabindex="0"><code>p = 11262096115235666933802384984690234504897820609940312496824079226002897675039978540501589954252280529685081417842844576044060586114527797910785935210841729
a0=4466180910473361859350789459675556137864618617420328788169821212611803391878541909630693681804259240992086737964898776136917699083088117808235133334853043
a1=4887981314308588962908319833576800643350454985421459983243096186706959103231201770635994519162313869702469523675537059237606426233167545218659189978781299
a2=6222963447321263242047563972710956077055676498584240298712594187843704642795447140199703936008141098341496844773625746023752040758807620531632616610912213
e=[[0, 2, 1], [1, 0, 2], [0, 1, 2]]
c = 2521258878430983025589687858541798401695147486882642972456698768540389939874205997047593688658001566287798373100962518354180078132561217455997908984321742
k=1&lt;&lt;32
A = Matrix(ZZ,[
    [1,0,0,0,a0*k],
    [0,1,0,0,a1*k],
    [0,0,1,0,a2 *k],
    [0,0,0,1,c *k],
    [0,0,0,0, p *k]
])
A.LLL()
res =[3463832903,3041163877,2616200387]
c = long_to_bytes(0x0497ca92dff6e21bf2882b100d29660e478a8322d06f2d759c07b7ac865d1090)
key = hashlib.sha256(str(res).encode()).digest()
aes = AES.new(key, AES.MODE_ECB)
print(b&#39;flag{&#39; +aes.decrypt(c) + b&#39;}&#39;) 
</code></pre><div id="data_protect" class="anchor"></div>
<h3 class="relative group">data_protect 
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#data_protect" aria-label="Anchor">#</a></span>        
    
</h3>
<p>encrypt1 直接分解n</p>
<p>encrypt2 无法完全分解n，但是知道其中一个大素数因子，直接转化为 mod p下的rsa</p>
<p>encrypt3 在Zmod(q) 下求解方程</p>
<p>encrypt4 random的随机数预测，前面encrypt1有192bit，encrypt2有192bit，encrypt3中有612*32bit，刚好满足条件，可以预测出key</p>
<p>encrypt5 继续随机数预测，可以预测出私钥x</p>
<pre tabindex="0"><code>import random
from gmpy2 import *
from Crypto.Util.number import *
from Crypto.Cipher import AES
from hashlib import sha256

p=64390888389278700958517837593
n=1428634580885297528425426676577388183501352157100030354079
c=1019989333027273450782579103415892125563412519871045896869
q=n//p
d=invert(65537,(p-1)*(q-1))
print(long_to_bytes(pow(c,d,n)))
c= 51342500906961408103258915228768275415740191204733837976903027942824981857691173079133834015102055031777401227355785897344053403243459544157687793960413113104670769220112095273635970933789525875595068985638845129357985043542698076902996316622632153857669586900278252852715534059153367015654872042990169865039
# n=134949786048887319137407994803780389722367094355650515833817995038306119197600539524985448574053755793699799863164150565217726975197643634831307454431403854861515253009970594684699064052739820092115115614153962139870020206132705821506686959283747802946805730902605814619499301779892151365118901010526138311982
# p = 11616788973244169211540879051135531683500013311175857700532973853592727185033846064980717918194540453710515251945345524986932165003196804187526561468278997
# q=n//p
# # print()
# print(q-p)
# d=invert(65537,(p-1)*(q-1))
# print(long_to_bytes(pow(c,d,n))[:-20])

# a,b=(11616788973244169211540879051135531683500013311175857700532973853592727185033846064980717918194540453710515251945345524986932165003196804187526561468278997,11616788973244169211540879051135531683500013311175857700532973853592727185033846064980717918194540453710515251945345524986932165003196804187526563615762644)
# print((b-a)==2**31-1)
# b&#39;XIAOming&#39;
# b&#39;17810111101&#39;
# b&#39;XIAOming@cmail.com&#39;



c=51342500906961408103258915228768275415740191204733837976903027942824981857691173079133834015102055031777401227355785897344053403243459544157687793960413113104670769220112095273635970933789525875595068985638845129357985043542698076902996316622632153857669586900278252852715534059153367015654872042990169865039
n=134949786048887319137407994803780389722367094355650515833817995038306119197600539524985448574053755793699799863164150565217726975197643634831307454431403854861515253009970594684699064052739820092115115614153962139870020206132705821506686959283747802946805730902605814619499301779892151365118901010526138311982
p = 11616788973244169211540879051135531683500013311175857700532973853592727185033846064980717918194540453710515251945345524986932165003196804187526561468278997

n=p
d=invert(65537,(p-1))
print(long_to_bytes(pow(c,d,n))[:-20])

q=5974434331
key=[[978955513, 2055248981, 3094004449, 411497641, 4183759491, 521276843, 1709604203, 3162773533, 2140722701, 782306144, 421964668, 356205891, 1039083484, 1911377875, 1661230549, 312742665, 3628868938, 2049082743], [3833871085, 2929837680, 2614720930, 4056572317, 3787185237, 93999422, 590001829, 429074138, 3012080235, 2336571108, 831707987, 3902814802, 2084593018, 316245361, 1799842819, 2908004545, 120773816, 2687194173], [3213409254, 3303290739, 742998950, 2956806179, 2834298174, 429260769, 769267967, 1301491642, 2415087532, 1055496090, 690922955, 2984201071, 3517649313, 3675968202, 3389582912, 2632941479, 186911789, 3547287806], [4149643988, 3811477370, 1269911228, 3709435333, 1868378108, 4173520248, 1573661708, 2161236830, 3266570322, 1611227993, 2539778863, 1857682940, 1020154001, 92386553, 3834719618, 3775070036, 3777877862, 2982256702], [4281981169, 2949541448, 4199819805, 3654041457, 3300163657, 1674155910, 1316779635, 66744534, 3804297626, 2709354730, 2460136415, 3983640368, 3801883586, 1068904857, 4178063279, 41067134, 752202632, 3143016757], [3078167402, 2059042200, 252404132, 415008428, 3611056424, 1674088343, 2460161645, 3311986519, 3130694755, 934254488, 898722917, 2865274835, 567507230, 1328871893, 3903457801, 2499893858, 492084315, 183531922], [3529830884, 4039243386, 233553719, 4118146471, 1646804655, 2089146092, 2156344320, 2329927228, 508323741, 1931822010, 579182891, 176447133, 597011120, 3261594914, 2845298788, 3759915972, 3095206232, 3638216860], [3352986415, 4264046847, 3829043620, 2530153481, 3421260080, 1669551722, 4240873925, 2101009682, 3660432232, 4224377588, 929767737, 3729104589, 2835310428, 1727139644, 1279995206, 1355353373, 2144225408, 1359399895], [3105965085, 818804468, 3230054412, 2646235709, 4053839846, 2878092923, 587905848, 1589383219, 2408577579, 880800518, 28758157, 1000513178, 2176168589, 187505579, 89151277, 1238795748, 8168714, 3501032027], [3473729699, 1900372653, 305029321, 2013273628, 1242655400, 4192234107, 2446737641, 1341412052, 304733944, 4174393908, 2563609353, 3623415321, 49954007, 3130983058, 425856087, 2331025419, 34423818, 2042901845], [1397571080, 1615456639, 1840339411, 220496996, 2042007444, 3681679342, 2306603996, 732207066, 663494719, 4092173669, 3034772067, 3807942919, 111475712, 2065672849, 3552535306, 138510326, 3757322399, 2394352747], [371953847, 3369229608, 1669129625, 168320777, 2375427503, 3449778616, 1977984006, 1543379950, 2293317896, 1239812206, 1198364787, 2465753450, 3739161320, 2502603029, 1528706460, 1488040470, 3387786864, 1864873515], [1356892529, 1662755536, 1623461302, 1925037502, 1878096790, 3682248450, 2359635297, 1558718627, 116402105, 3274502275, 2436185635, 771708011, 3484140889, 3264299013, 885210310, 4225779256, 363129056, 2488388413], [2636035482, 4140705532, 3187647213, 4009585502, 351132201, 2592096589, 3785703396, 750115519, 3632692007, 3936675924, 3635400895, 3257019719, 1928767495, 2868979203, 622850989, 3165580000, 4162276629, 4157491019], [1272163411, 1251211247, 357523138, 1233981097, 1855287284, 4079018167, 4028466297, 92214478, 4290550648, 648034817, 1247795256, 3928945157, 1199659871, 397659647, 3360313830, 561558927, 3446409788, 2727008359], [1470343419, 3861411785, 953425729, 65811127, 458070615, 1428470215, 3101427357, 1137845714, 1980562597, 4120983895, 45901583, 2869582150, 427949409, 3025588000, 3231450975, 3313818165, 4015642368, 3197557747], [2452385340, 111636796, 897282198, 4273652805, 1223518692, 3680320805, 2771040109, 3617506402, 3904690320, 77507239, 3010900929, 4099608062, 546322994, 1084929138, 902220733, 4054312795, 1977510945, 735973665], [3729015155, 3027108070, 1442633554, 1949455360, 2864504565, 3673543865, 446663703, 3515816196, 1468441462, 897770414, 2831043012, 707874506, 1098228471, 1225077381, 3622448809, 2409995597, 3847055008, 1887507220], [1839061542, 1963345926, 2600100988, 1703502633, 1824193082, 3595102755, 2558488861, 2440526309, 3909166109, 1611135411, 2809397519, 1019893656, 3281060225, 2387778214, 2460059811, 198824620, 1645102665, 865289621], [224442296, 3009601747, 3066701924, 1774879140, 880620935, 2676353545, 3748945463, 1994930827, 75275710, 3710375437, 4132497729, 3010711783, 3731895534, 2434590580, 3409701141, 2209951200, 995511645, 3571299495], [2337737600, 110982073, 2985129643, 1668549189, 3298468029, 698015588, 2945584297, 1036821195, 4249059927, 3384611421, 3304378629, 1307957989, 602821252, 184198726, 1182960059, 4200496073, 1562699893, 3320841302], [5866561, 2442649482, 479821282, 2687097642, 3347828225, 1876332308, 2704295851, 2952277070, 1803967244, 2837783916, 658984547, 3605604364, 1931924322, 3285319978, 556150900, 3795666798, 261321502, 1040433381], [3855222954, 3565522064, 1841853882, 1066304362, 3552076734, 3075952725, 2193242436, 2052898568, 2341179777, 3089412493, 165812889, 4196290126, 3568567671, 28097161, 2249543862, 1251207418, 522526590, 765541973], [1801734077, 2132230169, 667823776, 3900096345, 3119630138, 3620542178, 2900630754, 30811433, 608818254, 1040662178, 900811411, 3221833258, 43598995, 1818995893, 2718507668, 3445138445, 3217962572, 1437902734], [1812768224, 392114567, 2694519859, 1941199322, 2523549731, 2078453798, 851734499, 2376090593, 2069375610, 4084690114, 246441363, 4154699271, 58451971, 31806021, 4158724930, 2741293247, 3230803936, 2790505999], [3906342775, 2231570871, 1258998901, 1517292578, 162889239, 3130741176, 3925266771, 1780222960, 2378568279, 3873144834, 1597459529, 1581197809, 4101706041, 196019642, 1439141586, 587446072, 2012673288, 1280875335], [4058452685, 653145648, 553051697, 1406542226, 4053722203, 994470045, 2066358582, 3919235908, 2315900402, 3236350874, 172880690, 3104147616, 489606166, 3898059157, 200469827, 665789663, 3116633449, 4137295625], [1460624254, 4286673320, 2664109800, 1995979611, 4091742681, 2639530247, 4240681440, 2169059390, 1149325301, 3139578541, 2320870639, 3148999826, 4095173534, 2742698014, 3623896968, 2444601912, 1958855100, 1743268893], [2187625371, 3533912845, 29086928, 543325588, 4247300963, 1972139209, 272152499, 4276082595, 3680551759, 1835350157, 3921757922, 2716774439, 1070751202, 69990939, 3794506838, 699803423, 3699976889, 40791189], [539106994, 1670272368, 3483599225, 2867955550, 2207694005, 1126950203, 693920921, 2333328675, 539234245, 1961438796, 3126390464, 1118759587, 59715473, 1450076492, 4101732655, 3658733365, 940858890, 1262671744], [3092624332, 2175813516, 3355101899, 3657267135, 770650398, 359506155, 4149470178, 3763654751, 1184381886, 942048015, 523057971, 1098635956, 1732951811, 150067724, 2417766207, 4152571821, 2759971924, 4284842765], [3336022203, 2569311431, 2752777107, 1441977867, 1279003682, 3861567631, 1064716472, 3046493996, 1339401643, 39466446, 1464905290, 420733872, 2057911345, 2418624800, 2193625430, 1558527155, 4224908000, 207684355], [2681129718, 4210889596, 4051161171, 3131196482, 1128312875, 938670840, 2828563599, 3078146488, 1102989364, 3557724304, 156013303, 2371355565, 3608679353, 3513837899, 155622460, 396656112, 2493417457, 876296360], [3135876409, 181875076, 3662181650, 3851859805, 3626146919, 90441351, 1944988720, 585429580, 3158268550, 1399100291, 3688843295, 2851190, 2670576474, 3177735154, 3479499727, 197376977, 1790622954, 2393956089]]
cipher=[595403492, 3329072201, 2030986893, 4171901788, 3978623752, 1983221945, 2446721844, 2357069183, 4157116254, 1084149362, 5164304343, 2285835942, 2562444158, 1580792970, 123176562, 878938066, 1581756453, 5868219323, 2039976783, 734750925, 1594241262, 4167440639, 3051132298, 657904326, 2869165250, 1240654684, 2667941558, 4488763635, 3975062760, 4362407867, 2329286887, 1929259095, 4743673673, 3503908479]
#有限域下求线性方程 key*x=cipher 得到 x=[88,73,65,79,109,105,110,103,64,99,109,97,105,108,46,99,111,109]
x=[88,73,65,79,109,105,110,103,64,99,109,97,105,108,46,99,111,109]
for i in x:
    print(chr(i),end=&#39;&#39;)
print()


from randcrack import RandCrack
rc = RandCrack()
t=[]
for i in key:
    for j in i:
        t.append(j)

p= 64390888389278700958517837593
p_=64390888389278700958517837503
q= 22186905890293167337018474103
q_=22186905890293167337018474045

pd=bytes_to_long(b&#39;\xf1\x0f\xb5\xb5\xae\xf0\x05\x92BWR\xd0&gt;\x91\x0cv\xbc ]\x81&#39;)
d=1644175009

# for qq in range(p_+1,p+1):
#     for pp in range(q_+1,q+1):
#         rc = RandCrack()
#         pp,qq=22186905890293167337018474101 ,64390888389278700958517837515
#         rc.submit(pp&amp;0xffffffff)
#         rc.submit((pp&gt;&gt;32)&amp;0xffffffff)
#         rc.submit((pp&gt;&gt;64)&amp;0xffffffff)
#         rc.submit(qq&amp;0xffffffff)
#         rc.submit((qq&gt;&gt;32)&amp;0xffffffff)
#         rc.submit((qq&gt;&gt;64)&amp;0xffffffff)
#         rc.submit(pd&amp;0xffffffff)
#         rc.submit((pd&gt;&gt;32)&amp;0xffffffff)
#         rc.submit((pd&gt;&gt;64)&amp;0xffffffff)
#         rc.submit((pd&gt;&gt;96)&amp;0xffffffff)
#         rc.submit((pd&gt;&gt;128)&amp;0xffffffff)
#         rc.submit(d)
#         for i in range(612):
#             rc.submit(t[i])
#         r=0
#         for i in range(4):
#             tt=rc.predict_randrange(0, 4294967295)
#             r+=tt&lt;&lt;(32*i)
#         key = long_to_bytes(r)
#         a = AES.new(key,AES.MODE_ECB)
#         cipher = a.decrypt(long_to_bytes(206157860554052840058147052190501816262))
#         if(b&#34;.&#34; in cipher and b&#34;_&#34; in cipher):
#             print(pp,qq,cipher)

rc = RandCrack()
pp,qq=22186905890293167337018474101 ,64390888389278700958517837515
rc.submit(pp&amp;0xffffffff)
rc.submit((pp&gt;&gt;32)&amp;0xffffffff)
rc.submit((pp&gt;&gt;64)&amp;0xffffffff)
rc.submit(qq&amp;0xffffffff)
rc.submit((qq&gt;&gt;32)&amp;0xffffffff)
rc.submit((qq&gt;&gt;64)&amp;0xffffffff)
rc.submit(pd&amp;0xffffffff)
rc.submit((pd&gt;&gt;32)&amp;0xffffffff)
rc.submit((pd&gt;&gt;64)&amp;0xffffffff)
rc.submit((pd&gt;&gt;96)&amp;0xffffffff)
rc.submit((pd&gt;&gt;128)&amp;0xffffffff)
rc.submit(d)
for i in range(612):
    rc.submit(t[i])
r=0
for i in range(4):
    tt=rc.predict_randrange(0, 4294967295)
    r+=tt&lt;&lt;(32*i)
r=0
for i in range(16):
    tt=rc.predict_randrange(0, 4294967295)
    r+=tt&lt;&lt;(32*i)
r=0
for i in range(16):
    tt=rc.predict_randrange(0, 4294967295)
    r+=tt&lt;&lt;(32*i)
q,g,h=12978641035734240236103271206089768414668942591886536148174561520305999709207251794343245618040094770557383475160630029074093741713376984903835480969208293, 8720814254745089777252083344348851268520692318828030452122549926748859741402125799736178655620806485161358327515735405190921467358304697344848268434382637 ,12099509832855805422212389412411496487421102553928260849593639134939000597394291986995380611893676422073382092596749292780050077552342507027413423034163272
c1,c2=11037273227249384815270477914945574769214510988660737721762529999297862289189700923584519665480479763578699379894125409227652084419849423696932374103120058, 12087705792059361632307776684083188202195541184973623631541534293387150491895486080323457832843438088187773977539401538646693773152621936983533667985808470
print(long_to_bytes(invert(pow(c1,r,q),q)*c2%q))
</code></pre>
        </div>
                
        

        

          
      </div>
     
     <script>
        var oid = "views_achieve\\垃圾题归档.md"
        var oid_likes = "likes_achieve\\垃圾题归档.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js" integrity="sha512-DkmXO0rQo4LHxgEti/&#43;CJjFmQtqrxPiiBHe9CGdPPabi&#43;pk7wgrU9R58W7aOb5E6IHp8T&#43;N&#43;oOe4BolK/OCmTg=="></script>
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/achieve/2019to2021/openssl/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >openssl/pem</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-07-27 15:33:01 &#43;0800 CST">27 July 2021</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/achieve/ctf/dfjk2021/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Writeup for MedicalImage in 癫疯geekCtf 2021</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-07-31 00:07:00 &#43;0800 CST">31 July 2021</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2023
      ベーコン
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.35c1113bcc16c5a59bf031082f9e63822aa95280423881a7847a7ff33a16e6299ce6a840d9ef4e10d947e030a18f3f20359afb2ec0f35967484b9a9360ac3145.js" integrity="sha512-NcERO8wWxaWb8DEIL55jgiqpUoBCOIGnhHp/8zoW5imc5qhA2e9OENlH4DChjz8gNZr7LsDzWWdIS5qTYKwxRQ=="></script>
  
  
</footer><div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://ljahum258.github.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
